<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Problemas de Ajedrez</title>
    
    <!-- CSS de Chessboard.js (Corregido 'xintegrity' a 'integrity') -->
    <link rel="stylesheet"
          href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
          xintegrity="sha384-q94tEGFzGMnEmBVSgTRkVgPjwitM/ltLMgSviRrkCklbciTrHEISjeJydPxL/mHk"
          crossorigin="anonymous">
    
    <!-- Biblioteca de Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Estilos CSS (Modo Oscuro y Rediseño) -->
    <style>
        :root {
            --bg-primary: #1e1e2e;
            --bg-secondary: #27293d;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --border-color: #444455;
            --primary-accent: #885fff;
            --secondary-accent: #00e6a1;
            --warning-accent: #ffc107; /* Amarillo para Pista */
            --danger-accent: #ff5572;
            --correct-accent: #2ecc71; /* Verde para correcto */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
        }

        h1, h3, h4 {
            color: var(--text-primary);
            font-weight: 700;
            text-align: center;
        }
        
        .view-container {
            width: 100%;
            max-width: 620px;
            padding: 25px;
            background-color: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex; /* Modificado: Mostrar por defecto */
            flex-direction: column;
            align-items: center;
        }

        /* --- Estilos del Juego --- */
        #gameView { width: 100%; }
        .board-container {
            width: 100%;
            max-width: 600px;
            margin: 10px auto;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        #myBoard { width: 100%; border-radius: 6px; }
        
        .status-container {
            margin-top: 15px;
            text-align: center;
        }
        #status {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            min-height: 1.5rem;
            margin-bottom: 10px;
        }
        #puzzleStatus {
            font-size: 1.1rem;
            font-weight: 600;
            min-height: 1.4rem;
            margin-top: 10px;
        }
        #puzzleStatus.correct { color: var(--correct-accent); }
        #puzzleStatus.incorrect { color: var(--danger-accent); }
        
        button {
            color: white;
            border: none;
            padding: 14px 22px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            background-color: var(--primary-accent);
            margin-top: 10px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        #backButton, .back-button {
            background-color: var(--danger-accent);
        }
        
        /* --- NUEVO: Botón de Pista --- */
        #hintButton {
            background-color: var(--warning-accent);
            color: var(--bg-primary);
            font-size: 1rem;
            padding: 10px 18px;
            margin: 10px 0;
        }
        
        /* --- NUEVO: Resaltado de Pista --- */
        .highlight-hint {
            /* Usar un brillo amarillo para la pista */
            box-shadow: inset 0 0 15px 5px rgba(255, 193, 7, 0.7) !important;
        }
        
    </style>
</head>
<body>
    
    <!-- Vista del Juego (para Problemas) -->
    <div id="gameView" class="view-container">
        <h1 id="gameTitle">Problema</h1>
        <div class="board-container">
            <div id="myBoard"></div>
        </div>
        <div class="status-container">
            <h3>Estado: <span id="status">Cargando...</span></h3>
            <div id="puzzleStatus"></div>
            <!-- NUEVO: Botón de Pista añadido -->
            <button id="hintButton" style="display: none;">Pedir Pista</button>
        </div>
        <button id="backButton">Volver al Menú</button>
    </div>

    <!-- SDKs de Firebase (v11.6.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variables Globales ---
        var board = null;
        var game = new Chess();
        var $status = $('#status');
        var makingMove = false;
        var playerColor = 'w';

        var auth;
        
        var stockfish = null;
        var stockfishReady = false;
        
        var firebaseConfig = {
            apiKey: "AIzaSyDWGEMpfCF7OvBiM68uthumbOeDHwWai6M",
            authDomain: "chess-a9347.firebaseapp.com",
            projectId: "chess-a9347",
            storageBucket: "chess-a9347.firebasestorage.app",
            messagingSenderId: "950558367537",
            appId: "1:950558367537:web:4cee83e2053262a4541a10",
            measurementId: "G-Z3KNSZBL2F"
        };
        
        let puzzles = []; 
        var currentPuzzle = null;
        var currentPuzzleStep = 0;

        var config = {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd,
            pieceTheme: getPieceTheme
        };

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                getFirestore(app); // Inicializar Firestore
                setLogLevel('Debug'); 

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Usuario autenticado, cargando puzzles.");
                        initStockfish(startRandomPuzzle);
                    } else {
                        console.log("Sin usuario, redirigiendo a login.");
                        window.location.href = 'index.html';
                    }
                });
            } catch (e) {
                console.error("Error al inicializar Firebase:", e);
                alert('Error al cargar Firebase. Volviendo al inicio.');
                window.location.href = 'index.html';
            }
        }
        
        /**
         * Inicializa el motor de Stockfish para calcular soluciones
         */
        async function initStockfish(readyCallback) {
            if (stockfish) {
                stockfish.postMessage('ucinewgame');
                if (readyCallback) readyCallback();
                return;
            }
            try {
                console.log('Cargando motor de IA...');
                
                const response = await fetch("https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js");
                if (!response.ok) throw new Error(`Error al descargar stockfish.js: ${response.statusText}`);
                const scriptText = await response.text();
                const blob = new Blob([scriptText], { type: 'application/javascript' });
                const blobUrl = URL.createObjectURL(blob);
                
                stockfish = new Worker(blobUrl);
                
                stockfish.onmessage = function(event) {
                    var message = event.data;
                    console.log("Stockfish (Puzzles):", message);

                    if (message === 'uciok') {
                        stockfish.postMessage('isready');
                    } else if (message === 'readyok') {
                        console.log('Motor listo para puzzles.');
                        stockfishReady = true;
                        if (readyCallback) readyCallback();
                    }
                };
                stockfish.postMessage('uci');
            } catch (e) {
                console.error("No se pudo inicializar Stockfish:", e);
                alert("Error al cargar la IA para resolver problemas.");
            }
        }

        /**
         * Pide a Stockfish el mejor movimiento para un FEN
         */
        function getBestMove(fen, callback) {
            if (!stockfishReady) {
                console.error("Stockfish no está listo.");
                $status.text("Error: La IA no está lista.");
                return;
            }
            
            const moveCallback = (event) => {
                 var message = event.data;
                 if (message.startsWith('bestmove')) {
                    var bestmove = message.split(' ')[1];
                    stockfish.removeEventListener('message', moveCallback);
                    callback(bestmove);
                 }
            };
            
            stockfish.addEventListener('message', moveCallback);
            stockfish.postMessage('ucinewgame');
            stockfish.postMessage('position fen ' + fen);
            stockfish.postMessage('go depth 15');
        }
        
        // --- NUEVA FUNCIÓN: Mostrar Pista ---
        function showHint() {
            if (!currentPuzzle || currentPuzzle.solution.length === 0) {
                $('#puzzleStatus').text('La pista no está lista (IA calculando).').addClass('incorrect');
                return;
            }
            
            const fromSquare = currentPuzzle.solution[0].substring(0, 2);
            // Encontrar la casilla usando la clase específica de chessboard.js
            const $squareEl = $('#myBoard .square-' + fromSquare);
            
            $squareEl.addClass('highlight-hint');
            
            // Quitar la pista después de un tiempo
            setTimeout(() => {
                $squareEl.removeClass('highlight-hint');
            }, 1000); // 1 segundo de pista
        }
        
        function updateStatus() {
            var status = '';
            var moveColor = (game.turn() === 'w') ? 'Blancas' : 'Negras';

            if (game.in_checkmate()) {
                status = '¡Jaque Mate! Problema resuelto.';
            } else if (game.in_draw() || game.in_stalemate() || game.in_threefold_repetition() || game.insufficient_material()) {
                status = 'Tablas';
            } else {
                if (currentPuzzle) {
                    status = `Problema #${currentPuzzle.index + 1}. Mueven ${moveColor}`;
                    if (game.in_check()) {
                        status += ' (¡Jaque!)';
                    }
                } else {
                    status = 'Cargando problema...';
                }
            }
            $status.text(status);
        }

        function onDragStart(source, piece, position, orientation) {
            if (game.game_over()) return false;
            if (makingMove) return false;
            return piece.search(playerColor) !== -1;
        }

        async function onDrop(source, target) {
            if (!currentPuzzle || currentPuzzle.solution.length === 0) {
                $puzzleStatus.text('Espera a que la IA calcule la solución...').addClass('incorrect');
                return 'snapback';
            }
            
            var moveNotation = source + target;
            const $puzzleStatus = $('#puzzleStatus');
            const solutionMove = currentPuzzle.solution[currentPuzzleStep];
            
            if (moveNotation === solutionMove) {
                game.move({ from: source, to: target, promotion: 'q' });
                board.position(game.fen());
                currentPuzzleStep++;
                
                if (currentPuzzleStep === currentPuzzle.solution.length) {
                    $puzzleStatus.text('¡Correcto! Cargando siguiente problema...').removeClass('incorrect').addClass('correct');
                    makingMove = true;
                    $('#hintButton').hide(); // Ocultar pista al resolver
                    setTimeout(startRandomPuzzle, 1500); 
                } 
                
            } else {
                $puzzleStatus.text('Movimiento incorrecto. Inténtalo de nuevo.').removeClass('correct').addClass('incorrect');
                return 'snapback';
            }
            updateStatus();
        }

        function onSnapEnd() {
            board.position(game.fen());
        }

        function getPieceTheme(piece) {
            var pieceName = piece.toLowerCase(); 
            return 'https://logise1.github.io/chess/assets/' + pieceName + '.png';
        }
        
        function showView(viewId) {
            $('.view-container').hide();
            $('#' + viewId).css('display', 'flex');
        }
        
        function initGame(options = {}) {
            
            if (board === null) {
                board = Chessboard('myBoard', config);
                $(window).resize(board.resize);
            }
            
            game.reset();
            makingMove = false;
            $('#puzzleStatus').text('').removeClass('correct incorrect');
            $('#hintButton').show(); // Mostrar botón de pista

            if (options.puzzleIndex >= puzzles.length) {
                console.error("Índice de problema fuera de rango");
                alert('Error: No se pueden cargar problemas.');
                window.location.href = 'index.html';
                return;
            }
            
            currentPuzzle = puzzles[options.puzzleIndex];
            currentPuzzleStep = 0;
            playerColor = currentPuzzle.turn;

            game.load(currentPuzzle.fen);
            board.position(currentPuzzle.fen);
            board.orientation(playerColor === 'w' ? 'white' : 'black');
            
            $('#gameTitle').text(`Problema #${currentPuzzle.index + 1}`);
            
            if (!stockfishReady) {
                $status.text("La IA aún está cargando. Por favor, espera...");
                setTimeout(() => initGame(options), 1000);
                return;
            }
            
            makingMove = true;
            $status.text(`Calculando solución para ${currentPuzzle.name}...`);
            $('#hintButton').prop('disabled', true); // Desactivar pista mientras se calcula

            getBestMove(currentPuzzle.fen, (bestmove) => {
                console.log(`Solución calculada para ${currentPuzzle.name}: ${bestmove}`);
                currentPuzzle.solution = [bestmove];
                makingMove = false;
                $('#hintButton').prop('disabled', false); // Activar pista
                updateStatus();
            });
        }
        
        /**
         * Carga los problemas desde la URL externa
         */
        async function fetchPuzzles() {
            if (puzzles.length > 0) return; 

            try {
                const response = await fetch('https://logise1.github.io/chess/puzzles.fen');
                if (!response.ok) {
                    throw new Error('No se pudo cargar la lista de problemas (puzzles.fen).');
                }
                const data = await response.text();
                
                puzzles = data.split('\n')
                              .filter(fen => fen.trim() !== '')
                              .map((fen, index) => {
                                  const turn = fen.split(' ')[1] || 'w';
                                  return { 
                                      name: `Problema #${index + 1}`,
                                      index: index,
                                      fen: fen, 
                                      turn: turn, 
                                      solution: []
                                  };
                              });
                
                console.log('Problemas cargados:', puzzles.length);
            } catch (error) {
                console.error('Error al cargar problemas:', error);
                puzzles = [];
            }
        }
        
        /**
         * Inicia el bucle de puzzles aleatorios
         */
        async function startRandomPuzzle() {
            if (!stockfishReady) {
                $status.text("Iniciando IA...");
                initStockfish(startRandomPuzzle);
                return;
            }

            if (puzzles.length === 0) {
                $status.text("Cargando problemas...");
                await fetchPuzzles();
            }

            if (puzzles.length === 0) {
                $status.text("Error al cargar problemas.");
                alert("No se pudieron cargar los problemas. Volviendo al menú.");
                window.location.href = 'index.html';
                return;
            }
            
            // Mostrar la vista del juego (ya debería estar visible)
            showView('gameView');

            const randomIndex = Math.floor(Math.random() * puzzles.length);
            
            initGame({ puzzleIndex: randomIndex });
        }
        
        $(document).ready(function() {
            
            initFirebase();
            
            // Botones "Volver"
            $('#backButton').on('click', () => {
                window.location.href = 'index.html';
            });
            
            // --- NUEVO: Listener para el botón de pista ---
            $('#hintButton').on('click', showHint);
        });

    </script>
    
    <!-- Bibliotecas JS (jQuery, Chessboard, Chess.js) -->
    <!-- jQuery (Corregido 'xintegrity' a 'integrity') -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            xintegrity="sha384-ZvpUoO/+PpLzWDNGbKOSMmkOWMwSKEASBbSlogoMObxKkyVj51DaoKqrqaSNOuK6"
            crossorigin="anonymous"></script>
    
    <!-- Chessboard.js (Corregido 'xintegrity' a 'integrity') -->
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
            xintegrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUgJitwyksISJqCCGmyNFN2bZqXQcUlSKSfG8"
            crossorigin="anonymous"></script>

    <!-- Chess.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.min.js"></script>

</body>
</html>