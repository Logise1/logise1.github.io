<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Problemas de Ajedrez</title>
    
    <!-- CSS de Chessboard.js (Corregido 'xintegrity' a 'integrity') -->
    <link rel="stylesheet"
          href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
          xintegrity="sha384-q94tEGFzGMnEmBVSgTRkVgPjwitM/ltLMgSviRrkCklbciTrHEISjeJydPxL/mHk"
          crossorigin="anonymous">
    
    <!-- Biblioteca de Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Estilos CSS (Compartidos) -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
            padding: 10px;
            box-sizing: border-box;
        }
        h1 { color: #2c3e50; font-weight: 700; text-align: center; }
        h3, h4 { color: #34495e; margin-bottom: 5px; }
        
        .view-container {
            width: 100%;
            max-width: 620px;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            display: none; /* Oculto por defecto */
            flex-direction: column;
            align-items: center;
        }

        #puzzlesView { text-align: center; }
        
        /* Listas (Problemas) */
        .list-container {
            width: 90%;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-top: 15px;
            padding: 10px;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f4f4f4;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background-color: #f9f9f9; }
        .list-item span { font-weight: 600; color: #555; }
        
        /* --- Estilos del Juego --- */
        #gameView { width: 100%; }
        .board-container {
            width: 100%; max-width: 600px; margin: 10px auto;
            border: 2px solid #333; border-radius: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        #myBoard { width: 100%; border-radius: 6px; }
        .status-container { margin-top: 15px; text-align: center; }
        #status { font-size: 1.2rem; font-weight: 600; color: #16a085; min-height: 1.5rem; }
        #puzzleStatus {
            font-size: 1.1rem; font-weight: 600;
            min-height: 1.4rem; margin-top: 10px;
        }
        #puzzleStatus.correct { color: #2ecc71; }
        #puzzleStatus.incorrect { color: #e74c3c; }
        
        button {
            background-color: #3498db; color: white; border: none; padding: 12px 20px; font-size: 1rem;
            font-weight: 600; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease, box-shadow 0.3s ease;
            margin-top: 10px; box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        button:hover { background-color: #2980b9; }
        #backButton, .back-button { background-color: #e74c3c; margin-top: 20px; }
        #backButton:hover, .back-button:hover { background-color: #c0392b; }
    </style>
</head>
<body>
    
    <!-- Vista de Problemas -->
    <div id="puzzlesView" class="view-container">
        <h1>Problemas de Ajedrez</h1>
        <h4>Selecciona un problema</h4>
        <div id="puzzleListContainer" class="list-container">
            <!-- Los problemas se cargarán aquí -->
        </div>
        <button id="backButtonPuzzles" class="back-button">Volver</button>
    </div>

    <!-- Vista del Juego (para Problemas) -->
    <div id="gameView" class="view-container">
        <h1 id="gameTitle">Problema</h1>
        <div class="board-container">
            <div id="myBoard"></div>
        </div>
        <div class="status-container">
            <h3>Estado: <span id="status">Cargando...</span></h3>
            <div id="puzzleStatus"></div>
            <div id="puzzleButtons" style="display: none;">
                <button id="nextPuzzleButton" style="background-color: #2ecc71;">Siguiente Problema</button>
            </div>
        </div>
        <button id="backButton">Volver a la Lista</button>
    </div>

    <!-- SDKs de Firebase (v11.6.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variables Globales ---
        var board = null;
        var game = new Chess();
        var $status = $('#status');
        var makingMove = false;
        var playerColor = 'w';

        var auth;
        
        var firebaseConfig = {
            apiKey: "AIzaSyDWGEMpfCF7OvBiM68uthumbOeDHwWai6M",
            authDomain: "chess-a9347.firebaseapp.com",
            projectId: "chess-a9347",
            storageBucket: "chess-a9347.firebasestorage.app",
            messagingSenderId: "950558367537",
            appId: "1:950558367537:web:4cee83e2053262a4541a10",
            measurementId: "G-Z3KNSZBL2F"
        };
        
        let puzzles = []; 
        var currentPuzzle = null;
        var currentPuzzleStep = 0;

        var config = {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd,
            pieceTheme: getPieceTheme
        };

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                getFirestore(app); // Inicializar Firestore, aunque no se use mucho aquí
                setLogLevel('Debug'); 

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Usuario autenticado, cargando puzzles.");
                        loadPuzzlesListAndShow();
                    } else {
                        console.log("Sin usuario, redirigiendo a login.");
                        window.location.href = 'index.html';
                    }
                });
            } catch (e) {
                console.error("Error al inicializar Firebase:", e);
                alert('Error al cargar Firebase. Volviendo al inicio.');
                window.location.href = 'index.html';
            }
        }

        function updateStatus() {
            var status = '';
            var moveColor = (game.turn() === 'w') ? 'Blancas' : 'Negras';

            if (game.in_checkmate()) {
                status = '¡Jaque Mate! Problema resuelto.';
            } else if (game.in_draw() || game.in_stalemate() || game.in_threefold_repetition() || game.insufficient_material()) {
                status = 'Tablas';
            } else {
                status = `Problema: ${currentPuzzle.name}. Mueven ${moveColor}`;
                if (game.in_check()) {
                    status += ' (¡Jaque!)';
                }
            }
            $status.text(status);
        }

        function onDragStart(source, piece, position, orientation) {
            if (game.game_over()) return false;
            if (makingMove) return false;
            return piece.search(playerColor) !== -1;
        }

        async function onDrop(source, target) {
            if (!currentPuzzle) return 'snapback';
            
            var moveNotation = source + target;
            const $puzzleStatus = $('#puzzleStatus');
            const solutionMove = currentPuzzle.solution[currentPuzzleStep];
            
            if (moveNotation === solutionMove) {
                game.move({ from: source, to: target, promotion: 'q' });
                board.position(game.fen());
                currentPuzzleStep++;
                
                if (currentPuzzleStep === currentPuzzle.solution.length) {
                    $puzzleStatus.text('¡Correcto! Problema resuelto.').removeClass('incorrect').addClass('correct');
                    makingMove = true;
                    $('#nextPuzzleButton').show();
                } else {
                    $puzzleStatus.text('¡Correcto!').removeClass('incorrect').addClass('correct');
                    makingMove = true;
                    
                    setTimeout(() => {
                        const opponentMove = currentPuzzle.solution[currentPuzzleStep];
                        game.move(opponentMove, { sloppy: true });
                        board.position(game.fen());
                        currentPuzzleStep++;
                        makingMove = false;
                        updateStatus();
                    }, 500);
                }
            } else {
                $puzzleStatus.text('Movimiento incorrecto. Inténtalo de nuevo.').removeClass('correct').addClass('incorrect');
                return 'snapback';
            }
            updateStatus();
        }

        function onSnapEnd() {
            board.position(game.fen());
        }

        function getPieceTheme(piece) {
            var pieceName = piece.toLowerCase(); 
            return 'https://logise1.github.io/chess/assets/' + pieceName + '.png';
        }
        
        function showView(viewId) {
            $('.view-container').hide();
            $('#' + viewId).css('display', 'flex');
        }
        
        function initGame(options = {}) {
            showView('gameView');
            
            if (board === null) {
                board = Chessboard('myBoard', config);
                $(window).resize(board.resize);
            }
            
            game.reset();
            makingMove = false;
            $('#puzzleStatus').text('').removeClass('correct incorrect');

            if (options.puzzleIndex >= puzzles.length) {
                console.error("Índice de problema fuera de rango");
                showView('puzzlesView');
                return;
            }
            
            currentPuzzle = puzzles[options.puzzleIndex];
            currentPuzzleStep = 0;
            playerColor = currentPuzzle.turn;

            game.load(currentPuzzle.fen);
            board.position(currentPuzzle.fen);
            board.orientation(playerColor === 'w' ? 'white' : 'black');
            
            $('#gameTitle').text('Problema de Ajedrez');
            $('#puzzleButtons').show();
            $('#nextPuzzleButton').hide();
            
            updateStatus();
        }
        
        async function fetchPuzzles() {
            if (puzzles.length > 0) return; 

            try {
                const response = await fetch('https://logise1.github.io/chess/problems.array');
                if (!response.ok) {
                    throw new Error('No se pudo cargar la lista de problemas.');
                }
                const data = await response.json();
                puzzles = data;
                console.log('Problemas cargados:', puzzles.length);
            } catch (error) {
                console.error('Error al cargar problemas:', error);
                puzzles = [];
            }
        }
        
        function loadPuzzlesList() {
            const $list = $('#puzzleListContainer');
            $list.empty();
            
            if (puzzles.length === 0) {
                 $list.html('<p style="color: #999;">No hay problemas disponibles o error al cargar.</p>');
                 return;
            }
            
            puzzles.forEach((puzzle, index) => {
                $list.append(`
                    <div class="list-item" data-puzzle-index="${index}">
                        <span>${puzzle.name}</span>
                        <small>${puzzle.fen.split(' ')[1] === 'w' ? 'Juegan Blancas' : 'Juegan Negras'}</small>
                    </div>
                `);
            });
            
            // Añadir listener
            $('.list-item[data-puzzle-index]').off('click').on('click', function() {
                const index = $(this).data('puzzle-index');
                initGame({ puzzleIndex: index });
            });
        }
        
        async function loadPuzzlesListAndShow() {
            const $list = $('#puzzleListContainer');
            $list.html('<p style="color: #999;">Cargando problemas...</p>');
            showView('puzzlesView');
            await fetchPuzzles();
            loadPuzzlesList();
        }

        $(document).ready(function() {
            
            initFirebase();
            
            // Botones "Volver"
            $('#backButtonPuzzles').on('click', () => window.location.href = 'index.html');
            
            $('#backButton').on('click', () => {
                loadPuzzlesListAndShow();
            });
            
            $('#nextPuzzleButton').on('click', () => {
                let nextIndex = puzzles.indexOf(currentPuzzle) + 1;
                if (nextIndex >= puzzles.length) {
                    showView('puzzlesView');
                } else {
                    initGame({ puzzleIndex: nextIndex });
                }
            });
        });

    </script>
    
    <!-- Bibliotecas JS (jQuery, Chessboard, Chess.js) -->
    <!-- jQuery (Corregido 'xintegrity' a 'integrity') -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            xintegrity="sha384-ZvpUoO/+PpLzWDNGbKOSMmkOWMwSKEASBbSlogoMObxKkyVj51DaoKqrqaSNOuK6"
            crossorigin="anonymous"></script>
    
    <!-- Chessboard.js (Corregido 'xintegrity' a 'integrity') -->
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
            xintegrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUgJitwyksISJqCCGmyNFN2bZqXQcUlSKSfG8"
            crossorigin="anonymous"></script>

    <!-- Chess.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.min.js"></script>

</body>
</html>