<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desafío de Ajedrez ELO</title>
    
    <!-- 1. Hoja de estilos de chessboard.js -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    
    <!-- 2. Tailwind CSS para la UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 3. jQuery (requerido por chessboard.js) -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    
    <!-- 4. chess.js (la lógica del juego) - v0.10.3 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <!-- 5. chessboard.js (el tablero visual) -->
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <style>
        /* Aseguramos que el tablero sea responsivo */
        #main-board-container {
            width: 90vw;
            max-width: 600px;
            margin: 0 auto;
        }
        #myBoard {
            width: 100%;
        }
        #myBoard .piece-417db {
            width: 100%;
            height: 100%;
        }

        /* Estilo para resaltar movimientos legales */
        #myBoard .square-55d63.highlight-move {
            background-color: rgba(20, 83, 40, 0.4);
            box-shadow: inset 0 0 3px 3px rgba(20, 83, 40, 0.4);
        }
        
        /* Estilo para el spinner de carga */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4 font-sans">

    <!-- Contenido principal del juego (inicialmente oculto) -->
    <div id="game-container" class="w-full flex flex-col items-center" style="display: none;">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">Desafío de Ajedrez</h1>

        <!-- Contenedor del tablero -->
        <div id="main-board-container">
            <div id="myBoard"></div>
        </div>

        <!-- Panel de estado e instrucciones -->
        <div class="mt-4 p-4 bg-white rounded-lg shadow-md text-center w-full max-w-lg">
            <p id="status" class="text-lg font-semibold text-gray-700 h-8">Turno: Blancas</p>
            <p id="elo-status" class="text-lg font-semibold text-blue-600 mt-2">Tu ELO: 1000</p>
            <p class="text-sm text-gray-500 mt-2">Juegas con las blancas. Arrastra las piezas para moverlas.</p>
            <button id="reset-button" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-md shadow hover:bg-blue-700 transition-colors">
                Reiniciar Partida
            </button>
        </div>
    </div>

    <!-- Modal de Promoción (oculto por defecto) -->
    <div id="promotion-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <p class="text-xl font-semibold w-full text-center mb-4">Promocionar a:</p>
            <div class="flex space-x-4">
                <div class="cursor-pointer p-2 rounded hover:bg-gray-200" data-piece="q"><img id="promote-q" src="https://logise1.github.io/chess/assets/wq.png" alt="Reina" class="w-16 h-16 piece-promote"></div>
                <div class="cursor-pointer p-2 rounded hover:bg-gray-200" data-piece="r"><img id="promote-r" src="https://logise1.github.io/chess/assets/wr.png" alt="Torre" class="w-16 h-16 piece-promote"></div>
                <div class="cursor-pointer p-2 rounded hover:bg-gray-200" data-piece="b"><img id="promote-b" src="https://logise1.github.io/chess/assets/wb.png" alt="Alfil" class="w-16 h-16 piece-promote"></div>
                <div class="cursor-pointer p-2 rounded hover:bg-gray-200" data-piece="n"><img id="promote-n" src="https://logise1.github.io/chess/assets/wn.png" alt="Caballo" class="w-16 h-16 piece-promote"></div>
            </div>
        </div>
    </div>

    <!-- ¡NUEVO! Modal de ELO (se muestra al inicio) -->
    <div id="elo-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-4">Bienvenido</h2>
            <p class="text-gray-600 mb-6">Ingresa tu ELO para ajustar la dificultad del bot.</p>
            <input type="number" id="elo-input" placeholder="Ej: 1200" class="w-full px-4 py-2 border rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="start-game-button" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md shadow hover:bg-blue-700 transition-colors">
                Comenzar a Jugar
            </button>
            <p class="text-xs text-gray-400 mt-4">(Si dejas en blanco, se usará 1000)</p>
        </div>
    </div>


    <script>
        $(document).ready(function() {
            // --- 1. Variables Globales ---
            var board = null; 
            var game = new Chess(); 
            var $status = $('#status');
            var $eloStatus = $('#elo-status');
            var $board = $('#myBoard');
            var $promotionModal = $('#promotion-modal');
            var $eloModal = $('#elo-modal');
            var $gameContainer = $('#game-container');
            
            var pendingMove = null;
            var playerElo = 1000; // Default
            
            // --- 2. Lógica del Bot (IA) con Minimax ---
            
            // Valores de las piezas (positivos para blancas, negativos para negras)
            var pieceValues = { 'p': 10, 'n': 30, 'b': 30, 'r': 50, 'q': 90, 'k': 900 };

            // Tablas de evaluación posicional (simplificadas)
            // (Mejora mucho la IA, indicando qué posiciones son buenas)
            var pawnEval = [
                [0,  0,  0,  0,  0,  0,  0,  0],
                [5, 10, 10, -20,-20, 10, 10,  5],
                [5, -5,-10,  0,  0,-10, -5,  5],
                [0,  0,  0, 20, 20,  0,  0,  0],
                [5,  5, 10, 25, 25, 10,  5,  5],
                [10,10, 20, 30, 30, 20, 10, 10],
                [50,50, 50, 50, 50, 50, 50, 50],
                [0,  0,  0,  0,  0,  0,  0,  0]
            ];
            var knightEval = [
                [-50,-40,-30,-30,-30,-30,-40,-50],
                [-40,-20,  0,  5,  5,  0,-20,-40],
                [-30,  5, 10, 15, 15, 10,  5,-30],
                [-30,  0, 15, 20, 20, 15,  0,-30],
                [-30,  5, 15, 20, 20, 15,  5,-30],
                [-30,  0, 10, 15, 15, 10,  0,-30],
                [-40,-20,  0,  0,  0,  0,-20,-40],
                [-50,-40,-30,-30,-30,-30,-40,-50]
            ];
            // ... (se pueden añadir más para alfiles, torres, etc.)

            // Evalúa el tablero
            // Positivo = Ventaja Blanca, Negativo = Ventaja Negra
            function evaluateBoard(board) {
                var totalEvaluation = 0;
                for (var i = 0; i < 8; i++) {
                    for (var j = 0; j < 8; j++) {
                        var piece = board[i][j];
                        if (piece) {
                            var value = pieceValues[piece.type];
                            // Añadir bonus de posición
                            if (piece.type === 'p') {
                                value += (piece.color === 'w') ? pawnEval[i][j] : -pawnEval[7-i][j];
                            } else if (piece.type === 'n') {
                                value += (piece.color === 'w') ? knightEval[i][j] : -knightEval[7-i][j];
                            }
                            //... (añadir más evaluaciones)
                            
                            totalEvaluation += (piece.color === 'w' ? value : -value);
                        }
                    }
                }
                return totalEvaluation;
            }

            // Algoritmo Minimax
            function minimax(depth, gameInstance, alpha, beta, isMaximizingPlayer) {
                if (depth === 0) {
                    return -evaluateBoard(gameInstance.board()); // Evaluar desde la perspectiva del jugador que NO acaba de mover
                }

                var possibleMoves = gameInstance.moves();
                
                // Si no hay movimientos (Jaque Mate o Ahogado)
                if (possibleMoves.length === 0) {
                    if (gameInstance.in_checkmate()) {
                        return isMaximizingPlayer ? -Infinity : Infinity;
                    }
                    return 0; // Tablas
                }

                if (isMaximizingPlayer) {
                    var bestValue = -Infinity;
                    for (var i = 0; i < possibleMoves.length; i++) {
                        gameInstance.move(possibleMoves[i]);
                        bestValue = Math.max(bestValue, minimax(depth - 1, gameInstance, alpha, beta, false));
                        gameInstance.undo();
                        alpha = Math.max(alpha, bestValue);
                        if (beta <= alpha) break; // Poda Alpha-Beta
                    }
                    return bestValue;
                } else {
                    var bestValue = Infinity;
                    for (var i = 0; i < possibleMoves.length; i++) {
                        gameInstance.move(possibleMoves[i]);
                        bestValue = Math.min(bestValue, minimax(depth - 1, gameInstance, alpha, beta, true));
                        gameInstance.undo();
                        beta = Math.min(beta, bestValue);
                        if (beta <= alpha) break; // Poda Alpha-Beta
                    }
                    return bestValue;
                }
            }

            // Encuentra el mejor movimiento para el bot
            function findBestMove() {
                var possibleMoves = game.moves();
                if (possibleMoves.length === 0) return;

                var bestMove = null;
                var bestValue = -Infinity;
                
                // Determinar profundidad según ELO
                var searchDepth = 1;
                if (playerElo >= 1000) searchDepth = 2;
                if (playerElo >= 1300) searchDepth = 3;
                if (playerElo >= 1600) searchDepth = 4; // ¡Puede ser lento!
                
                // Iterar sobre todos los movimientos
                for (var i = 0; i < possibleMoves.length; i++) {
                    var move = possibleMoves[i];
                    game.move(move);
                    // Llamamos a minimax para el JUGADOR (minimizando)
                    var boardValue = minimax(searchDepth - 1, game, -Infinity, Infinity, false);
                    game.undo();
                    
                    if (boardValue > bestValue) {
                        bestValue = boardValue;
                        bestMove = move;
                    }
                }
                
                // Hacer el movimiento encontrado
                game.move(bestMove);
                board.position(game.fen());
                updateStatus();
            }
            
            // Función wrapper para que el bot piense sin congelar la UI
            function makeBotMove() {
                $status.html('Turno: Negras <div class="loader"></div>');
                // Usar requestAnimationFrame para no bloquear el hilo principal
                requestAnimationFrame(function() {
                    findBestMove();
                });
            }


            // --- 3. Funciones de Evento de Chessboard.js ---

            function removeGreySquares () {
                $board.find('.square-55d63').removeClass('highlight-move');
            }
            function greySquare (square) {
                $board.find('.square-' + square).addClass('highlight-move');
            }

            function onDragStart(source, piece, position, orientation) {
                if (game.game_over()) return false;
                if (piece.search(/^b/) !== -1) return false;
                if (game.turn() === 'b') return false;

                removeGreySquares();
                var moves = game.moves({ square: source, verbose: true });
                if (moves.length === 0) return false;
                moves.forEach(move => greySquare(move.to));

                var playerColor = 'w'; 
                $promotionModal.find('.piece-promote').each(function() {
                    var pieceType = $(this).parent().data('piece');
                    $(this).attr('src', 'https://logise1.github.io/chess/assets/' + playerColor + pieceType + '.png');
                });
                return true;
            }

            function onDrop(source, target) {
                removeGreySquares();

                var piece = game.get(source).type;
                var targetRank = target.charAt(1);
                var isPromotion = (piece === 'p' && targetRank === '8'); // Solo blancas

                var legalMoves = game.moves({ square: source, verbose: true });
                var legalMove = legalMoves.find(m => m.to === target);

                if (!legalMove) return 'snapback';

                if (isPromotion) {
                    pendingMove = { from: source, to: target };
                    $promotionModal.removeClass('hidden');
                    return 'snapback';
                }

                var move = game.move({ from: source, to: target });
                if (move === null) return 'snapback';

                updateStatus();

                if (!game.game_over()) {
                    window.setTimeout(makeBotMove, 250); // Dar un respiro
                }
            }
            
            $promotionModal.find('.cursor-pointer').on('click', function() {
                var promotion = $(this).data('piece');
                if (pendingMove) {
                    game.move({
                        from: pendingMove.from,
                        to: pendingMove.to,
                        promotion: promotion
                    });
                    
                    board.position(game.fen());
                    $promotionModal.addClass('hidden');
                    updateStatus();
                    
                    if (!game.game_over()) {
                        window.setTimeout(makeBotMove, 250);
                    }
                }
                pendingMove = null;
            });

            function onSnapEnd() {
                if (!pendingMove) {
                    board.position(game.fen());
                }
            }

            // --- 4. Función de Estado ---
            function updateStatus() {
                var status = '';
                var moveColor = (game.turn() === 'w') ? 'Blancas' : 'Negras';
                var eloChange = 0;

                if (game.in_checkmate()) {
                    var winner = (moveColor === 'Blancas') ? 'Negras' : 'Blancas';
                    status = '¡Jaque Mate! Ganan las ' + winner;
                    
                    if (winner === 'Blancas') {
                        playerElo += 10;
                        eloChange = 10;
                    } else {
                        playerElo -= 10;
                        eloChange = -10;
                    }
                    localStorage.setItem('playerElo', playerElo.toString());
                }
                else if (game.in_draw()) {
                    status = '¡Tablas!';
                }
                else {
                    status = 'Turno: ' + moveColor;
                    if (game.in_check()) {
                        status += ' (¡Jaque!)';
                    }
                }

                $status.html(status);
                var eloText = 'Tu ELO: ' + playerElo;
                if (eloChange > 0) {
                    eloText += ' <span class="text-green-500">(+10)</span>';
                } else if (eloChange < 0) {
                    eloText += ' <span class="text-red-500">(-10)</span>';
                }
                $eloStatus.html(eloText);
            }

            // --- 5. Inicialización ---
            function resetGame() {
                game.reset(); 
                board.start(); 
                updateStatus(); 
                $eloStatus.html('Tu ELO: ' + playerElo);
            }
            
            // ¡NUEVO! Lógica del modal de ELO
            function initializeGame() {
                var storedElo = localStorage.getItem('playerElo');
                if (storedElo) {
                    playerElo = parseInt(storedElo);
                    $eloStatus.html('Tu ELO: ' + playerElo);
                    $eloModal.addClass('hidden');
                    $gameContainer.show();
                } else {
                    $eloModal.removeClass('hidden');
                    $gameContainer.hide();
                }
                
                // Configuración de Chessboard
                var config = {
                    draggable: true,
                    position: 'start',
                    onDragStart: onDragStart,
                    onDrop: onDrop,
                    onSnapEnd: onSnapEnd,
                    // pieceTheme: 'https://logise1.github.io/chess/assets/{piece}.png' // Plantilla simplificada (¡ESTO ERA INCORRECTO!)
                    
                    // ¡CORREGIDO! Usar una función para convertir a minúsculas
                    pieceTheme: function (piece) { 
                        // piece es 'wR', 'bK', etc.
                        // El servidor de assets espera 'wr.png', 'bk.png'
                        var pieceCode = piece.toLowerCase();
                        return 'https://logise1.github.io/chess/assets/' + pieceCode + '.png';
                    }
                };
                
                board = Chessboard('myBoard', config);
                $(window).resize(board.resize);
                $('#reset-button').on('click', resetGame);
                updateStatus();
            }
            
            $('#start-game-button').on('click', function() {
                var inputElo = $('#elo-input').val();
                // Validar y fijar ELO
                var elo = parseInt(inputElo) || 1000;
                playerElo = Math.max(800, Math.min(2000, elo)); // Limitar ELO entre 800 y 2000
                
                localStorage.setItem('playerElo', playerElo.toString());
                $eloStatus.html('Tu ELO: ' + playerElo);
                $eloModal.addClass('hidden');
                $gameContainer.show();
                
                // Redibujar el tablero por si el modal afectó el tamaño
                $(window).trigger('resize');
            });

            // Iniciar la lógica
            initializeGame();
        });
    </script>
</body>
</html>