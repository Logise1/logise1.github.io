<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Ajedrez - Iniciar Sesión</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="text-white font-sans antialiased">

    <!-- Fondo dinámico -->
    <div id="dynamic-background"></div>

    <div id="app-container" class="min-h-screen p-4 flex items-center justify-center">

        <!-- Pantalla de Autenticación -->
        <div id="auth-screen" class="w-full max-w-md">
            <div class="glass-panel p-8 w-full">
                <h1 class="text-3xl font-bold text-center mb-6 text-white">Plataforma de Ajedrez</h1>
                
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-300 mb-1">Nombre de Usuario</label>
                    <input type="text" id="username" class="w-full px-4 py-2 bg-gray-700 bg-opacity-70 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="TuUsuario123">
                </div>
                
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Contraseña</label>
                    <input type="password" id="password" class="w-full px-4 py-2 bg-gray-700 bg-opacity-70 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••">
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md btn-hover-effect">Iniciar Sesión</button>
                    <button id="register-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md btn-hover-effect">Registrarse</button>
                </div>
                
                <p id="auth-message" class="text-red-300 text-center mt-4 text-sm"></p>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            updateProfile,
            onAuthStateChanged, 
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc,
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración de Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyDWGEMpfCF7OvBiM68uthumbOeDHwWai6M",
            authDomain: "chess-a9347.firebaseapp.com",
            projectId: "chess-a9347",
            storageBucket: "chess-a99347.firebasestorage.app",
            messagingSenderId: "950558367537",
            appId: "1:950558367537:web:4cee83e2053262a4541a10"
        };

        // --- Inicialización de Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

        // --- Referencias al DOM ---
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const authMessage = document.getElementById('auth-message');

        // --- Funciones de Utilidad ---
        function formatFirebaseError(error) {
            switch (error.code) {
                case 'auth/invalid-email': return 'El formato del nombre de usuario no es válido.';
                case 'auth/user-not-found':
                case 'auth/wrong-password': return 'Usuario o contraseña incorrectos.';
                case 'auth/email-already-in-use': return 'Ese nombre de usuario ya está en uso.';
                case 'auth/weak-password': return 'La contraseña debe tener al menos 6 caracteres.';
                case 'auth/invalid-credential': return 'Usuario o contraseña incorrectos.';
                default:
                    console.error(error);
                    return 'Ocurrió un error. Inténtalo de nuevo.';
            }
        }

        function getEmailFromUsername(username) {
            return `${username.trim()}@email.com`;
        }
        
        // --- Lógica de Firestore (Datos de Usuario) ---
        function getUserDocRef(uid) {
            return doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
        }

        async function createUserData(uid, username) {
            const userRef = getUserDocRef(uid);
            const userData = {
                username: username,
                elo: 300, // ELO inicial
                createdAt: serverTimestamp(),
                gamesPlayed: 0,
                wins: 0,
                needsTest: true // Marcar para la partida de prueba
            };
            try {
                await setDoc(userRef, userData);
            } catch (error) {
                console.error("Error al crear datos de usuario:", error);
                authMessage.textContent = "Error al guardar tu perfil.";
            }
        }

        // --- Lógica de Autenticación ---
        setPersistence(auth, browserLocalPersistence);

        // Redirigir si ya está logueado
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.location.href = 'home.html';
            }
        });

        loginBtn.addEventListener('click', async () => {
            const username = usernameInput.value;
            const password = passwordInput.value;
            if (!username || !password) {
                authMessage.textContent = 'Por favor, introduce usuario y contraseña.';
                return;
            }
            authMessage.textContent = '';
            try {
                const email = getEmailFromUsername(username);
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged se activará y redirigirá
            } catch (error) {
                authMessage.textContent = formatFirebaseError(error);
            }
        });

        registerBtn.addEventListener('click', async () => {
            const username = usernameInput.value;
            const password = passwordInput.value;
            if (!username || !password) {
                authMessage.textContent = 'Por favor, introduce usuario y contraseña.';
                return;
            }
            authMessage.textContent = '';
            try {
                const email = getEmailFromUsername(username);
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: username });
                await createUserData(userCredential.user.uid, username);
                // onAuthStateChanged se activará y redirigirá
            } catch (error) {
                authMessage.textContent = formatFirebaseError(error);
            }
        });

    </script>
</body>
</html>