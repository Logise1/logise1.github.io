<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Monitor de Signos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #000000;
            color: #ffffff;
            text-align: center;
        }
        .container {
            width: 100%;
            height: 100vh;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .sensor-card {
            background-color: #1a1a1a;
            border-radius: 20px;
            padding: 8px;
            border: 1px solid #333;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-bottom: 8px;
        }
        .sensor-title { font-size: 0.8em; font-weight: 300; color: #999; }
        .sensor-value { font-size: 1.8em; font-weight: 700; }
        .sensor-unit { font-size: 0.8em; }
        .btn { padding: 10px; border-radius: 50px; font-weight: bold; cursor: pointer; border: none; width: 80%; margin: 5px auto; }
        #status { font-size: 0.7em; color: #fca5a5; height: 20px; }
        .chart-container { position: relative; height: 120px; width: 100%; margin: 5px 0; }
        
        /* Estilos para modo PC */
        .pc-mode .container { max-width: 1200px; margin: auto; flex-direction: row; flex-wrap: wrap; align-items: flex-start; }
        .pc-mode .main-content { width: 70%; }
        .pc-mode .sidebar { width: 30%; padding-left: 20px; }
        .pc-mode .chart-container { height: 250px; }
        .pc-mode .sensor-card { flex-direction: row; justify-content: space-between; align-items: center; padding: 15px; }
        .pc-mode .sensor-value { font-size: 2.5em; }
        .pc-controls, .pc-sessions { background-color: #1a1a1a; border-radius: 20px; padding: 15px; margin-bottom: 15px; }
        .pc-sessions ul { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
        .pc-sessions li { background-color: #2a2a2a; padding: 8px; border-radius: 10px; margin-bottom: 5px; cursor: pointer; transition: background-color 0.2s; }
        .pc-sessions li:hover { background-color: #3a3a3a; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <h1 class="text-xl font-bold text-gray-300 mb-2">Monitor de Signos</h1>
            
            <div class="flex space-x-2">
                <div class="sensor-card w-1/2">
                    <p class="sensor-title">Ritmo Cardíaco</p>
                    <div>
                        <span id="heart-rate" class="sensor-value text-green-400">--</span>
                        <span class="sensor-unit text-green-400">BPM</span>
                    </div>
                </div>
                <div class="sensor-card w-1/2">
                    <p class="sensor-title">Oxígeno Sangre (Sim.)</p>
                    <div>
                        <span id="spo2" class="sensor-value text-sky-400">--</span>
                        <span class="sensor-unit text-sky-400">% SpO2</span>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="bpmChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="spo2Chart"></canvas>
            </div>

            <div id="status">Usa HTTPS y da permisos para el sensor.</div>
            <button id="toggle-btn" class="btn bg-green-500 text-black">Iniciar</button>
        </div>

        <div class="sidebar">
            <div class="pc-controls hidden">
                <h2 class="text-lg font-bold mb-2">Controles</h2>
                <button id="new-session-btn" class="btn bg-blue-500 text-white w-full">Nueva Sesión</button>
                <button id="save-session-btn" class="btn bg-purple-500 text-white w-full">Guardar Sesión</button>
            </div>
            <div class="pc-sessions hidden">
                <h2 class="text-lg font-bold mb-2">Sesiones Guardadas</h2>
                <ul id="sessions-list"></ul>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const firebaseConfig = { databaseURL: "https://hello-74404-default-rtdb.europe-west1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let sessionRef;

        // --- ELEMENTOS DEL DOM ---
        const elements = {
            heartRate: document.getElementById('heart-rate'),
            spo2: document.getElementById('spo2'),
            toggleBtn: document.getElementById('toggle-btn'),
            status: document.getElementById('status'),
            newSessionBtn: document.getElementById('new-session-btn'),
            saveSessionBtn: document.getElementById('save-session-btn'),
            sessionsList: document.getElementById('sessions-list'),
            pcControls: document.querySelector('.pc-controls'),
            pcSessions: document.querySelector('.pc-sessions'),
        };

        // --- ESTADO DE LA APP ---
        let state = {
            heartRateSensor: null,
            spo2Interval: null,
            isActive: false,
            isPcMode: false,
            currentSessionId: null
        };

        // --- GRÁFICOS ---
        let bpmChart, spo2Chart;
        const createChart = (ctx, label, borderColor) => {
            return new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label, data: [], borderColor, borderWidth: 2, fill: false, tension: 0.4, pointRadius: 0 }] },
                options: {
                    scales: { y: { beginAtZero: false, ticks: { color: '#999' } }, x: { ticks: { color: '#999' } } },
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: false
                }
            });
        };

        const addDataToChart = (chart, label, data) => {
            chart.data.labels.push(label);
            chart.data.datasets.forEach((dataset) => { dataset.data.push(data); });
            if (chart.data.labels.length > 30) { // Mantener solo 30 puntos
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.update('quiet');
        };
        
        const clearCharts = () => {
            bpmChart.data.labels = [];
            bpmChart.data.datasets[0].data = [];
            spo2Chart.data.labels = [];
            spo2Chart.data.datasets[0].data = [];
            bpmChart.update();
            spo2Chart.update();
        };

        // --- LÓGICA DE SENSORES Y DATOS ---
        const startSensors = async () => {
            elements.status.textContent = 'Solicitando permisos...';
            startNewSession();

            // Ritmo Cardíaco
            try {
                if ('HeartRateSensor' in window) {
                    state.heartRateSensor = new HeartRateSensor({ frequency: 1 });
                    state.heartRateSensor.addEventListener('reading', handleHeartRateReading);
                    await state.heartRateSensor.start();
                } else {
                    handleSensorError('BPM no soportado.');
                }
            } catch (error) {
                handleSensorError(`Error BPM: ${error.message}`);
            }

            // Simulación de SpO2
            let baseSpo2 = 98.0;
            state.spo2Interval = setInterval(() => {
                const fluctuation = (Math.random() - 0.5) * 0.6;
                let currentSpo2 = Math.max(95.0, Math.min(99.9, baseSpo2 + fluctuation));
                handleSpo2Reading(currentSpo2);
            }, 2000);
        };

        const stopSensors = () => {
            if (state.heartRateSensor) state.heartRateSensor.stop();
            if (state.spo2Interval) clearInterval(state.spo2Interval);
            elements.heartRate.textContent = '--';
            elements.spo2.textContent = '--';
            elements.status.textContent = 'Detenido.';
        };

        const handleHeartRateReading = () => {
            const bpm = state.heartRateSensor.heartRate.toFixed(0);
            elements.heartRate.textContent = bpm;
            const now = new Date();
            addDataToChart(bpmChart, now.toLocaleTimeString(), bpm);
            if (state.isActive) {
                sessionRef.push({ type: 'bpm', value: bpm, timestamp: now.toISOString() });
            }
        };

        const handleSpo2Reading = (spo2Value) => {
            const spo2 = spo2Value.toFixed(1);
            elements.spo2.textContent = spo2;
            const now = new Date();
            addDataToChart(spo2Chart, now.toLocaleTimeString(), spo2);
            if (state.isActive) {
                sessionRef.push({ type: 'spo2', value: spo2, timestamp: now.toISOString() });
            }
        };
        
        const handleSensorError = (message) => {
             elements.heartRate.textContent = 'N/A';
             elements.status.textContent = message;
             console.error(message);
        };

        // --- LÓGICA DE SESIONES (FIREBASE) ---
        const startNewSession = () => {
            state.currentSessionId = `session_${Date.now()}`;
            sessionRef = database.ref(`data/${state.currentSessionId}`);
            clearCharts();
            elements.status.textContent = 'Nueva sesión iniciada.';
        };

        const saveCurrentSession = () => {
            if (!state.currentSessionId) {
                alert('No hay sesión activa para guardar.');
                return;
            }
            const savedSessionRef = database.ref(`saved_sessions/${state.currentSessionId}`);
            sessionRef.once('value', (snapshot) => {
                savedSessionRef.set(snapshot.val());
                alert(`Sesión ${new Date(parseInt(state.currentSessionId.split('_')[1])).toLocaleString()} guardada.`);
                loadSavedSessions();
            });
        };
        
        const loadSavedSessions = () => {
            const savedSessionsRef = database.ref('saved_sessions');
            savedSessionsRef.once('value', (snapshot) => {
                elements.sessionsList.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const sessionId = childSnapshot.key;
                    const li = document.createElement('li');
                    li.textContent = new Date(parseInt(sessionId.split('_')[1])).toLocaleString();
                    li.onclick = () => loadSessionDataToChart(sessionId);
                    elements.sessionsList.appendChild(li);
                });
            });
        };

        const loadSessionDataToChart = (sessionId) => {
            const sessionDataRef = database.ref(`saved_sessions/${sessionId}`);
            sessionDataRef.once('value', (snapshot) => {
                clearCharts();
                snapshot.forEach((dataPoint) => {
                    const data = dataPoint.val();
                    const chart = data.type === 'bpm' ? bpmChart : spo2Chart;
                    addDataToChart(chart, new Date(data.timestamp).toLocaleTimeString(), data.value);
                });
                elements.status.textContent = `Mostrando sesión: ${new Date(parseInt(sessionId.split('_')[1])).toLocaleString()}`;
            });
        };

        // --- CONTROL PRINCIPAL ---
        const toggleMonitoring = async () => {
            state.isActive = !state.isActive;
            if (state.isActive) {
                await startSensors();
                elements.toggleBtn.textContent = 'Detener';
                elements.toggleBtn.classList.replace('bg-green-500', 'bg-red-500');
                elements.status.textContent = 'Monitorizando...';
            } else {
                stopSensors();
                elements.toggleBtn.textContent = 'Iniciar';
                elements.toggleBtn.classList.replace('bg-red-500', 'bg-green-500');
            }
        };

        // --- INICIALIZACIÓN ---
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            state.isPcMode = urlParams.get('mode') === 'pc';

            bpmChart = createChart(document.getElementById('bpmChart').getContext('2d'), 'BPM', '#4ade80');
            spo2Chart = createChart(document.getElementById('spo2Chart').getContext('2d'), '% SpO2', '#38bdf8');

            elements.toggleBtn.addEventListener('click', toggleMonitoring);

            if (state.isPcMode) {
                document.body.classList.add('pc-mode');
                elements.pcControls.classList.remove('hidden');
                elements.pcSessions.classList.remove('hidden');
                elements.newSessionBtn.addEventListener('click', startNewSession);
                elements.saveSessionBtn.addEventListener('click', saveCurrentSession);
                loadSavedSessions();
            }
        };
    </script>
</body>
</html>
