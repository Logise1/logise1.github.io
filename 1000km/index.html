
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1000 Kilómetros - Inmersivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        #pano, #map {
            height: 100%;
            width: 100%;
        }
        .gm-style .gm-svpc, .gm-style .gmnoprint, .gm-style .gm-fullscreen-control {
            display: none !important;
        }
        .custom-button {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .custom-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .custom-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #background-video {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: translate(-50%, -50%);
            z-index: -1;
        }
        .auth-tab.active, .leaderboard-tab.active {
            border-color: #3b82f6;
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Pantalla de Inicio -->
    <div id="start-screen" class="h-screen w-screen flex flex-col justify-center items-center text-center p-4 relative overflow-hidden">
        <video id="background-video" autoplay loop muted>
            <source src="https://yyf.mubilop.com/file/639c9010/Video_de_Nubes_a_Gran_Velocidad.mp4" type="video/mp4">
            Tu navegador no soporta vídeos HTML5.
        </video>
        <div class="z-10 bg-black bg-opacity-50 p-8 rounded-xl flex flex-col items-center text-center">
            <h1 class="text-6xl md:text-8xl font-black uppercase tracking-wider text-white">1000 <span class="text-blue-400">Kilómetros</span></h1>
            
            <div id="user-info-container" class="mt-4">
                <p id="welcome-message" class="text-gray-200 mt-4"></p>
                
                <div class="mt-4 flex flex-col md:flex-row md:space-x-8 items-center md:items-start justify-center">
                    <!-- Récords Personales (se muestra solo si está logueado) -->
                    <div id="personal-records-container" class="hidden text-left p-4 bg-gray-800 bg-opacity-70 rounded-lg">
                        <h3 class="text-xl font-bold mb-2">Tus Récords</h3>
                        <div id="record-display"></div>
                        <button id="logout-button" class="mt-4 text-sm text-red-400 hover:text-red-300">Cerrar Sesión</button>
                    </div>
                    <!-- Clasificación (siempre visible) -->
                    <div id="leaderboard-container" class="w-full md:w-80 mt-4 md:mt-0 p-4 bg-gray-800 bg-opacity-70 rounded-lg">
                        <h3 class="text-xl font-bold mb-2">Clasificación</h3>
                        <div id="leaderboard-tabs" class="flex border-b border-gray-600 mb-2">
                            <button data-mode="madrid" class="leaderboard-tab flex-1 py-1 px-2 text-sm">Madrid</button>
                            <button data-mode="peninsula" class="leaderboard-tab flex-1 py-1 px-2 text-sm">Península</button>
                            <button data-mode="mundo" class="leaderboard-tab flex-1 py-1 px-2 text-sm">Mundo</button>
                        </div>
                        <ol id="leaderboard-list" class="list-decimal list-inside text-left space-y-2 text-base"></ol>
                    </div>
                </div>
            </div>

            <div id="mode-selector" class="mt-8 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                 <button data-mode="madrid" class="custom-button bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg">
                    Madrid <span class="block text-sm opacity-80">100 km</span>
                </button>
                <button data-mode="peninsula" class="custom-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg">
                    Península <span class="block text-sm opacity-80">1000 km</span>
                </button>
                <button data-mode="mundo" class="custom-button bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg">
                    Mundo <span class="block text-sm opacity-80">10000 km</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Autenticación -->
    <div id="auth-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-sm relative">
            <button id="close-modal-button" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
            <div class="flex border-b border-gray-600 mb-4">
                <button id="login-tab" class="auth-tab flex-1 py-2 font-bold border-b-2">Iniciar Sesión</button>
                <button id="register-tab" class="auth-tab flex-1 py-2 font-bold border-b-2">Registrarse</button>
            </div>
            <div id="auth-form-container"></div>
            <p id="auth-error" class="text-red-400 text-sm mt-4 h-5"></p>
        </div>
    </div>

    <!-- Pantalla de Juego -->
    <div id="game-screen" class="hidden h-screen w-screen relative">
        <div id="pano" class="h-full w-full"></div>
        <div id="map-container" class="hidden absolute inset-0 z-10 bg-gray-800">
            <div id="map"></div>
        </div>
        <div id="loading-overlay" class="hidden absolute inset-0 z-30 bg-gray-900 bg-opacity-80 flex flex-col justify-center items-center text-center">
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-xl">Buscando una nueva ubicación...</p>
        </div>
        <div id="ui-container" class="absolute bottom-0 left-0 right-0 p-4 z-20 flex justify-between items-end">
            <div class="bg-black bg-opacity-60 p-3 rounded-lg">
                <h2 class="text-sm font-bold uppercase">Kilómetros restantes</h2>
                <p id="score" class="text-4xl font-black text-blue-400">1000</p>
                <p id="ingame-record" class="text-sm text-yellow-300">Récord: 0 rondas</p>
                <p id="result-text" class="text-yellow-400 font-bold h-6"></p>
            </div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                <button id="toggle-map-button" class="custom-button bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-5 rounded-lg">Mostrar Mapa</button>
                <button id="guess-button" class="custom-button bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-5 rounded-lg" disabled>Adivinar</button>
                <button id="next-round-button" class="hidden custom-button bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-5 rounded-lg">Siguiente Ronda</button>
            </div>
        </div>
    </div>

    <!-- Pantalla de Fin de Juego -->
    <div id="game-over-screen" class="hidden h-screen w-screen flex flex-col justify-center items-center text-center p-4">
        <h2 class="text-5xl font-bold text-red-500">¡Juego Terminado!</h2>
        <p class="text-gray-300 mt-4 text-xl">Te has quedado sin kilómetros.</p>
        <button id="back-to-menu-button" class="custom-button mt-8 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-xl">
            Volver al Menú
        </button>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const firebaseConfig = { databaseURL: "https://other-games-443a1-default-rtdb.europe-west1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        const API_KEY = 'AIzaSyDcgWTXsYOLFXuBiVBjnnMzc5fmwdDVKDk';
        const BOUNDS = {
            mundo: { north: 90, south: -90, west: -180, east: 180 },
            peninsula: { north: 43.8, south: 36.0, west: -9.5, east: 3.4 },
            madrid: { north: 41.16, south: 39.88, west: -4.55, east: -3.06 }
        };

        // --- VARIABLES GLOBALES ---
        let map, panorama, streetViewService, guessMarker, actualMarker, polyline;
        let totalKilometers = 0;
        let roundCount = 0;
        let gameMode = '';
        let gameBounds = null;
        let mapCenter = { lat: 40.4, lng: -3.7 };
        let mapZoom = 5;
        let actualLocation = null;
        let guessedLocation = null;
        let isMapVisible = false;
        let gameState = 'loading';
        let currentUser = null;
        let allUsersData = [];

        // --- ELEMENTOS DEL DOM ---
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const scoreDisplay = document.getElementById('score');
        const guessButton = document.getElementById('guess-button');
        const nextRoundButton = document.getElementById('next-round-button');
        const toggleMapButton = document.getElementById('toggle-map-button');
        const mapContainer = document.getElementById('map-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const resultText = document.getElementById('result-text');
        const modeSelector = document.getElementById('mode-selector');
        const authModal = document.getElementById('auth-modal');
        const authFormContainer = document.getElementById('auth-form-container');
        const authError = document.getElementById('auth-error');
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const closeModalButton = document.getElementById('close-modal-button');
        const welcomeMessage = document.getElementById('welcome-message');
        const personalRecordsContainer = document.getElementById('personal-records-container');
        const recordDisplay = document.getElementById('record-display');
        const logoutButton = document.getElementById('logout-button');
        const ingameRecord = document.getElementById('ingame-record');
        const leaderboardTabs = document.getElementById('leaderboard-tabs');
        const leaderboardList = document.getElementById('leaderboard-list');

        // --- LÓGICA DE AUTENTICACIÓN Y DATOS ---
        
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function showAuthModal(mode) {
            if (currentUser) {
                selectGameMode(mode);
                return;
            }
            gameMode = mode;
            authModal.classList.remove('hidden');
            switchAuthTab('login');
        }
        
        function hideAuthModal() {
            authModal.classList.add('hidden');
            authError.textContent = '';
        }
        
        function switchAuthTab(tab) {
            authError.textContent = '';
            const isLogin = tab === 'login';
            loginTab.classList.toggle('active', isLogin);
            registerTab.classList.toggle('active', !isLogin);
            
            const formHTML = `
                <form id="auth-form">
                    <div class="mb-4">
                        <label for="username" class="block text-sm font-bold mb-2">Usuario</label>
                        <input type="text" id="username" class="w-full px-3 py-2 text-gray-800 rounded-md" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-bold mb-2">Contraseña</label>
                        <input type="password" id="password" class="w-full px-3 py-2 text-gray-800 rounded-md" required>
                    </div>
                    <button type="submit" class="custom-button w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                        ${isLogin ? 'Iniciar Sesión' : 'Registrarse'}
                    </button>
                </form>
            `;
            authFormContainer.innerHTML = formHTML;
            document.getElementById('auth-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = document.getElementById('username').value.trim();
                const pass = document.getElementById('password').value.trim();
                if (user && pass) {
                   isLogin ? await handleLogin(user, pass) : await handleRegister(user, pass);
                }
            });
        }

        async function handleLogin(username, password) {
            const userRef = database.ref('/1000km/users/' + username);
            const snapshot = await userRef.once('value');
            const passwordHash = await hashPassword(password);
            if (snapshot.exists() && snapshot.val().passwordHash === passwordHash) {
                currentUser = { username, records: snapshot.val().records || { madrid: 0, peninsula: 0, mundo: 0 } };
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                hideAuthModal();
                selectGameMode(gameMode);
            } else {
                authError.textContent = 'Usuario o contraseña incorrectos.';
            }
        }

        async function handleRegister(username, password) {
            const userRef = database.ref('/1000km/users/' + username);
            const snapshot = await userRef.once('value');
            if (snapshot.exists()) {
                authError.textContent = 'El nombre de usuario ya existe.';
            } else {
                const passwordHash = await hashPassword(password);
                const newUser = {
                    passwordHash: passwordHash,
                    records: { madrid: 0, peninsula: 0, mundo: 0 }
                };
                await userRef.set(newUser);
                currentUser = { username, records: newUser.records };
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                hideAuthModal();
                selectGameMode(gameMode);
            }
        }
        
        function handleLogout() {
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            updateUIForLoggedOutState();
        }

        function checkSession() {
            const storedUser = sessionStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                updateUIForLoggedInState();
            } else {
                updateUIForLoggedOutState();
            }
        }

        // --- LÓGICA DE UI Y CLASIFICACIÓN ---
        
        async function fetchAndDisplayLeaderboard() {
            const usersRef = database.ref('/1000km/users');
            const usersSnapshot = await usersRef.once('value');
            const users = usersSnapshot.val() || {};
            allUsersData = Object.keys(users).map(username => ({
                username,
                records: users[username].records || { madrid: 0, peninsula: 0, mundo: 0 }
            }));
            displayLeaderboard('madrid');
        }

        async function updateUIForLoggedInState() {
            welcomeMessage.innerHTML = `¡Hola, <span class="font-bold text-blue-400">${currentUser.username}</span>!`;
            welcomeMessage.classList.remove('hidden');
            recordDisplay.innerHTML = `
                <p><strong>Madrid:</strong> ${currentUser.records.madrid} rondas</p>
                <p><strong>Península:</strong> ${currentUser.records.peninsula} rondas</p>
                <p><strong>Mundo:</strong> ${currentUser.records.mundo} rondas</p>
            `;
            personalRecordsContainer.classList.remove('hidden');
            await fetchAndDisplayLeaderboard();
        }
        
        function displayLeaderboard(mode) {
            leaderboardTabs.querySelectorAll('button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            const sortedUsers = [...allUsersData].sort((a, b) => (b.records[mode] || 0) - (a.records[mode] || 0));
            leaderboardList.innerHTML = '';
            sortedUsers.slice(0, 5).forEach(user => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="font-bold">${user.username}</span> - ${user.records[mode] || 0} rondas`;
                leaderboardList.appendChild(li);
            });
        }

        async function updateUIForLoggedOutState() {
            welcomeMessage.classList.add('hidden');
            personalRecordsContainer.classList.add('hidden');
            await fetchAndDisplayLeaderboard();
        }

        // --- LÓGICA DEL JUEGO ---

        function selectGameMode(mode) {
            gameMode = mode;
            roundCount = 0;
            switch(mode) {
                case 'mundo':
                    totalKilometers = 10000;
                    gameBounds = BOUNDS.mundo;
                    mapCenter = { lat: 20, lng: 0 };
                    mapZoom = 2;
                    break;
                case 'madrid':
                    totalKilometers = 100;
                    gameBounds = BOUNDS.madrid;
                    mapCenter = { lat: 40.416775, lng: -3.703790 };
                    mapZoom = 10;
                    break;
                default: // peninsula
                    totalKilometers = 1000;
                    gameBounds = BOUNDS.peninsula;
                    mapCenter = { lat: 40.4, lng: -3.7 };
                    mapZoom = 5;
                    break;
            }
            
            if (window.google && window.google.maps) {
                startGame();
            } else {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=geometry&callback=startGame`;
                script.async = true;
                document.head.appendChild(script);
            }
        }

        window.startGame = () => {
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            gameOverScreen.classList.add('hidden');
            
            scoreDisplay.textContent = totalKilometers;
            ingameRecord.textContent = `Récord: ${currentUser ? currentUser.records[gameMode] : 0} rondas`;

            if (!map) {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: mapCenter,
                    zoom: mapZoom,
                    disableDefaultUI: true,
                    zoomControl: true,
                    streetViewControl: false
                });
                panorama = new google.maps.StreetViewPanorama(document.getElementById('pano'), {
                    addressControl: false, linksControl: true, panControl: true, zoomControl: true, scrollwheel: true, enableCloseButton: false
                });
                map.setStreetView(panorama);
                streetViewService = new google.maps.StreetViewService();
                map.addListener('click', (e) => {
                    if (gameState !== 'playing') return;
                    guessedLocation = e.latLng;
                    if (!guessMarker) {
                        guessMarker = new google.maps.Marker({ position: guessedLocation, map: map, icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png' });
                    } else {
                        guessMarker.setPosition(guessedLocation);
                    }
                    guessButton.disabled = false;
                });
            }
            loadNewRound();
        };
        
        function findRandomStreetViewLocation() {
            return new Promise((resolve) => {
                const tryToFind = () => {
                    const lat = Math.random() * (gameBounds.north - gameBounds.south) + gameBounds.south;
                    const lng = Math.random() * (gameBounds.east - gameBounds.west) + gameBounds.west;
                    const randomPoint = new google.maps.LatLng(lat, lng);
                    streetViewService.getPanorama({ location: randomPoint, radius: 50000, source: 'outdoor' }, (data, status) => {
                        if (status === 'OK') resolve(data.location.latLng);
                        else setTimeout(tryToFind, 50);
                    });
                };
                tryToFind();
            });
        }

        async function loadNewRound() {
            roundCount++;
            gameState = 'loading';
            loadingOverlay.classList.remove('hidden');
            resultText.textContent = '';
            toggleMapButton.classList.remove('hidden');
            guessButton.classList.remove('hidden');
            nextRoundButton.classList.add('hidden');
            guessButton.disabled = true;
            toggleMapButton.textContent = 'Mostrar Mapa';
            mapContainer.classList.add('hidden');
            isMapVisible = false;
            if (guessMarker) guessMarker.setMap(null);
            if (actualMarker) actualMarker.setMap(null);
            if (polyline) polyline.setMap(null);
            guessMarker = actualMarker = polyline = guessedLocation = null;
            actualLocation = await findRandomStreetViewLocation();
            panorama.setPosition(actualLocation);
            map.setCenter(mapCenter);
            map.setZoom(mapZoom);
            loadingOverlay.classList.add('hidden');
            gameState = 'playing';
        }

        function handleToggleMap() {
            isMapVisible = !isMapVisible;
            if (isMapVisible) {
                mapContainer.classList.remove('hidden');
                toggleMapButton.textContent = 'Ocultar Mapa';
                google.maps.event.trigger(map, 'resize');
            } else {
                mapContainer.classList.add('hidden');
                toggleMapButton.textContent = 'Mostrar Mapa';
            }
        }

        function handleGuess() {
            if (!guessedLocation || gameState !== 'playing') return;
            gameState = 'result';
            const distanceInKm = Math.round(google.maps.geometry.spherical.computeDistanceBetween(actualLocation, guessedLocation) / 1000);
            totalKilometers -= distanceInKm;
            if (totalKilometers < 0) totalKilometers = 0;
            scoreDisplay.textContent = totalKilometers;
            resultText.textContent = `¡Fallaste por ${distanceInKm} km!`;
            if (!isMapVisible) handleToggleMap();
            actualMarker = new google.maps.Marker({ position: actualLocation, map: map, icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png' });
            polyline = new google.maps.Polyline({ path: [actualLocation, guessedLocation], geodesic: true, strokeColor: '#FF0000', map: map });
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(actualLocation);
            bounds.extend(guessedLocation);
            map.fitBounds(bounds);
            guessButton.classList.add('hidden');
            toggleMapButton.classList.add('hidden');
            nextRoundButton.classList.remove('hidden');
            if (totalKilometers <= 0) {
                setTimeout(endGame, 2500);
            }
        }

        function endGame() {
            const finalScore = roundCount - 1;
            if (currentUser && finalScore > (currentUser.records[gameMode] || 0)) {
                currentUser.records[gameMode] = finalScore;
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                database.ref(`/1000km/users/${currentUser.username}/records/${gameMode}`).set(finalScore);
            }
            gameScreen.classList.add('hidden');
            gameOverScreen.classList.remove('hidden');
        }

        function backToMenu() {
            gameOverScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            checkSession();
        }

        // --- EVENT LISTENERS ---
        modeSelector.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.mode) {
                showAuthModal(button.dataset.mode);
            }
        });
        loginTab.addEventListener('click', () => switchAuthTab('login'));
        registerTab.addEventListener('click', () => switchAuthTab('register'));
        closeModalButton.addEventListener('click', hideAuthModal);
        authModal.addEventListener('click', (e) => {
            if (e.target === authModal) hideAuthModal();
        });
        logoutButton.addEventListener('click', handleLogout);
        leaderboardTabs.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.mode) {
                displayLeaderboard(button.dataset.mode);
            }
        });
        guessButton.addEventListener('click', handleGuess);
        nextRoundButton.addEventListener('click', loadNewRound);
        toggleMapButton.addEventListener('click', handleToggleMap);
        document.getElementById('back-to-menu-button').addEventListener('click', backToMenu);

        // --- INICIALIZACIÓN ---
        checkSession();
    </script>
</body>
</html>
