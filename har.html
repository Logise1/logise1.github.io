<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extractor de Imágenes HAR</title>
    <!-- Tailwind CSS para estilos rápidos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZip para descargar todo en un ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver para guardar el ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        .drag-active {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800 font-sans">

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Encabezado -->
        <header class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-blue-600 mb-2">Extractor de Imágenes de Archivos .HAR</h1>
            <p class="text-gray-600">Sube tu archivo HAR y recupera todas las imágenes capturadas en la sesión de red.</p>
        </header>

        <!-- Tutorial: Cómo conseguir un HAR -->
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-8 rounded-r shadow-sm max-w-4xl mx-auto">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-bold text-blue-800">¿Cómo conseguir un archivo .HAR?</h3>
                    <div class="mt-2 text-sm text-blue-800">
                        <ol class="list-decimal list-inside space-y-1 ml-1">
                            <li>Abre la página web de la que quieres extraer las imágenes en Chrome, Edge o Firefox.</li>
                            <li>Pulsa <span class="font-mono bg-blue-100 px-1 rounded">F12</span> (o clic derecho en la página -> <strong>Inspeccionar</strong>).</li>
                            <li>Ve a la pestaña <strong>Red</strong> (Network).</li>
                            <li><strong>Recarga</strong> la página (F5) para que se registre todo el tráfico.</li>
                            <li>Haz clic derecho sobre cualquier línea de la lista de peticiones.</li>
                            <li>Selecciona <strong>"Guardar todo como HAR con contenido"</strong> (Save all as HAR with content).</li>
                            <li>Sube el archivo descargado en el recuadro de abajo.</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Zona de Carga -->
        <div id="drop-zone" class="bg-white p-10 rounded-xl shadow-md border-2 border-dashed border-gray-300 transition-all cursor-pointer text-center mb-8 hover:border-blue-400">
            <input type="file" id="file-input" accept=".har,.json" class="hidden">
            <div class="pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <p class="text-lg font-medium text-gray-700">Arrastra tu archivo .har aquí</p>
                <p class="text-sm text-gray-500 mt-1">o haz clic para seleccionar</p>
            </div>
        </div>

        <!-- Estado y Controles -->
        <div id="controls" class="hidden flex flex-wrap justify-between items-center mb-6 bg-white p-4 rounded-lg shadow-sm">
            <div class="mb-2 sm:mb-0">
                <span class="font-bold text-gray-700">Resultados: </span>
                <span id="image-count" class="text-blue-600 font-bold">0</span> imágenes encontradas
                <span id="file-name-display" class="text-xs text-gray-400 ml-2 block sm:inline"></span>
            </div>
            <div class="flex space-x-2">
                <button id="download-all-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Descargar ZIP
                </button>
                <button id="reset-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    Limpiar
                </button>
            </div>
        </div>

        <!-- Cargando -->
        <div id="loading" class="hidden text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-500">Analizando archivo HAR...</p>
        </div>

        <!-- Galería -->
        <div id="gallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
            <!-- Las imágenes se insertarán aquí -->
        </div>
        
        <div id="empty-state" class="hidden text-center py-12 text-gray-400">
            <p>No se encontraron imágenes en este archivo HAR.</p>
        </div>
    </div>

    <script>
        // Elementos del DOM
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const gallery = document.getElementById('gallery');
        const loading = document.getElementById('loading');
        const controls = document.getElementById('controls');
        const imageCount = document.getElementById('image-count');
        const emptyState = document.getElementById('empty-state');
        const downloadBtn = document.getElementById('download-all-btn');
        const resetBtn = document.getElementById('reset-btn');
        const fileNameDisplay = document.getElementById('file-name-display');

        let extractedImages = []; // Almacenará objetos { blob, filename, type }

        // Event Listeners para Drag & Drop
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-active');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-active');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-active');
            if (e.dataTransfer.files.length) {
                processFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                processFile(e.target.files[0]);
            }
        });

        resetBtn.addEventListener('click', resetApp);

        downloadBtn.addEventListener('click', async () => {
            if (extractedImages.length === 0) return;

            const zip = new JSZip();
            const folder = zip.folder("imagenes_har");

            // Añadir imágenes al ZIP
            extractedImages.forEach((img, index) => {
                // Asegurar extensión única si hay nombres duplicados es complejo, 
                // así que usaremos un índice si es necesario o el nombre original.
                // Para simplificar y evitar colisiones:
                let name = img.filename;
                // Limpiar nombre de caracteres raros
                name = name.replace(/[^a-zA-Z0-9._-]/g, '_');
                
                // Si el nombre no tiene extensión, añadirla basada en el tipo
                if (!name.includes('.')) {
                    const ext = img.type.split('/')[1] || 'bin';
                    name = `${name}.${ext}`;
                }
                
                // Evitar sobreescritura simple añadiendo indice
                const uniqueName = `${index}_${name}`;
                folder.file(uniqueName, img.blob);
            });

            // Generar y guardar
            const content = await zip.generateAsync({type:"blob"});
            saveAs(content, "imagenes_extraidas.zip");
        });

        function resetApp() {
            gallery.innerHTML = '';
            controls.classList.add('hidden');
            emptyState.classList.add('hidden');
            extractedImages = [];
            fileInput.value = '';
            fileNameDisplay.textContent = '';
        }

        function processFile(file) {
            resetApp();
            loading.classList.remove('hidden');
            fileNameDisplay.textContent = `(${file.name})`;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const harData = JSON.parse(e.target.result);
                    extractImagesFromHar(harData);
                } catch (error) {
                    alert('Error al leer el archivo JSON/HAR. Asegúrate de que el formato sea válido.');
                    console.error(error);
                    loading.classList.add('hidden');
                }
            };

            reader.readAsText(file);
        }

        function extractImagesFromHar(harData) {
            const entries = harData.log?.entries || [];
            extractedImages = [];

            entries.forEach(entry => {
                const mimeType = entry.response?.content?.mimeType || '';
                const text = entry.response?.content?.text;
                const encoding = entry.response?.content?.encoding;
                const url = entry.request?.url || 'imagen-desconocida';

                // Filtrar solo imágenes
                if (mimeType.startsWith('image/') && text) {
                    try {
                        let blob;
                        
                        if (encoding === 'base64') {
                            // Convertir base64 a Blob
                            const byteCharacters = atob(text);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            blob = new Blob([byteArray], {type: mimeType});
                        } else {
                            // SVG u otros formatos de texto plano
                            blob = new Blob([text], {type: mimeType});
                        }

                        // Obtener nombre de archivo de la URL
                        let filename = url.substring(url.lastIndexOf('/') + 1).split('?')[0];
                        if (!filename || filename.length > 50) filename = 'imagen';
                        
                        extractedImages.push({
                            blob: blob,
                            url: URL.createObjectURL(blob),
                            filename: filename,
                            type: mimeType,
                            size: (blob.size / 1024).toFixed(1) + ' KB',
                            dimensions: 'Calculando...' // Se podría obtener cargando la imagen
                        });

                    } catch (err) {
                        console.warn('Error procesando imagen:', err);
                    }
                }
            });

            renderGallery();
            loading.classList.add('hidden');
        }

        function renderGallery() {
            if (extractedImages.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }

            controls.classList.remove('hidden');
            imageCount.textContent = extractedImages.length;

            extractedImages.forEach(img => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow overflow-hidden border border-gray-200 group hover:shadow-lg transition-shadow';
                
                // Determinar clase para el contenedor de la imagen según el tipo (transparencia)
                const bgClass = img.type.includes('svg') || img.type.includes('png') ? 'bg-gray-50 bg-checkered' : 'bg-gray-100';

                card.innerHTML = `
                    <div class="h-40 w-full ${bgClass} flex items-center justify-center overflow-hidden relative">
                        <img src="${img.url}" class="max-h-full max-w-full object-contain" alt="${img.filename}">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100">
                            <a href="${img.url}" download="${img.filename}" class="bg-white text-gray-800 p-2 rounded-full shadow hover:bg-blue-50" title="Descargar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                            </a>
                        </div>
                    </div>
                    <div class="p-3">
                        <p class="text-sm font-medium text-gray-800 truncate" title="${img.filename}">${img.filename}</p>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-gray-500 uppercase">${img.type.split('/')[1]}</span>
                            <span class="text-xs text-gray-400">${img.size}</span>
                        </div>
                    </div>
                `;
                gallery.appendChild(card);
            });
        }
    </script>
    
    <!-- Estilo para fondo ajedrezado (transparencia) -->
    <style>
        .bg-checkered {
            background-image: 
                linear-gradient(45deg, #e5e7eb 25%, transparent 25%), 
                linear-gradient(-45deg, #e5e7eb 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #e5e7eb 75%), 
                linear-gradient(-45deg, transparent 75%, #e5e7eb 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
    </style>
</body>
</html>
