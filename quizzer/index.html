<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quizzer</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <style>
        /* Fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Transiciones suaves para las vistas */
        .view {
            display: none; /* Oculto por defecto */
        }
        .view.active {
            display: block; /* Visible cuando está activo */
        }
        /* Estilos para el feedback de las respuestas */
        .option-btn.correct {
            background-color: #22c55e !important; /* green-500 */
            color: white !important;
            border-color: #16a34a !important; /* green-600 */
        }
        .option-btn.incorrect {
            background-color: #ef4444 !important; /* red-500 */
            color: white !important;
            border-color: #dc2626 !important; /* red-600 */
        }
        .option-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        /* Estilos para las pestañas de Auth */
        .auth-tab.active {
            border-bottom-color: #6366f1; /* indigo-500 */
            color: #6366f1;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <!-- Contenedor principal -->
    <div class="container mx-auto p-4 max-w-3xl">

        <!-- Encabezado -->
        <header class="shadow-md rounded-lg p-6 mb-6 flex flex-wrap justify-end items-center gap-4 sticky top-4 z-10 bg-gray-100" 
                style="background-image: url('banner.png'); background-size: contain; background-position: center; background-repeat: no-repeat;">
            <!-- <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent">Quizzer</h1> --> <!-- Texto Quizzer eliminado -->
            
            <div id="auth-controls" class="hidden flex flex-wrap items-center justify-end gap-2 sm:gap-4">
                <!-- Mostraremos el Nombre de Usuario (oculto en móvil) -->
                <div id="user-name-display" class="text-sm font-semibold text-gray-700 hidden sm:block"></div>
                
                <!-- Monedero (sin borde en móvil) -->
                <div id="user-coin-display" class="flex items-center gap-1 text-yellow-600 sm:border-l-2 sm:border-gray-200 sm:pl-4 sm:ml-2">
                    <i data-lucide="circle-dollar-sign" class="w-5 h-5"></i>
                    <span id="user-coin-balance" class="font-bold text-lg">0</span>
                </div>

                <!-- Botón de Inicio (solo icono en móvil) -->
                <button id="home-btn" class="flex items-center gap-2 px-2 py-2 sm:px-4 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition-colors">
                    <i data-lucide="home"></i>
                    <span class="hidden sm:inline">Inicio</span>
                </button>
                <!-- Botón de Sign Out (solo icono en móvil) -->
                <button id="sign-out-btn" class="flex items-center gap-2 px-2 py-2 sm:px-4 bg-red-600 text-white rounded-lg shadow hover:bg-red-700 transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">Salir</span>
                </button>
            </div>
        </header>

        <main>
            <!-- VISTA DE AUTENTICACIÓN -->
            <section id="view-auth" class="view active">
                <div class="bg-white p-8 rounded-lg shadow-xl max-w-md mx-auto">
                    <!-- Pestañas -->
                    <div class="flex border-b mb-6">
                        <button id="tab-login" class="auth-tab active flex-1 py-3 text-center text-gray-500 border-b-2 border-transparent transition-colors" data-form="login-form-container">Iniciar Sesión</button>
                        <button id="tab-register" class="auth-tab flex-1 py-3 text-center text-gray-500 border-b-2 border-transparent transition-colors" data-form="register-form-container">Registrarse</button>
                    </div>

                    <!-- Formulario de Login -->
                    <div id="login-form-container" class="space-y-4">
                        <h2 class="text-2xl font-bold text-center text-gray-800">Iniciar Sesión</h2>
                        <form id="login-form" class="space-y-4">
                            <div>
                                <label for="login-username" class="block text-sm font-medium text-gray-700">Nombre de Usuario</label>
                                <input type="text" id="login-username" name="username" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300">
                            </div>
                            <div>
                                <label for="login-password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                                <input type="password" id="login-password" name="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300">
                            </div>
                            <button type="submit" class="w-full flex justify-center items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition-colors">
                                <span>Entrar</span>
                            </button>
                        </form>
                    </div>

                    <!-- Formulario de Registro -->
                    <div id="register-form-container" class="space-y-4 hidden">
                        <h2 class="text-2xl font-bold text-center text-gray-800">Crear Cuenta</h2>
                        <form id="register-form" class="space-y-4">
                            <div>
                                <label for="register-username" class="block text-sm font-medium text-gray-700">Nombre de Usuario</label>
                                <input type="text" id="register-username" name="username" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300">
                            </div>
                            <div>
                                <label for="register-password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                                <input type="password" id="register-password" name="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300">
                            </div>
                            <button type="submit" class="w-full flex justify-center items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition-colors">
                                <span>Registrarse</span>
                            </button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Vista: Inicio (Lista de Quizzes) -->
            <section id="view-home" class="view space-y-4">
                <div class="flex flex-wrap justify-between items-center gap-3">
                    <h2 class="text-2xl font-semibold">Quizzes Disponibles</h2>
                    <div class="flex gap-2">
                        <button id="show-general-leaderboard-btn" class="flex items-center gap-2 px-4 py-2 bg-amber-500 text-white rounded-lg shadow hover:bg-amber-600 transition-colors">
                            <i data-lucide="trophy"></i>
                            <span>Ranking General</span>
                        </button>
                        <button id="show-create-view-btn" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition-colors">
                            <i data-lucide="plus"></i>
                            <span>Crear Quiz</span>
                        </button>
                    </div>
                </div>
                <!-- **** ¡CAMBIO AQUÍ! (Filtro "Mis Quizzes") **** -->
                <div class="mb-4">
                    <label for="category-filter" class="block text-sm font-medium text-gray-700">Filtrar por Categoría</label>
                    <select id="category-filter" name="category-filter" class="mt-1 block w-full sm:w-1/2 md:w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300 bg-white">
                        <option value="all">Todas las Categorías (excepto Otros)</option>
                        <option value="recent">Recientes (Últimas 24h)</option>
                        <option value="mine">Mis Quizzes Creados</option> <!-- AÑADIDO -->
                        <option>Mates</option>
                        <option>Lengua</option>
                        <option>Geografía</option>
                        <option>Física y Química</option>
                        <option>Inglés</option>
                        <option>Tecnología</option>
                        <option>Otros</option>
                    </select>
                </div>
                <!-- **** FIN DEL CAMBIO **** -->
                <div id="quiz-list-container" class="space-y-4">
                    <p class="text-gray-500">Cargando quizzes...</p>
                </div>
            </section>

            <!-- Vista: Crear Quiz -->
            <section id="view-create" class="view">
                <div class="bg-white p-6 rounded-lg shadow-xl">
                    <h2 class="text-2xl font-semibold mb-4">Crear Nuevo Quiz</h2>
                    <form id="create-quiz-form" class="space-y-4">
                        <div>
                            <label for="quiz-title" class="block text-sm font-medium text-gray-700">Título del Quiz</label>
                            <input type="text" id="quiz-title" name="quiz-title" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300" placeholder="Ej: Los Planetas del Sistema Solar">
                        </div>
                        <div>
                            <label for="quiz-topic" class="block text-sm font-medium text-gray-700">Tema del Quiz (para la IA)</label>
                            <input type="text" id="quiz-topic" name="quiz-topic" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300" placeholder="Ej: Historia de Roma, Capitales del Mundo">
                        </div>
                        <div>
                            <label for="quiz-category" class="block text-sm font-medium text-gray-700">Categoría</label>
                            <select id="quiz-category" name="quiz-category" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300 bg-white">
                                <option>Mates</option>
                                <option>Lengua</option>
                                <option>Geografía</option>
                                <option>Física y Química</option>
                                <option>Inglés</option>
                                <option>Tecnología</option>
                                <option selected>Otros</option>
                            </select>
                        </div>
                        <div>
                            <label for="quiz-level" class="block text-sm font-medium text-gray-700">Nivel Educativo</label>
                            <select id="quiz-level" name="quiz-level" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300 bg-white">
                                <option>General</option>
                                <optgroup label="Primaria">
                                    <option>1º Primaria</option>
                                    <option>2º Primaria</option>
                                    <option>3º Primaria</option>
                                    <option>4º Primaria</option>
                                    <option>5º Primaria</option>
                                    <option>6º Primaria</option>
                                </optgroup>
                                <optgroup label="ESO">
                                    <option>1º ESO</option>
                                    <option>2º ESO</option>
                                    <option>3º ESO</option>
                                    <option>4º ESO</option>
                                </optgroup>
                                <optgroup label="Bachillerato">
                                    <option>1º Bachillerato</option>
                                    <option>2º Bachillerato</option>
                                </optgroup>
                                <option>Universidad</option>
                                <option>Otro</option>
                            </select>
                        </div>
                        <div>
                            <label for="quiz-num-questions" class="block text-sm font-medium text-gray-700">Número de Preguntas</label>
                            <input type="number" id="quiz-num-questions" name="quiz-num-questions" min="3" max="25" value="5" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Tipo de Quiz</label>
                            <div class="mt-2 flex gap-4">
                                <label class="flex items-center">
                                    <input type="radio" name="quiz-type" value="free" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                                    <span class="ml-2 text-gray-700">Gratis (Ganas 2 monedas si lo juegan)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="quiz-type" value="paid" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                    <span class="ml-2 text-gray-700">De Pago</span>
                                </label>
                            </div>
                        </div>
                        <div id="quiz-price-container" class="hidden">
                            <label for="quiz-price" class="block text-sm font-medium text-gray-700">Precio (monedas)</label>
                            <input type="number" id="quiz-price" name="quiz-price" min="1" max="100" value="5" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300">
                        </div>

                        <button type="submit" class="w-full flex justify-center items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition-colors">
                            <i data-lucide="wand-2"></i>
                            <span>Generar Quiz con IA</span>
                        </button>
                    </form>
                </div>
            </section>

            <!-- Vista: Jugando Quiz -->
            <section id="view-play" class="view">
                <div class="bg-white p-6 rounded-lg shadow-xl">
                    
                    <!-- Barra de Progreso y Timer -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center text-sm font-medium text-gray-600 mb-1">
                            <span>Progreso</span>
                            <span id="timer-display" class="font-mono text-indigo-600 flex items-center gap-1">
                                <i data-lucide="timer" class="w-4 h-4"></i>
                                <span>0.0s</span>
                            </span>
                        </div>
                        <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="play-quiz-title" class="text-2xl font-semibold"></h2>
                        <span id="score-display" class="text-xl font-bold text-indigo-600">Puntaje: 0</span>
                    </div>
                    
                    <div id="question-container" class="mb-6">
                        <p id="question-text" class="text-lg font-medium mb-4"></p>
                        <div id="options-container" class="space-y-3">
                            <!-- Opciones generadas aquí -->
                        </div>
                    </div>

                    <div id="next-question-loader" class="hidden text-center p-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-indigo-500 mx-auto"></div>
                        <p class="text-lg font-semibold text-gray-700 mt-4">Generando siguientes preguntas...</p>
                    </div>


                    <div id="end-quiz-container" class="hidden text-center">
                        <h3 class="text-2xl font-bold mb-2">¡Quiz Terminado!</h3>
                        <p id="final-score-text" class="text-2xl font-light mb-4"></p>
                        <p id="final-time-text" class="text-xl font-light mb-4"></p>
                        <p id="final-coin-text" class="text-lg mb-4 text-yellow-600 font-semibold"></p>
                        
                        <!-- Formulario de Guardar Puntaje -->
                        <form id="leaderboard-form" class="flex flex-col sm:flex-row gap-2 justify-center">
                            <input type="text" id="player-name" placeholder="Tu nombre para el ranking" required class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300">
                            <button type="submit" class="flex justify-center items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-7V00 transition-colors">
                                <i data-lucide="save"></i>
                                <span>Guardar Puntaje</span>
                            </button>
                        </form>

                        <button id="view-leaderboard-btn" class="hidden mt-4 flex justify-center items-center gap-2 w-full max-w-xs mx-auto px-4 py-2 bg-slate-500 text-white rounded-lg shadow hover:bg-slate-600 transition-colors">
                            <i data-lucide="bar-chart-3"></i>
                            <span>Ver Clasificación</span>
                        </button>
                        
                        <!-- Sección Modo Golden -->
                        <div id="golden-mode-prompt" class="mt-8 border-t border-gray-200 pt-6">
                            <h4 class="text-xl font-semibold text-yellow-500 flex items-center justify-center gap-2">
                                <img src="golden.gif" alt="Golden" class="w-10 h-10 animate-bounce object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                                <i data-lucide="award" class="w-10 h-10" style="display:none;"></i> <!-- Fallback icon -->
                                Modo Golden
                            </h4>
                            <p class="text-gray-600 my-2">¿Te atreves? Si fallas una sola pregunta, vuelves al principio.</p>
                            <button id="start-golden-mode-btn" class="w-full px-4 py-2 bg-yellow-500 text-black rounded-lg shadow font-bold hover:bg-yellow-600 transition-colors">
                                ¡Intentar Modo Golden!
                            </button>
                        </div>

                        <div id="diamond-mode-prompt" class="hidden mt-8 border-t-2 border-indigo-300 pt-6">
                             <h4 class="text-xl font-semibold text-indigo-500 flex items-center justify-center gap-2">
                                <img src="diamond.gif" alt="Diamante" class="w-10 h-10 animate-pulse object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                                <i data-lucide="gem" class="w-10 h-10" style="display:none;"></i> <!-- Fallback icon -->
                                ¡MODO DIAMANTE DESBLOQUEADO!
                            </h4>
                            <p class="text-gray-600 my-2">¡Has superado el Modo Golden! ¿Aceptas el desafío final?</p>
                            <p class="text-sm text-gray-500 mb-3">(40 preguntas nuevas, dificultad experto).</p>
                            <button id="start-diamond-mode-btn" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg shadow font-bold hover:bg-indigo-700 transition-colors">
                                ¡Probar Modo Diamante!
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Vista: Leaderboard (Quiz Específico) -->
            <section id="view-leaderboard" class="view">
                <div class="bg-white p-6 rounded-lg shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="leaderboard-title" class="text-2xl font-semibold">Leaderboard</h2>
                        <button id="leaderboard-back-btn" class="flex items-center gap-2 px-4 py-2 bg-slate-500 text-white rounded-lg shadow hover:bg-slate-600 transition-colors">
                            <i data-lucide="arrow-left"></i>
                            <span>Volver</span>
                        </button>
                    </div>
                    <ol id="leaderboard-list" class="list-none space-y-2">
                        <li class="text-gray-500">Cargando leaderboard...</li>
                    </ol>
                </div>
            </section>

            <!-- VISTA: Leaderboard General (Monedas) -->
            <section id="view-general-leaderboard" class="view">
                <div class="bg-white p-6 rounded-lg shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="general-leaderboard-title" class="text-2xl font-semibold">Ranking General de Monedas</h2>
                        <button id="general-leaderboard-back-btn" class="flex items-center gap-2 px-4 py-2 bg-slate-500 text-white rounded-lg shadow hover:bg-slate-600 transition-colors">
                            <i data-lucide="arrow-left"></i>
                            <span>Volver</span>
                        </button>
                    </div>
                    <ol id="general-leaderboard-list" class="list-none space-y-2">
                        <li class="text-gray-500">Cargando ranking...</li>
                    </ol>
                </div>
            </section>

            <!-- Vista: Cargando -->
            <section id="view-loading" class="view">
                <div class="bg-white p-12 rounded-lg shadow-xl text-center flex flex-col items-center gap-4">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div>
                    <h2 id="loading-text" class="text-2xl font-semibold text-gray-700">Generando tu quiz con IA...</h2>
                    <p class="text-gray-500">Esto puede tardar unos segundos.</p>
                </div>
            </section>
        </main>
    </div>

    <!-- Modales -->
    <div id="error-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-red-600">Error</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <p id="error-message" class="text-gray-700"></p>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
            <h3 id="confirm-title" class="text-xl font-bold text-gray-900 mb-4">Confirmar Acción</h3>
            <p id="confirm-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="confirm-cancel-btn" class="px-4 py-2 bg-slate-300 text-gray-800 rounded-lg hover:bg-slate-400 transition-colors">Cancelar</button>
                <button id="confirm-ok-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">Confirmar</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Importaciones de Firebase (SIN AUTH)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Importaciones de REALTIME DATABASE
        import { 
            getDatabase,
            ref,
            onValue, 
            get,    
            set,    
            push,   
            runTransaction,
            query, 
            orderByChild 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // IDs de las Vistas
        const VIEWS = {
            AUTH: 'view-auth', 
            HOME: 'view-home',
            CREATE: 'view-create',
            PLAY: 'view-play',
            LEADERBOARD: 'view-leaderboard',
            GENERAL_LEADERBOARD: 'view-general-leaderboard', 
            LOADING: 'view-loading'
        };

        // Estado de la aplicación
        let quizzes = []; 
        let currentQuiz = null; // El objeto del quiz que se está jugando
        let currentQuizDocId = null; // El ID de base de datos del quiz
        let currentQuestionIndex = 0;
        let score = 0;
        let userCoinBalance = 0;
        let quizStartTime = 0; 
        let loggedInUser = null; 
        let quizTimerInterval = null; 
        let timeElapsed = 0; 
        let currentQuizIsGolden = false; 
        let currentQuizIsDiamond = false; 

        let isGeneratingMoreQuestions = false; // Flag para evitar llamadas duplicadas
        let generatedQuestionText = []; // Array de strings de preguntas ya generadas

        // Variables de Firebase
        let db, appId, dbPath; 
        let confirmModal, confirmTitle, confirmMessage, confirmCancelBtn, confirmOkBtn;
        let userWalletRef = null; 
        let userWalletListener = null; 

        // Elementos del DOM
        const views = {
            auth: document.getElementById(VIEWS.AUTH), 
            home: document.getElementById(VIEWS.HOME),
            create: document.getElementById(VIEWS.CREATE),
            play: document.getElementById(VIEWS.PLAY),
            leaderboard: document.getElementById(VIEWS.LEADERBOARD),
            generalLeaderboard: document.getElementById(VIEWS.GENERAL_LEADERBOARD),
            loading: document.getElementById(VIEWS.LOADING),
        };
        const quizListContainer = document.getElementById('quiz-list-container');
        const createQuizForm = document.getElementById('create-quiz-form');
        const leaderboardForm = document.getElementById('leaderboard-form');
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const userNameDisplay = document.getElementById('user-name-display'); 
        const userCoinDisplay = document.getElementById('user-coin-display');
        const userCoinBalanceEl = document.getElementById('user-coin-balance');
        const homeBtn = document.getElementById('home-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const authControls = document.getElementById('auth-controls');
        
        // Elementos de Auth
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const tabLogin = document.getElementById('tab-login');
        const tabRegister = document.getElementById('tab-register');
        const loginFormContainer = document.getElementById('login-form-container');
        const registerFormContainer = document.getElementById('register-form-container');
        const loadingText = document.getElementById('loading-text');
        
        // --- Funciones de Utilidad ---
        
        function sanitizeRtdbPath(path) {
            return path.replace(/[.#$[\]]/g, '_');
        }

        function getTodayDateString() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Meses son 0-indexados
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        function playSound(src) {
            try {
                const audio = new Audio(src);
                audio.play().catch(e => console.warn("La reproducción automática de sonido fue bloqueada.", e));
            } catch (e) {
                console.warn("No se pudo reproducir el sonido:", e);
            }
        }

        function playCorrectSound() {
            const sounds = ['ok1.mp3', 'ok2.mp3', 'ok3.mp3'];
            const sound = sounds[Math.floor(Math.random() * sounds.length)];
            playSound(sound);
        }
        
        function playIncorrectSound() {
            const sounds = ['fail1.mp3', 'fail2.mp3'];
            const sound = sounds[Math.floor(Math.random() * sounds.length)];
            playSound(sound);
        }

        // --- Navegación ---
        function showView(viewId) {
            Object.values(views).forEach(view => {
                if (view.id === viewId) {
                    view.classList.add('active');
                } else {
                    view.classList.remove('active');
                }
            });
        }

        // --- Almacenamiento RTDB ---

        /** Carga quizzes desde RTDB en tiempo real */
        function loadQuizzes() {
            if (!dbPath) return; 
            const quizzesRef = ref(db, `${dbPath}/quizzes`);
            
            onValue(quizzesRef, (snapshot) => {
                quizzes = [];
                const quizzesData = snapshot.val();
                if (quizzesData) {
                    Object.keys(quizzesData).forEach(key => {
                        quizzes.push({ id: key, ...quizzesData[key] });
                    });
                }
                renderQuizList();
            }, (error) => {
                console.error("Error al cargar quizzes (RTDB): ", error);
                showErrorModal("No se pudieron cargar los quizzes desde la base de datos.");
                quizListContainer.innerHTML = `<p class="text-red-500">Error al cargar quizzes.</p>`;
            });
        }

        /** Escucha el monedero del usuario (RTDB) */
        function setupUserWalletListener(username) {
            if (!dbPath) return;
            if (userWalletListener) {
                userWalletListener(); 
            }
            
            userWalletRef = ref(db, `${dbPath}/wallets/${username}`); 
            
            userWalletListener = onValue(userWalletRef, (snapshot) => {
                if (snapshot.exists()) {
                    userCoinBalance = snapshot.val().coins || 0;
                } else {
                    userCoinBalance = 10; 
                    set(userWalletRef, { 
                        coins: userCoinBalance,
                        username: username 
                    }).catch(e => console.error("Fallo al crear el monedero en el login:", e));
                }
                userCoinBalanceEl.textContent = userCoinBalance;
                userCoinDisplay.classList.remove('hidden');
            }, (error) => {
                console.error("Error al escuchar el monedero (RTDB):", error);
                showErrorModal("No se pudo conectar a tu monedero de monedas.");
            });
        }

        // --- Renderizado ---

        /** Renderiza la lista de quizzes - MODIFICADO: Filtro "Mis Quizzes" y Play Count */
        function renderQuizList() {
            // **** ¡CAMBIO AQUÍ! (Lógica de filtro "Mis Quizzes") ****
            const filter = document.getElementById('category-filter').value;
            const now = new Date();
            const twentyFourHoursAgo = now.getTime() - (24 * 60 * 60 * 1000);

            const filteredQuizzes = quizzes.filter(quiz => {
                const category = quiz.category || 'Otros';
                const createdAt = new Date(quiz.createdAt).getTime();

                if (filter === 'all') {
                    return category !== 'Otros';
                }
                
                if (filter === 'recent') {
                    return createdAt > twentyFourHoursAgo;
                }

                if (filter === 'mine') { // <-- AÑADIDO ESTE BLOQUE
                    return quiz.ownerUsername === loggedInUser;
                }
                
                return category === filter;
            });
            // **** FIN DEL CAMBIO ****

            if (filteredQuizzes.length === 0) {
                quizListContainer.innerHTML = `<p class="text-gray-500">No hay quizzes que coincidan con tu filtro.</p>`;
                return;
            }
            quizListContainer.innerHTML = '';
            
            filteredQuizzes.forEach(quiz => {
                const quizCard = document.createElement('div');
                quizCard.className = 'bg-white p-4 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3';
                const quizPrice = quiz.price || 0;
                const quizType = quiz.quizType || 'free';
                const category = quiz.category || 'Otros';
                const playCount = quiz.playCount || 0; // <-- AÑADIDO

                let recordHtml = '<p class="text-sm text-gray-400">Aún no hay récord</p>';
                if (quiz.recordHolder) {
                    recordHtml = `
                    <div class="flex items-center gap-2 text-sm text-yellow-600 font-bold">
                        <span>1.</span>
                        <span>${quiz.recordHolder.name}</span>
                        <span>(${quiz.recordHolder.score} pts, ${(quiz.recordHolder.time || 0).toFixed(2)}s)</span>
                    </div>
                    `;
                }
                
                // **** ¡CAMBIO AQUÍ! (Añadido playCount) ****
                quizCard.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="text-xl font-semibold">${quiz.title}</h3>
                        <p class="text-sm text-gray-600">${quiz.questions.length} preguntas / Nivel: ${quiz.level || 'General'} / <span class="font-medium text-indigo-500">${category}</span></p>
                        <p class="text-sm text-gray-500 mb-2">
                            Autor: <span class="font-semibold text-indigo-600">${quiz.ownerUsername || 'Anónimo'}</span> 
                            / Jugado: <span class="font-semibold text-blue-500">${playCount} veces</span>
                        </p>
                        <div class="border-t border-gray-100 pt-2">
                            ${recordHtml}
                        </div>
                    </div>
                    <div class="flex flex-col items-start sm:items-end gap-2">
                        <div class="flex items-center gap-1 ${quizType === 'paid' ? 'text-yellow-600' : 'text-green-600'}">
                            <i data-lucide="${quizType === 'paid' ? 'circle-dollar-sign' : 'gift'}" class="w-4 h-4"></i>
                            <span class="font-semibold">${quizType === 'paid' ? `${quizPrice} monedas` : 'Gratis'}</span>
                        </div>
                        <div class="flex gap-2">
                            <button class="play-btn flex items-center gap-2 px-3 py-2 bg-yellow-500 text-black rounded-lg shadow hover:bg-yellow-600 transition-colors" data-quiz-id="${quiz.id}">
                                <i data-lucide="play"></i>
                                <span>Jugar</span>
                            </button>
                            <button class="leaderboard-btn flex items-center gap-2 px-3 py-2 bg-slate-500 text-white rounded-lg shadow hover:bg-slate-600 transition-colors" data-quiz-id="${quiz.id}">
                                <i data-lucide="bar-chart-3"></i>
                                <span>Leaderboard</span>
                            </button>
                        </div>
                    </div>
                `;
                // **** FIN DEL CAMBIO ****
                quizListContainer.appendChild(quizCard);
            });
            lucide.createIcons(); 
        }

        /** Muestra el leaderboard de un quiz (RTDB) */
        async function renderLeaderboard(quizId) {
            const quiz = quizzes.find(q => q.id === quizId);
            if (!quiz) return;

            document.getElementById('leaderboard-title').textContent = `Leaderboard: ${quiz.title}`;
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = `<li class="text-gray-500">Cargando leaderboard...</li>`;
            showView(VIEWS.LEADERBOARD);

            try {
                const leaderboardRef = ref(db, `${dbPath}/leaderboards/${quizId}/entries`);
                const snapshot = await get(leaderboardRef);

                let entries = [];
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    if (Array.isArray(data)) { entries = data; }
                    else if (typeof data === 'object' && data !== null) { entries = Object.values(data); }
                }

                if (entries.length === 0) {
                    list.innerHTML = `<li class="text-gray-500">Aún no hay puntajes para este quiz.</li>`;
                } else {
                    entries.sort((a, b) => {
                        if (a.score !== b.score) { return b.score - a.score; }
                        return (a.time || 999) - (b.time || 999); 
                    });
                    
                    list.innerHTML = entries.slice(0, 10).map((entry, index) => {
                        const diamondIcon = entry.isDiamond 
                            ? `<img src="diamond.gif" alt="Diamante" class="w-4 h-4 object-contain inline-block ml-1" onerror="this.style.display='none';">`
                            : '';
                        const goldenIcon = !entry.isDiamond && entry.isGolden
                            ? `<img src="golden.gif" alt="Golden" class="w-4 h-4 object-contain inline-block ml-1" onerror="this.style.display='none';">` 
                            : '';

                        return `
                        <li class="flex justify-between items-center p-2 rounded ${index === 0 ? 'bg-yellow-100 font-bold' : ''} ${index === 1 ? 'bg-gray-100' : ''} ${index === 2 ? 'bg-orange-100' : ''}">
                            <div class="flex items-center gap-2">
                                <span>${index + 1}.</span>
                                <span>${entry.name}</span>
                                ${diamondIcon}
                                ${goldenIcon}
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-semibold">${entry.score} pts</span>
                                <span class="text-sm text-gray-600 font-mono flex items-center gap-1">
                                    <i data-lucide="timer" class="w-4 h-4"></i>
                                    ${(entry.time || 0).toFixed(2)}s
                                </span>
                            </div>
                        </li>
                    `}).join('');
                    lucide.createIcons();
                }
            } catch (error) {
                console.error("Error al cargar leaderboard (RTDB): ", error);
                showErrorModal("No se pudo cargar el leaderboard.");
                list.innerHTML = `<li class="text-red-500">Error al cargar leaderboard.</li>`;
            }
        }

        /** Muestra el leaderboard general de monedas (RTDB) */
        async function renderGeneralLeaderboard() {
            const list = document.getElementById('general-leaderboard-list');
            list.innerHTML = `<li class="text-gray-500">Cargando ranking...</li>`;
            showView(VIEWS.GENERAL_LEADERBOARD);

            try {
                const walletsRef = ref(db, `${dbPath}/wallets`);
                const snapshot = await get(walletsRef);

                if (!snapshot.exists()) {
                    list.innerHTML = `<li class="text-gray-500">No hay datos de monedas.</li>`;
                    return;
                }

                const wallets = Object.values(snapshot.val());
                wallets.sort((a, b) => b.coins - a.coins); 
                
                list.innerHTML = wallets.slice(0, 20).map((wallet, index) => `
                    <li class="flex justify-between items-center p-2 rounded ${index === 0 ? 'bg-yellow-100 font-bold' : ''} ${index === 1 ? 'bg-gray-100' : ''} ${index === 2 ? 'bg-orange-100' : ''}">
                        <span>${index + 1}. ${wallet.username}</span>
                        <span class="font-semibold flex items-center gap-1">
                            <i data-lucide="circle-dollar-sign" class="w-4 h-4 text-yellow-600"></i>
                            ${wallet.coins}
                        </span>
                    </li>
                `).join('');
                lucide.createIcons();

            } catch (error) {
                console.error("Error al cargar leaderboard general (RTDB): ", error);
                showErrorModal("No se pudo cargar el ranking general.");
                list.innerHTML = `<li class="text-red-500">Error al cargar el ranking.</li>`;
            }
        }


        // --- Lógica de Creación de Quiz (IA) ---

        /** Llama a la API de IA */
        async function fetchWithRetry(url, options, retries = 5, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429) {
                    if (retries > 0) {
                        console.warn(`Error 429 (Too Many Requests). Reintento en ${delay}ms... (${retries} restantes)`);
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithRetry(url, options, retries - 1, delay * 2);
                    } else { throw new Error(`Error en la API: ${response.status} ${response.statusText}. Sin reintentos.`); }
                }
                if (!response.ok && response.status >= 500) {
                     if (retries > 0) {
                        console.warn(`Error de servidor (${response.status}). Reintento en ${delay}ms... (${retries} restantes)`);
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithRetry(url, options, retries - 1, delay * 2);
                     } else { throw new Error(`Error en la API: ${response.status} ${response.statusText}. Sin reintentos.`); }
                }
                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("Error de cliente:", errorBody);
                    throw new Error(`Error en la API: ${response.status} ${response.statusText}. (Error de cliente, no se reintenta)`);
                }
                return await response.json();
            } catch (error) {
                if (retries > 0 && !(error.message.startsWith("Error en la API"))) {
                    console.warn(`Error de red (${error.message}). Reintento en ${delay}ms... (${retries} restantes)`);
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                } else {
                    console.error("Fallaron todos los reintentos o fue un error fatal:", error);
                    throw error;
                }
            }
        }

        /** Maneja el envío del formulario de creación de quiz (RTDB) */
        async function handleCreateQuiz(e) {
            e.preventDefault();
            if (!loggedInUser) {
                showErrorModal("Debes iniciar sesión para crear un quiz.");
                return;
            }

            const today = getTodayDateString();
            const activityRef = ref(db, `${dbPath}/userActivity/${loggedInUser}`);
            const activitySnap = await get(activityRef);
            const activityData = activitySnap.val() || {};
            
            const lastCreationDate = activityData.lastQuizCreationDate;
            let quizzesCreatedToday = activityData.quizzesCreatedToday || 0;

            if (lastCreationDate !== today) {
                quizzesCreatedToday = 0; // Reiniciar contador
            }

            if (quizzesCreatedToday >= 2) {
                showErrorModal("Has alcanzado el límite de 2 quizzes creados por día. Vuelve a intentarlo mañana.");
                return; // Detener ejecución
            }

            const title = document.getElementById('quiz-title').value;
            const level = document.getElementById('quiz-level').value;
            const topic = document.getElementById('quiz-topic').value;
            const category = document.getElementById('quiz-category').value;
            const numQuestions = document.getElementById('quiz-num-questions').value;
            const quizType = document.querySelector('input[name="quiz-type"]:checked').value;
            const price = (quizType === 'paid') ? parseInt(document.getElementById('quiz-price').value, 10) : 0;
            
            if (quizType === 'paid' && (isNaN(price) || price <= 0)) {
                showErrorModal("Por favor, ingresa un precio válido para el quiz.");
                return;
            }
            
            loadingText.textContent = "Generando tu quiz con IA...";
            showView(VIEWS.LOADING);
            
            const mistralApiKey = "evxly62Xv91b752fbnHA2I3HD988C5RT";
            const mistralApiUrl = "https://api.mistral.ai/v1/chat/completions";
            const schemaDefinition = `
            {
                "type": "object",
                "properties": {
                    "title": {
                        "type": "string",
                        "description": "Un título corto y atractivo para el quiz."
                    },
                    "questions": {
                        "type": "array",
                        "description": "La lista de preguntas.",
                        "items": {
                            "type": "object",
                            "properties": {
                                "question": {
                                    "type": "string",
                                    "description": "El texto de la pregunta."
                                },
                                "options": {
                                    "type": "array",
                                    "description": "Un array de 4 posibles respuestas (strings).",
                                    "items": { "type": "string" }
                                },
                                "correctAnswer": {
                                    "type": "string",
                                    "description": "El string exacto de la respuesta correcta, debe coincidir con una de las 'options'."
                                }
                            },
                            "required": ["question", "options", "correctAnswer"]
                        }
                    }
                },
                "required": ["title", "questions"]
            }`;
            
            const systemPrompt = `Eres un experto creador de quizzes. Tu tarea es generar un quiz basado en un tema.
Debes responder ÚNICAMENTE con un objeto JSON válido que siga este esquema:
\`\`\`json
${schemaDefinition}
\`\`\`
El array 'options' debe tener exactamente 4 strings. No incluyas nada más en tu respuesta, solo el JSON.`;
            
            const userPrompt = `Genera un quiz de ${numQuestions} preguntas sobre el tema: "${topic}". El nivel es ${level} y la categoría es ${category}.`;
            
            const payload = { 
                model: 'mistral-medium-latest', 
                messages: [ 
                    { role: 'system', content: systemPrompt }, 
                    { role: 'user', content: userPrompt } 
                ], 
                response_format: { type: 'json_object' } 
            };
            
            const options = { 
                method: 'POST', 
                headers: { 
                    'Content-Type': 'application/json', 
                    'Authorization': `Bearer ${mistralApiKey}`, 
                    'Accept': 'application/json' 
                }, 
                body: JSON.stringify(payload) 
            };

            try {
                const result = await fetchWithRetry(mistralApiUrl, options);
                const jsonText = result.choices[0].message.content;
                const newQuizData = JSON.parse(jsonText);
                
                if (!newQuizData.questions || newQuizData.questions.length === 0) {
                    throw new Error("Datos del quiz incompletos o en formato incorrecto.");
                }
                
                const newQuiz = { 
                    topic: topic, 
                    level: level, 
                    category: category,
                    title: title, 
                    questions: newQuizData.questions, 
                    ownerUsername: loggedInUser, 
                    createdAt: new Date().toISOString(),
                    quizType: quizType, 
                    price: price,
                    recordHolder: null,
                    playCount: 0 // <-- AÑADIDO: Inicializar play count
                };
                
                const quizzesRef = ref(db, `${dbPath}/quizzes`);
                await push(quizzesRef, newQuiz); 

                await set(activityRef, {
                    ...activityData, 
                    lastQuizCreationDate: today,
                    quizzesCreatedToday: quizzesCreatedToday + 1
                });

                showView(VIEWS.HOME);
                createQuizForm.reset();
                document.getElementById('quiz-price-container').classList.add('hidden');
                document.querySelector('input[name="quiz-type"][value="free"]').checked = true;
            } catch (error) {
                console.error("Error al generar el quiz (RTDB):", error);
                showErrorModal(`No se pudo generar el quiz. ${error.message}`);
                showView(VIEWS.CREATE); 
            }
        }

        // --- Lógica de Juego (RTDB) ---

        // **** ¡NUEVA FUNCIÓN! (Incrementar Play Count) ****
        async function incrementPlayCount(quizId) {
            if (!dbPath) return;
            const playCountRef = ref(db, `${dbPath}/quizzes/${quizId}/playCount`);
            try {
                await runTransaction(playCountRef, (currentCount) => {
                    return (currentCount || 0) + 1;
                });
            } catch (error) {
                console.warn("Error al incrementar el contador de jugadas:", error);
                // No es un error crítico, no molestar al usuario
            }
        }

        /** Intercepta el clic de "Jugar" */
        async function handlePlayQuizClick(quizId) {
            // **** ¡CAMBIO AQUÍ! (Incrementar Play Count) ****
            await incrementPlayCount(quizId); // Incrementar al hacer clic

            const quiz = quizzes.find(q => q.id === quizId);
            if (!quiz) return;
            
            if (quiz.ownerUsername === loggedInUser) { 
                startQuiz(quiz, false);
                return; 
            }
            
            const quizType = quiz.quizType || 'free';
            
            if (quizType === 'paid') {
                const price = quiz.price || 0;
                if (userCoinBalance < price) { 
                    showErrorModal(`No tienes suficientes monedas. Necesitas ${price} para jugar. Tienes ${userCoinBalance}.`); 
                    return; 
                }
                
                showConfirmModal( 
                    `Pagar ${price} monedas`, 
                    `¿Quieres pagar ${price} monedas para jugar a "${quiz.title}"? Los fondos se transferirán a ${quiz.ownerUsername}.`,
                    async () => { 
                        try {
                            await transferCoins(quiz.ownerUsername, loggedInUser, price);
                            startQuiz(quiz, false);
                        } catch (error) { 
                            console.error("Error en la transacción de pago (RTDB):", error);
                            showErrorModal(`Falló la transacción: ${error.message}`); 
                        }
                    }
                );
            } else {
                startQuiz(quiz, false);
            }
        }

        /** Transfiere monedas (RTDB) */
        async function transferCoins(creatorUsername, playerUsername, amount) {
            const walletsRef = ref(db, `${dbPath}/wallets`);
            return runTransaction(walletsRef, (currentData) => {
                if (currentData === null) { 
                    console.warn("Transacción abortada: el nodo de wallets no existe.");
                    return; 
                }
                if (!currentData[playerUsername] || !currentData[creatorUsername]) {
                     console.warn("Transacción abortada: el monedero del jugador o creador no existe.");
                    return;
                }
                const playerCoins = currentData[playerUsername].coins;
                if (playerCoins < amount) { 
                    console.warn("Transacción abortada: fondos insuficientes.");
                    return; 
                } 
                currentData[playerUsername].coins -= amount;
                currentData[creatorUsername].coins += amount;
                return currentData;
            });
        }

        /** Otorga monedas a un usuario (RTDB) */
        async function awardCoins(targetUsername, amount) {
            if (amount <= 0) return; 
            const targetWalletRef = ref(db, `${dbPath}/wallets/${targetUsername}/coins`);
            return runTransaction(targetWalletRef, (currentCoins) => {
                return (currentCoins || 0) + amount;
            });
        }

        /** Inicia un quiz */
        function startQuiz(quizObject, isGolden = false, isDiamond = false) {
            currentQuiz = {...quizObject};
            
            currentQuizDocId = quizObject.id; 
            
            currentQuestionIndex = 0;
            score = 0;
            quizStartTime = Date.now(); 
            timeElapsed = 0; 
            currentQuizIsGolden = isGolden;
            currentQuizIsDiamond = isDiamond;
            
            if (quizTimerInterval) clearInterval(quizTimerInterval);
            
            const timerDisplay = document.getElementById('timer-display').querySelector('span');
            quizTimerInterval = setInterval(() => {
                timeElapsed = (Date.now() - quizStartTime) / 1000;
                timerDisplay.textContent = `${timeElapsed.toFixed(1)}s`;
            }, 100); 

            const titleEl = document.getElementById('play-quiz-title');
            titleEl.textContent = currentQuiz.title;
            titleEl.classList.remove('text-yellow-500', 'text-indigo-500', 'font-bold');
            if (isGolden) {
                titleEl.textContent += " (Modo Golden)";
                titleEl.classList.add('text-yellow-500', 'font-bold');
            } else if (isDiamond) {
                titleEl.textContent += " (Modo Diamante)";
                titleEl.classList.add('text-indigo-500', 'font-bold');
            }

            document.getElementById('score-display').textContent = `Puntaje: 0`;
            document.getElementById('end-quiz-container').classList.add('hidden');
            document.getElementById('question-container').classList.remove('hidden');
            document.getElementById('final-coin-text').textContent = ''; 
            leaderboardForm.reset();
            document.getElementById('player-name').value = loggedInUser; 
            document.getElementById('progress-bar').style.width = '0%'; 
            
            document.getElementById('golden-mode-prompt').style.display = 'none';
            document.getElementById('diamond-mode-prompt').style.display = 'none';
            document.getElementById('view-leaderboard-btn').style.display = 'none';
            leaderboardForm.style.display = 'none';


            displayQuestion();
            showView(VIEWS.PLAY);
        }

        /** Muestra la pregunta actual */
        function displayQuestion() {
            if (currentQuizIsDiamond && !isGeneratingMoreQuestions && currentQuiz.questions.length < 40 && currentQuestionIndex >= currentQuiz.questions.length - 5) {
                fetchMoreDiamondQuestions();
            }

            const question = currentQuiz.questions[currentQuestionIndex];
            document.getElementById('question-text').textContent = question.question;
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            const totalQuestions = currentQuizIsDiamond ? 40 : currentQuiz.questions.length;
            const progress = (currentQuestionIndex / totalQuestions) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;

            const shuffledOptions = [...question.options].sort(() => Math.random() - 0.5);
            shuffledOptions.forEach(option => {
                const optionButton = document.createElement('button');
                optionButton.className = 'option-btn block w-full text-left px-4 py-3 border border-gray-300 rounded-lg bg-white hover:bg-gray-50 transition-colors';
                optionButton.textContent = option;
                optionButton.addEventListener('click', handleAnswerClick);
                optionsContainer.appendChild(optionButton);
            });
        }

        /** Maneja el clic en una respuesta */
        async function handleAnswerClick(e) {
            const selectedButton = e.target;
            const selectedAnswer = selectedButton.textContent;
            const question = currentQuiz.questions[currentQuestionIndex];
            const correctAnswer = question.correctAnswer;
            const optionButtons = document.querySelectorAll('.option-btn');

            optionButtons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === correctAnswer) { btn.classList.add('correct'); }
                else if (btn === selectedButton) { btn.classList.add('incorrect'); }
            });

            if (selectedAnswer === correctAnswer) {
                score++;
                document.getElementById('score-display').textContent = `Puntaje: ${score}`;
                playCorrectSound();
                
                currentQuestionIndex++;
                setTimeout(async () => {
                    if (currentQuestionIndex < currentQuiz.questions.length) { 
                        displayQuestion();
                    } 
                    else if (currentQuizIsDiamond && currentQuiz.questions.length < 40) {
                        await waitForNextBatch();
                    }
                    else { 
                        await endQuiz();
                    }
                }, 1200);

            } else {
                playIncorrectSound();
                
                if (currentQuizIsGolden) {
                    showErrorModal("¡Has fallado! Reiniciando el Modo Golden...");
                    setTimeout(() => {
                        hideErrorModal();
                        startQuiz(quizzes.find(q => q.id === currentQuizDocId), true);
                    }, 2000);
                } else if (currentQuizIsDiamond) {
                    setTimeout(async () => { 
                        await endQuiz(); 
                    }, 1200);
                } else {
                    currentQuestionIndex++;
                    setTimeout(async () => { 
                        if (currentQuestionIndex < currentQuiz.questions.length) { 
                            displayQuestion(); 
                        }
                        else if (currentQuizIsDiamond && currentQuiz.questions.length < 40) {
                            await waitForNextBatch();
                        }
                        else { 
                            await endQuiz(); 
                        }
                    }, 1200);
                }
            }
        }

        /** Finaliza el quiz */
        async function endQuiz() { 
            clearInterval(quizTimerInterval); 
            quizTimerInterval = null;
            
            document.getElementById('question-container').classList.add('hidden');
            document.getElementById('next-question-loader').classList.add('hidden');
            const endContainer = document.getElementById('end-quiz-container');
            const finalScoreText = document.getElementById('final-score-text');
            const finalTimeText = document.getElementById('final-time-text');
            const finalCoinText = document.getElementById('final-coin-text');
            
            finalScoreText.textContent = `Tu puntaje final es ${score} de ${currentQuizIsDiamond ? 40 : currentQuiz.questions.length}.`;
            finalTimeText.textContent = `Tiempo total: ${timeElapsed.toFixed(2)} segundos.`;
            
            document.getElementById('progress-bar').style.width = '100%';

            const today = getTodayDateString();
            const activityRef = ref(db, `${dbPath}/userActivity/${loggedInUser}`);
            
            let bonusCoins = 0;
            let rewardCoins = 0;
            let coinMessage = "";
            
            const isPerfectScore = (score === (currentQuizIsDiamond ? 40 : currentQuiz.questions.length));

            const goldenPrompt = document.getElementById('golden-mode-prompt');
            const diamondPrompt = document.getElementById('diamond-mode-prompt');
            const viewLeaderboardBtn = document.getElementById('view-leaderboard-btn');

            leaderboardForm.style.display = 'none';
            viewLeaderboardBtn.style.display = 'none';
            goldenPrompt.style.display = 'none';
            diamondPrompt.style.display = 'none';


            if (currentQuizIsDiamond) {
                if (isPerfectScore) {
                    coinMessage = "¡INCREÍBLE! ¡Superaste el Modo Diamante!";
                    leaderboardForm.style.display = 'flex';
                } else {
                    coinMessage = "¡Buen intento! El Modo Diamante es muy difícil.";
                    leaderboardForm.style.display = 'none';
                }

            } else if (currentQuizIsGolden) {
                if (isPerfectScore) {
                    coinMessage = "¡Completaste el Modo Golden!";
                    leaderboardForm.style.display = 'flex';
                    diamondPrompt.style.display = 'block';
                } else {
                    coinMessage = "¡Fallaste el Modo Golden!";
                    leaderboardForm.style.display = 'none';
                    goldenPrompt.style.display = 'block';
                }
            
            } else {
                leaderboardForm.style.display = 'flex';
                goldenPrompt.style.display = 'block';

                try {
                    const transactionResult = await runTransaction(activityRef, (currentData) => {
                        const data = currentData || { 
                            quizzesCreatedToday: 0, 
                            lastQuizCreationDate: null, 
                            lastQuizCompletionDate: null 
                        };
                        
                        const lastCompletion = data.lastQuizCompletionDate;

                        if (lastCompletion !== today) {
                            data.lastQuizCompletionDate = today; 
                            return data; 
                        } else {
                            return undefined; 
                        }
                    });

                    if (transactionResult.committed) {
                        if (isPerfectScore) {
                            const timeTaken = timeElapsed;
                            const maxTime = currentQuiz.questions.length * 20; 
                            bonusCoins = Math.max(0, Math.floor(5 * (1 - timeTaken / maxTime)));
                            
                            if (currentQuiz.ownerUsername !== loggedInUser && currentQuiz.quizType === 'free') {
                                rewardCoins = 2; 
                            }

                            if (bonusCoins > 0) {
                                coinMessage += `¡Puntaje Perfecto! Ganaste ${bonusCoins} monedas por rapidez. `;
                                await awardCoins(loggedInUser, bonusCoins); 
                            }
                            if (rewardCoins > 0) {
                                coinMessage += `(${currentQuiz.ownerUsername} ganó ${rewardCoins} monedas).`;
                                await awardCoins(currentQuiz.ownerUsername, rewardCoins);
                            }
                            if (bonusCoins === 0 && rewardCoins === 0) {
                                coinMessage = "¡Puntaje Perfecto! (Recompensa diaria reclamada)";
                            }
                        } else {
                            coinMessage = "¡Quiz completado! (Necesitas un 100% para la recompensa diaria)";
                        }
                    } else {
                        coinMessage = "Ya has recibido la recompensa diaria por completar un quiz hoy.";
                    }

                } catch (error) {
                    console.error("Error en la transacción de actividad diaria:", error);
                    coinMessage = "Error al verificar la recompensa.";
                }
            }
            
            finalCoinText.textContent = coinMessage.trim();
            
            endContainer.classList.remove('hidden');
        }

        /** Guarda el puntaje */
        async function handleSaveScore(e) {
            e.preventDefault();
            
            if (!currentQuizDocId) {
                showErrorModal("Error: No se puede guardar el puntaje, ID de quiz desconocido.");
                return;
            }

            const playerName = document.getElementById('player-name').value;
            if (!playerName.trim()) { showErrorModal("Por favor, ingresa un nombre."); return; }
            
            const totalQuestions = currentQuizIsDiamond ? 40 : currentQuiz.questions.length;
            if ( (currentQuizIsGolden || currentQuizIsDiamond) && score !== totalQuestions) {
                showErrorModal("Solo los puntajes perfectos (100%) de los Modos Golden y Diamante se guardan.");
                return;
            }

            const leaderboardRef = ref(db, `${dbPath}/leaderboards/${currentQuizDocId}/entries`);
            
            const finalTime = parseFloat(timeElapsed.toFixed(2));
            const newEntry = { 
                name: playerName, 
                score: score, 
                time: finalTime, 
                username: loggedInUser,
                createdAt: new Date().toISOString(),
                isGolden: currentQuizIsGolden,
                isDiamond: currentQuizIsDiamond
            };
            
            try {
                const snapshot = await get(leaderboardRef);
                let entries = [];
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    if (Array.isArray(data)) { entries = data; }
                    else if (typeof data === 'object' && data !== null) { entries = Object.values(data); }
                }

                let existingEntryIndex = -1;
                if (entries.length > 0) {
                    existingEntryIndex = entries.findIndex(entry => 
                        entry.username === newEntry.username && 
                        !!entry.isGolden === newEntry.isGolden &&
                        !!entry.isDiamond === newEntry.isDiamond
                    );
                }

                if (existingEntryIndex !== -1) {
                    const existingEntry = entries[existingEntryIndex];
                    let isNewScoreBetter = false;

                    if (newEntry.score > existingEntry.score) {
                        isNewScoreBetter = true;
                    } else if (newEntry.score === existingEntry.score && newEntry.time < (existingEntry.time || 999)) {
                        isNewScoreBetter = true;
                    }

                    if (isNewScoreBetter) {
                        entries[existingEntryIndex] = newEntry;
                    }
                } else {
                    entries.push(newEntry);
                }
                
                entries.sort((a, b) => {
                    if (a.score !== b.score) { return b.score - a.score; }
                    return (a.time || 999) - (b.time || 999);
                });
                
                const finalEntries = entries.slice(0, 10);
                await set(leaderboardRef, finalEntries); 
                
                const bestEntry = finalEntries.find(entry => !entry.isGolden && !entry.isDiamond);
                const quizRecordRef = ref(db, `${dbPath}/quizzes/${currentQuizDocId}/recordHolder`);
                
                if (bestEntry) {
                    await set(quizRecordRef, {
                        name: bestEntry.name,
                        score: bestEntry.score,
                        time: bestEntry.time
                    });
                } else if (finalEntries.length === 0) {
                     await set(quizRecordRef, null);
                }
                
                leaderboardForm.style.display = 'none';
                document.getElementById('view-leaderboard-btn').style.display = 'flex';

            } catch (error) {
                console.error("Error al guardar puntaje (RTDB): ", error);
                showErrorModal("No se pudo guardar tu puntaje. Inténtalo de nuevo.");
            }
        }
        
        // --- LÓGICA DE AUTENTICACIÓN (Manual) ---

        /** Maneja el formulario de registro */
        async function handleRegister(e) {
            e.preventDefault();
            const username = e.target.username.value.trim();
            const password = e.target.password.value;
            
            if (username.length < 3) {
                showErrorModal("El nombre de usuario debe tener al menos 3 caracteres.");
                return;
            }
            if (password.length < 6) {
                showErrorModal("La contraseña debe tener al menos 6 caracteres.");
                return;
            }

            try {
                const userRef = ref(db, `${dbPath}/users/${username}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    showErrorModal("Ese nombre de usuario ya está en uso. Prueba con otro.");
                    return;
                }
                
                const passwordHash = await hashPassword(password);
                
                await set(userRef, { 
                    passwordHash: passwordHash, 
                    createdAt: new Date().toISOString() 
                });
                
                const walletRef = ref(db, `${dbPath}/wallets/${username}`);
                await set(walletRef, { 
                    coins: 10, 
                    username: username 
                });
                
                localStorage.setItem('quizAppUser', username);
                loggedInUser = username;
                await onLoginSuccess();
                
            } catch (error) {
                console.error("Error al registrar:", error);
                showErrorModal(`Error al registrar: ${error.message}`);
            }
        }

        /** Maneja el formulario de inicio de sesión */
        async function handleLogin(e) {
            e.preventDefault();
            const username = e.target.username.value.trim();
            const password = e.target.password.value;
            
            try {
                const userRef = ref(db, `${dbPath}/users/${username}`);
                const snapshot = await get(userRef);
                
                if (!snapshot.exists()) {
                    showErrorModal("Nombre de usuario o contraseña incorrectos.");
                    return;
                }
                
                const userData = snapshot.val();
                const storedHash = userData.passwordHash;
                const providedHash = await hashPassword(password);
                
                if (storedHash !== providedHash) {
                    showErrorModal("Nombre de usuario o contraseña incorrectos.");
                    return;
                }
                
                localStorage.setItem('quizAppUser', username);
                loggedInUser = username;
                await onLoginSuccess();

            } catch (error) {
                console.error("Error al iniciar sesión:", error);
                showErrorModal(`Error al iniciar sesión: ${error.message}`);
            }
        }
        
        /** Maneja el cierre de sesión */
        function handleSignOut() {
            localStorage.removeItem('quizAppUser');
            loggedInUser = null;
            
            authControls.classList.add('hidden');
            
            if (userWalletListener) {
                userWalletListener();
                userWalletListener = null;
                userWalletRef = null;
            }
            
            showView(VIEWS.AUTH);
        }
        
        /** Acciones a tomar después de un login exitoso */
        async function onLoginSuccess() {
            userNameDisplay.textContent = loggedInUser;
            authControls.classList.remove('hidden');
            setupUserWalletListener(loggedInUser);
            loadQuizzes(); 
            showView(VIEWS.HOME);
        }

        // --- Manejo de Errores y Modales (sin cambios) ---

        function showErrorModal(message) {
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
        }

        function hideErrorModal() {
            errorModal.classList.add('hidden');
        }
        
        function showConfirmModal(title, message, onConfirm) {
            confirmTitle.textContent = title;
            confirmMessage.innerHTML = message;
            
            const newOkBtn = confirmOkBtn.cloneNode(true);
            confirmOkBtn.parentNode.replaceChild(newOkBtn, confirmOkBtn);
            confirmOkBtn = newOkBtn;
            const newCancelBtn = confirmCancelBtn.cloneNode(true);
            confirmCancelBtn.parentNode.replaceChild(newCancelBtn, confirmCancelBtn);
            confirmCancelBtn = newCancelBtn;
            
            confirmOkBtn.addEventListener('click', () => {
                onConfirm();
                confirmModal.classList.add('hidden');
            });
            confirmCancelBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
            });
            confirmModal.classList.remove('hidden');
        }

        // --- Lógica Diamante Progresivo ---

        async function fetchDiamondQuestions(count, avoidList = []) {
            const topic = currentQuiz.topic;
            const category = currentQuiz.category || 'Otros';
            const level = currentQuiz.level || 'General';

            const mistralApiKey = "evxly62Xv91b752fbnHA2I3HD988C5RT";
            const mistralApiUrl = "https://api.mistral.ai/v1/chat/completions";
            const schemaDefinition = `
            {
                "type": "object",
                "properties": {
                    "questions": {
                        "type": "array",
                        "description": "La lista de ${count} preguntas.",
                        "items": {
                            "type": "object",
                            "properties": {
                                "question": { "type": "string" },
                                "options": { "type": "array", "items": { "type": "string" } },
                                "correctAnswer": { "type": "string" }
                            }, "required": ["question", "options", "correctAnswer"]
                        }
                    }
                }, "required": ["questions"]
            }`;
            
            const systemPrompt = `Eres un creador de quizzes experto. Genera un quiz de ${count} preguntas EXTREMADAMENTE DIFÍCILES (nivel experto/universitario) sobre un tema.
Debes responder ÚNICAMENTE con un objeto JSON válido que siga este esquema:
\`\`\`json
${schemaDefinition}
\`\`\`
El array 'options' debe tener exactamente 4 strings. Solo el JSON.`;
            
            let avoidPrompt = "";
            if (avoidList.length > 0) {
                avoidPrompt = `\n\nIMPORTANTE: NO repitas NINGUNA de estas preguntas, ya han sido generadas: "${avoidList.join('; ')}"`;
            }

            const userPrompt = `Genera ${count} preguntas EXTREMADAMENTE DIFÍCILES sobre el tema: "${topic}". Categoría: ${category}. Nivel: ${level}. Que sean un verdadero desafío.${avoidPrompt}`;
            
            const payload = { 
                model: 'mistral-medium-latest', 
                messages: [ 
                    { role: 'system', content: systemPrompt }, 
                    { role: 'user', content: userPrompt } 
                ], 
                response_format: { type: 'json_object' } 
            };
            
            const options = { 
                method: 'POST', 
                headers: { 
                    'Content-Type': 'application/json', 
                    'Authorization': `Bearer ${mistralApiKey}`, 
                    'Accept': 'application/json' 
                }, 
                body: JSON.stringify(payload) 
            };

            const result = await fetchWithRetry(mistralApiUrl, options);
            const jsonText = result.choices[0].message.content;
            const newQuizData = JSON.parse(jsonText);
            
            if (!newQuizData.questions || newQuizData.questions.length === 0) {
                throw new Error("Datos del quiz Diamante incompletos (Lote).");
            }
            return newQuizData.questions;
        }

        async function fetchMoreDiamondQuestions() {
            if (isGeneratingMoreQuestions || !currentQuizIsDiamond || currentQuiz.questions.length >= 40) {
                return;
            }

            isGeneratingMoreQuestions = true;
            console.log("Generando lote de preguntas Diamante en segundo plano...");

            try {
                const count = Math.min(10, 40 - currentQuiz.questions.length);
                const newQuestions = await fetchDiamondQuestions(count, generatedQuestionText);

                currentQuiz.questions.push(...newQuestions);
                generatedQuestionText.push(...newQuestions.map(q => q.question));
                console.log(`Preguntas cargadas. Total ahora: ${currentQuiz.questions.length}`);
                
            } catch (error) {
                console.error("Error al generar lote de Diamante en segundo plano:", error);
            }

            isGeneratingMoreQuestions = false;
        }

        async function waitForNextBatch() {
            document.getElementById('question-container').classList.add('hidden');
            document.getElementById('next-question-loader').classList.remove('hidden');

            while (currentQuestionIndex >= currentQuiz.questions.length) {
                if (!isGeneratingMoreQuestions) {
                    if (currentQuiz.questions.length < 40) {
                        console.warn('Reintentando carga de lote (el jugador está esperando)...');
                        await fetchMoreDiamondQuestions();
                    } else {
                        break;
                    }
                }
                await new Promise(res => setTimeout(res, 500));
            }

            document.getElementById('question-container').classList.remove('hidden');
            document.getElementById('next-question-loader').classList.add('hidden');

            if (currentQuestionIndex < currentQuiz.questions.length) {
                displayQuestion();
            } else {
                await endQuiz();
            }
        }
        
        async function generateDiamondQuestions() {
            if (!currentQuiz) return;
            
            loadingText.textContent = "Generando primeras 10 de 40 preguntas...";
            showView(VIEWS.LOADING);
            
            generatedQuestionText = [];
            isGeneratingMoreQuestions = true;

            try {
                const newQuestions = await fetchDiamondQuestions(10, []);
                
                generatedQuestionText.push(...newQuestions.map(q => q.question));

                const diamondQuiz = {
                    ...currentQuiz,
                    title: currentQuiz.title,
                    questions: newQuestions,
                    id: currentQuiz.id 
                };
                
                isGeneratingMoreQuestions = false;
                
                startQuiz(diamondQuiz, false, true);
                
                fetchMoreDiamondQuestions();

            } catch (error) {
                console.error("Error al generar el quiz Diamante (inicial):", error);
                showErrorModal(`No se pudo generar el quiz Diamante. ${error.message}`);
                showView(VIEWS.PLAY);
                isGeneratingMoreQuestions = false;
            }
        }
        
        // --- Inicialización de la App y Firebase ---

        /** Inicializa los listeners de la UI (se llama una vez) */
        function initAppListeners() {
            lucide.createIcons();

            // Navegación
            homeBtn.addEventListener('click', () => { showView(VIEWS.HOME); });
            document.getElementById('show-create-view-btn').addEventListener('click', () => showView(VIEWS.CREATE));
            document.getElementById('leaderboard-back-btn').addEventListener('click', () => { showView(VIEWS.HOME); });
            
            // Leaderboard General
            document.getElementById('show-general-leaderboard-btn').addEventListener('click', renderGeneralLeaderboard);
            document.getElementById('general-leaderboard-back-btn').addEventListener('click', () => { showView(VIEWS.HOME); });

            // Formularios
            createQuizForm.addEventListener('submit', handleCreateQuiz);
            leaderboardForm.addEventListener('submit', handleSaveScore); 
            
            // Listeners de Auth
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            signOutBtn.addEventListener('click', handleSignOut);

            document.getElementById('start-golden-mode-btn').addEventListener('click', () => {
                startQuiz(quizzes.find(q => q.id === currentQuizDocId), true, false); 
            });
            document.getElementById('start-diamond-mode-btn').addEventListener('click', generateDiamondQuestions);
            
            document.getElementById('view-leaderboard-btn').addEventListener('click', () => {
                if (currentQuizDocId) {
                    renderLeaderboard(currentQuizDocId);
                }
            });

            // Pestañas de Auth
            tabLogin.addEventListener('click', () => {
                tabLogin.classList.add('active');
                tabRegister.classList.remove('active');
                loginFormContainer.classList.remove('hidden');
                registerFormContainer.classList.add('hidden');
            });
            tabRegister.addEventListener('click', () => {
                tabRegister.classList.add('active');
                tabLogin.classList.remove('active');
                registerFormContainer.classList.remove('hidden');
                loginFormContainer.classList.add('hidden');
            });

            // Listeners para el formulario de creación (tipo de quiz)
            const quizTypeRadios = document.querySelectorAll('input[name="quiz-type"]');
            const quizPriceContainer = document.getElementById('quiz-price-container');
            quizTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'paid') {
                        quizPriceContainer.classList.remove('hidden');
                    } else {
                        quizPriceContainer.classList.add('hidden');
                    }
                });
            });

            // Clics delegados en la lista de quizzes
            quizListContainer.addEventListener('click', (e) => {
                const playBtn = e.target.closest('.play-btn');
                if (playBtn) { handlePlayQuizClick(playBtn.dataset.quizId); return; }
                const leaderboardBtn = e.target.closest('.leaderboard-btn');
                if (leaderboardBtn) { renderLeaderboard(leaderboardBtn.dataset.quizId); return; }
            });

            // Modal de error
            closeModalBtn.addEventListener('click', hideErrorModal);

            // **** ¡CAMBIO AQUÍ! (Listener de filtro) ****
            document.getElementById('category-filter').addEventListener('change', renderQuizList);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Configuración de Firebase
            const firebaseConfigFallback = {
                apiKey: "AIzaSyC5v9fm-aHc5LrRWf-Qd3fy4-elcjjhJYw", 
                authDomain: "everyquiz-65c14.firebaseapp.com",
                projectId: "everyquiz-65c14",
                databaseURL: "https://everyquiz-65c14-default-rtdb.europe-west1.firebasedatabase.app/",
                storageBucket: "everyquiz-65c14.firebasestorage.app",
                messagingSenderId: "841737281047",
                appId: "1:841737281047:web:1a8f56177179e3d03a0652"
            };

            const firebaseConfig = typeof __firebase_config !== 'undefined' 
                ? JSON.parse(__firebase_config) 
                : firebaseConfigFallback;

            appId = 'everyquiz-app-test';
            dbPath = sanitizeRtdbPath(appId); 

            confirmModal = document.getElementById('confirm-modal');
            confirmTitle = document.getElementById('confirm-title');
            confirmMessage = document.getElementById('confirm-message');
            confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            confirmOkBtn = document.getElementById('confirm-ok-btn');

            try {
                const app = initializeApp(firebaseConfig);
                db = getDatabase(app); 
                
                initAppListeners();

                const savedUser = localStorage.getItem('quizAppUser');
                if (savedUser) {
                    loggedInUser = savedUser;
                    await onLoginSuccess();
                } else {
                    showView(VIEWS.AUTH);
                }

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                showErrorModal("Error crítico: No se pudo conectar a la base de datos. " + error.message);
            }
        });

    </script>
</body>
</html>
