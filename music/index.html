<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juego del Semáforo Musical</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-database-compat.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1a1a1a;
            color: white;
            overflow: hidden;
            touch-action: none;
        }
        
        .pixel-font {
            font-family: 'Press Start 2P', cursive;
        }

        .hidden { display: none !important; }

        /* Estados del semáforo */
        .bg-safe { background-color: #16a34a; }
        .bg-danger { background-color: #dc2626; }
        
        .pulse-green { animation: pulse-g 1s infinite; }
        .pulse-red { animation: pulse-r 0.5s infinite; }

        @keyframes pulse-g { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes pulse-r { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
    </style>
</head>
<body>

    <!-- VISTA: SELECCIÓN DE ROL -->
    <div id="view-landing" class="h-screen w-full flex flex-col items-center justify-center p-4 space-y-8">
        <h1 class="text-4xl md:text-6xl font-bold text-center pixel-font text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-red-500 mb-8 leading-tight">
            LUZ ROJA<br>MUSICAL
        </h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
            <button onclick="app.setRole('screen')" class="flex flex-col items-center justify-center p-8 bg-neutral-800 border-2 border-pink-500 rounded-xl hover:bg-neutral-700 transition-all hover:scale-105">
                <i data-lucide="monitor" class="w-16 h-16 text-pink-500 mb-4"></i>
                <span class="text-2xl font-bold">PANTALLA</span>
                <span class="text-sm text-gray-400 mt-2">Para TV / PC</span>
            </button>
            <button onclick="app.setRole('player')" class="flex flex-col items-center justify-center p-8 bg-neutral-800 border-2 border-green-500 rounded-xl hover:bg-neutral-700 transition-all hover:scale-105">
                <i data-lucide="smartphone" class="w-16 h-16 text-green-500 mb-4"></i>
                <span class="text-2xl font-bold">JUGADOR</span>
                <span class="text-sm text-gray-400 mt-2">Para Móvil</span>
            </button>
        </div>
    </div>

    <!-- VISTA: PANTALLA (HOST) -->
    <div id="view-screen" class="hidden h-screen w-full flex flex-col relative bg-neutral-900">
        <!-- Header -->
        <div class="absolute top-0 w-full p-4 flex justify-between items-center z-10 bg-neutral-900/90 backdrop-blur border-b border-white/10">
            <div class="text-2xl font-bold text-pink-500 pixel-font">SALA: <span id="host-session-code" class="text-white">...</span></div>
            <div class="flex space-x-6 text-xl font-bold">
                <div class="flex items-center text-green-400"><i data-lucide="activity" class="mr-2"></i> <span id="host-alive-count">0</span></div>
                <div class="flex items-center text-red-500"><i data-lucide="skull" class="mr-2"></i> <span id="host-dead-count">0</span></div>
            </div>
        </div>

        <!-- Contenido Central Host -->
        <div class="flex-1 flex flex-col items-center justify-center p-4">
            
            <!-- Estado: LOBBY -->
            <div id="host-lobby" class="text-center flex flex-col items-center">
                <div class="bg-white p-4 rounded-xl shadow-2xl mb-6">
                    <img id="host-qr-img" src="" alt="QR Code" class="w-64 h-64 object-contain">
                </div>
                <h2 class="text-3xl font-bold mb-2">Escanea para unirte</h2>
                <p class="text-gray-400 mb-8 text-xl">Jugadores listos: <span id="host-lobby-count">0</span></p>
                <button id="btn-start-game" onclick="host.startGame()" disabled class="px-10 py-5 bg-gradient-to-r from-pink-600 to-red-600 rounded-full text-2xl font-bold hover:scale-105 disabled:opacity-50 disabled:grayscale transition-all shadow-lg shadow-pink-900/50">
                    EMPEZAR JUEGO
                </button>
            </div>

            <!-- Estado: JUEGO -->
            <div id="host-game" class="hidden w-full h-full flex items-center justify-center flex-col">
                <div id="traffic-light" class="w-80 h-80 rounded-full flex items-center justify-center border-8 transition-all duration-200 bg-neutral-800 border-neutral-600">
                    <!-- Icono dinámico se inyecta aquí -->
                </div>
                <h2 id="host-status-text" class="text-5xl font-black mt-8 tracking-wider">PREPARADOS</h2>
            </div>

            <!-- Estado: GANADOR -->
            <div id="host-winner" class="hidden text-center animate-bounce">
                <i data-lucide="trophy" class="w-40 h-40 text-yellow-400 mx-auto mb-4"></i>
                <h2 class="text-4xl text-yellow-400 font-bold mb-2">GANADOR</h2>
                <div id="winner-name" class="text-6xl font-black text-white mb-8">NOMBRE</div>
                <button onclick="host.resetGame()" class="px-6 py-3 bg-neutral-700 rounded text-white font-bold hover:bg-neutral-600">Volver al Lobby</button>
            </div>
        </div>

        <!-- Footer Jugadores -->
        <div class="h-auto max-h-48 min-h-[5rem] bg-neutral-800 border-t border-neutral-700 p-4 overflow-y-auto">
            <div id="host-players-list" class="flex flex-wrap gap-3 justify-center">
                <!-- Chips de jugadores -->
            </div>
        </div>
    </div>

    <!-- VISTA: JUGADOR (LOGIN) -->
    <div id="view-player-join" class="hidden h-screen w-full flex flex-col items-center justify-center p-6 space-y-6 bg-black">
        <div class="text-center mb-4">
            <h1 class="text-3xl font-bold text-pink-500 pixel-font mb-2">UNIRSE</h1>
            <p class="text-gray-400">Introduce tus datos</p>
        </div>
        <input type="text" id="inp-player-name" placeholder="TU NOMBRE" maxlength="10" class="w-full max-w-xs bg-neutral-800 border-2 border-neutral-600 p-4 rounded text-center text-xl text-white uppercase focus:border-pink-500 outline-none">
        <input type="text" id="inp-session-code" placeholder="CÓDIGO SALA" maxlength="4" class="w-full max-w-xs bg-neutral-800 border-2 border-neutral-600 p-4 rounded text-center text-xl text-white uppercase focus:border-pink-500 outline-none">
        <button onclick="player.join()" class="w-full max-w-xs bg-green-600 hover:bg-green-500 p-4 rounded font-bold text-xl shadow-lg shadow-green-900/50 transition-transform active:scale-95">
            ENTRAR
        </button>
    </div>

    <!-- VISTA: JUGADOR (PERMISO SENSORES) -->
    <div id="view-player-sensor" class="hidden h-screen w-full flex flex-col items-center justify-center p-6 text-center bg-black">
        <i data-lucide="smartphone" class="w-20 h-20 text-yellow-500 mb-6 animate-pulse"></i>
        <h2 class="text-2xl font-bold mb-4">Activa los Sensores</h2>
        <p class="text-gray-400 mb-8 max-w-xs mx-auto">El juego necesita acceso al acelerómetro para saber si te mueves.</p>
        <button onclick="player.requestPermissions()" class="bg-yellow-500 text-black px-8 py-4 rounded-full font-bold text-xl shadow-lg shadow-yellow-500/20">
            ACTIVAR Y JUGAR
        </button>
    </div>

    <!-- VISTA: JUGADOR (JUEGO) -->
    <div id="view-player-game" class="hidden h-screen w-full flex flex-col items-center justify-center transition-colors duration-200 bg-neutral-900 relative">
        
        <!-- Pantalla: ESPERANDO (Lobby) -->
        <div id="p-screen-waiting" class="text-center">
            <div class="animate-spin mb-6 mx-auto"><i data-lucide="loader" class="w-16 h-16 text-blue-500"></i></div>
            <h2 class="text-3xl font-bold mb-2">Esperando al Host...</h2>
            <p class="text-blue-300">Mantente preparado</p>
        </div>

        <!-- Pantalla: ACTIVO (Corre/Quieto) -->
        <div id="p-screen-active" class="hidden text-center w-full h-full flex flex-col items-center justify-center">
            <div id="p-icon-container" class="mb-6 transform transition-transform duration-200">
                <!-- Icono -->
            </div>
            <h1 id="p-status-text" class="text-6xl font-black text-white drop-shadow-lg">...</h1>
            <p id="p-sub-text" class="text-xl mt-4 font-bold opacity-80">...</p>
        </div>

        <!-- Pantalla: MUERTO -->
        <div id="p-screen-dead" class="hidden text-center animate-pulse bg-red-950 absolute inset-0 flex flex-col items-center justify-center z-50">
            <i data-lucide="skull" class="w-32 h-32 text-red-500 mb-4"></i>
            <h1 class="text-5xl font-black text-red-500 mb-2">ELIMINADO</h1>
            <p class="text-red-300">Te has movido</p>
        </div>

        <!-- Pantalla: VICTORIA -->
        <div id="p-screen-win" class="hidden text-center bg-yellow-900 absolute inset-0 flex flex-col items-center justify-center z-50">
            <i data-lucide="trophy" class="w-32 h-32 text-yellow-400 mb-4 animate-bounce"></i>
            <h1 class="text-5xl font-black text-yellow-400 mb-2">¡VICTORIA!</h1>
            <p class="text-yellow-100">Has sobrevivido</p>
        </div>

        <!-- Debug Info (Oculto) -->
        <div id="debug-acc" class="absolute bottom-2 right-2 text-xs text-white/30 font-mono"></div>
    </div>

    <script>
        // --- CONFIGURACIÓN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBMYTnk-CljdWENtDQqqKUBmQzBQuoxYPo",
            authDomain: "hello-74404.firebaseapp.com",
            databaseURL: "https://hello-74404-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "hello-74404",
            storageBucket: "hello-74404.firebasestorage.app",
            messagingSenderId: "781363507648",
            appId: "1:781363507648:web:5c7b871f11b9010bfd1825"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- UTILIDADES ---
        const $ = (id) => document.getElementById(id);
        const APP_ID = "music-game-v1";
        
        // Sonidos
        const SONGS = ['song1.mp3', 'song2.mp3', 'song3.mp3']; // Deben estar en la misma carpeta o usar URLs completas
        const GUNSHOT_URL = "https://library.penguinmod.com/files/sounds/gunshot3.mp3";
        
        let localUid = localStorage.getItem('mg_uid') || 'u_' + Date.now().toString(36);
        localStorage.setItem('mg_uid', localUid);

        // Audio
        let currentMusic = null;
        const gunshotAudio = new Audio(GUNSHOT_URL);

        // --- LÓGICA DE APLICACIÓN CENTRAL ---
        const app = {
            role: null,
            sessionId: null,

            init: function() {
                const params = new URLSearchParams(window.location.search);
                const urlSession = params.get('session');
                const urlRole = params.get('role');

                if (urlSession && urlRole) {
                    this.sessionId = urlSession.toUpperCase();
                    this.setRole(urlRole);
                    if (urlRole === 'player') {
                        $('inp-session-code').value = this.sessionId;
                    }
                } else {
                    this.showView('view-landing');
                }
                lucide.createIcons();
            },

            setRole: function(role) {
                this.role = role;
                if (role === 'screen') {
                    host.init();
                } else {
                    player.init();
                }
            },

            showView: function(viewId) {
                document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
                $(viewId).classList.remove('hidden');
            }
        };

        // --- LÓGICA DEL HOST (PANTALLA) ---
        const host = {
            players: {},
            gameState: 'waiting', // waiting, playing, ended
            musicPlaying: false,

            init: function() {
                // Generar o usar Session ID
                if (!app.sessionId) {
                    app.sessionId = Math.random().toString(36).substring(2, 6).toUpperCase();
                    const newUrl = `?session=${app.sessionId}&role=screen`;
                    window.history.replaceState(null, '', newUrl);
                }
                
                $('host-session-code').innerText = app.sessionId;
                app.showView('view-screen');

                // Generar QR (Negro sobre blanco para contraste)
                const joinUrl = `${window.location.origin}${window.location.pathname}?session=${app.sessionId}&role=player`;
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(joinUrl)}&bgcolor=ffffff&color=000000&margin=10`;
                $('host-qr-img').src = qrUrl;

                this.setupListeners();
                this.resetDB();
            },

            resetDB: function() {
                // Inicializar sesión en DB
                db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}`).update({
                    state: 'waiting',
                    musicPlaying: false,
                    host: localUid,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            },

            setupListeners: function() {
                // Escuchar Jugadores
                db.ref(`artifacts/${APP_ID}/public/data/players`).on('value', snap => {
                    const allPlayers = snap.val() || {};
                    this.players = {};
                    
                    // Filtrar solo los de esta sesión
                    Object.entries(allPlayers).forEach(([key, p]) => {
                        if (p.sessionId === app.sessionId) {
                            this.players[key] = p;
                        }
                    });
                    this.renderPlayers();
                });

                // Escuchar estado del juego (para actualizar si hay cambios externos)
                db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}`).on('value', snap => {
                    const data = snap.val();
                    if(data) {
                        this.gameState = data.state;
                        this.musicPlaying = data.musicPlaying;
                        this.updateUI();
                    }
                });
            },

            renderPlayers: function() {
                const list = $('host-players-list');
                list.innerHTML = '';
                
                const playersArr = Object.values(this.players);
                $('host-lobby-count').innerText = playersArr.length;
                
                const alive = playersArr.filter(p => p.isAlive).length;
                const dead = playersArr.filter(p => !p.isAlive).length;
                
                $('host-alive-count').innerText = alive;
                $('host-dead-count').innerText = dead;

                // Habilitar botón empezar si hay jugadores
                $('btn-start-game').disabled = playersArr.length === 0;

                playersArr.forEach(p => {
                    const div = document.createElement('div');
                    div.className = `px-3 py-1 rounded-full text-sm font-bold flex items-center border ${p.isAlive ? 'bg-green-900 text-green-300 border-green-600' : 'bg-red-900/50 text-red-500 border-red-800 line-through opacity-60'}`;
                    div.innerText = p.name;
                    list.appendChild(div);
                });

                this.checkWinCondition(alive, playersArr.length);
            },

            startGame: function() {
                // Revivir a todos los jugadores en la DB
                const updates = {};
                Object.keys(this.players).forEach(pid => {
                    updates[`artifacts/${APP_ID}/public/data/players/${pid}/isAlive`] = true;
                });
                updates[`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}/state`] = 'playing';
                updates[`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}/musicPlaying`] = true; // Empieza con música
                
                db.ref().update(updates);
                
                // Iniciar lógica de audio
                this.startMusic();
                this.scheduleToggle();
            },

            scheduleToggle: function() {
                if (this.gameState !== 'playing') return;

                const aliveCount = Object.values(this.players).filter(p => p.isAlive).length;

                // Tiempos más largos como solicitado
                // Música sonando: entre 5 y 12 segundos (antes era 2-5)
                let min = this.musicPlaying ? 5000 : 3000; 
                let max = this.musicPlaying ? 12000 : 6000;

                // FINAL SHOWDOWN: Si quedan 2 jugadores y hay música, hacer ronda más larga
                if (aliveCount <= 2 && this.musicPlaying) {
                     min = 10000; // Mínimo 10 segundos
                     max = 20000; // Máximo 20 segundos
                }

                const duration = Math.random() * (max - min) + min;

                setTimeout(() => {
                    if (this.gameState !== 'playing') return;
                    this.toggleMusic(!this.musicPlaying);
                }, duration);
            },

            toggleMusic: function(shouldPlay) {
                const updates = {
                    musicPlaying: shouldPlay
                };
                if (!shouldPlay) {
                    updates.lastStop = firebase.database.ServerValue.TIMESTAMP;
                }
                
                db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}`).update(updates)
                .then(() => {
                    if (shouldPlay) this.startMusic();
                    else this.stopMusic();
                    
                    this.scheduleToggle();
                });
            },

            startMusic: function() {
                // Lógica de elección de canción
                const aliveCount = Object.values(this.players).filter(p => p.isAlive).length;
                let songToPlay;

                // Si quedan 2 personas o menos, forzar canción 3 (Tensión final)
                if (aliveCount <= 2) {
                    songToPlay = 'song3.mp3';
                } else {
                    // Elegir canción aleatoria entre las 3
                    songToPlay = SONGS[Math.floor(Math.random() * SONGS.length)];
                }
                
                if (currentMusic) {
                    currentMusic.pause();
                    currentMusic = null;
                }

                currentMusic = new Audio(songToPlay);
                currentMusic.loop = true;
                currentMusic.play().catch(e => console.log("Error reproduciendo música (interacción requerida):", e));
            },

            stopMusic: function() {
                if (currentMusic) {
                    currentMusic.pause();
                    currentMusic.currentTime = 0;
                    // No ponemos currentMusic a null para poder reutilizarlo si quisiéramos, 
                    // pero en startMusic creamos uno nuevo para cambiar de canción.
                }
            },

            checkWinCondition: function(aliveCount, totalCount) {
                if (this.gameState === 'playing' && totalCount > 0) {
                    if (aliveCount === 1 && totalCount > 1) {
                         // Ganador único
                         const winner = Object.values(this.players).find(p => p.isAlive);
                         this.endGame(winner ? winner.name : 'Nadie');
                    } else if (aliveCount === 0) {
                        this.endGame('NADIE');
                    }
                }
            },

            endGame: function(winnerName) {
                db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}`).update({
                    state: 'ended',
                    musicPlaying: false,
                    winner: winnerName
                });
                this.stopMusic();
            },

            resetGame: function() {
                // Al volver al lobby, revivimos a todos
                const updates = {};
                updates[`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}/state`] = 'waiting';
                updates[`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}/musicPlaying`] = false;
                
                // Revivir jugadores
                Object.keys(this.players).forEach(pid => {
                     updates[`artifacts/${APP_ID}/public/data/players/${pid}/isAlive`] = true;
                });

                db.ref().update(updates);
            },

            updateUI: function() {
                // Controlar visibilidad de secciones
                if (this.gameState === 'waiting') {
                    $('host-lobby').classList.remove('hidden');
                    $('host-game').classList.add('hidden');
                    $('host-winner').classList.add('hidden');
                } else if (this.gameState === 'playing') {
                    $('host-lobby').classList.add('hidden');
                    $('host-game').classList.remove('hidden');
                    $('host-winner').classList.add('hidden');

                    const light = $('traffic-light');
                    const text = $('host-status-text');

                    if (this.musicPlaying) {
                        light.className = "w-80 h-80 rounded-full flex items-center justify-center border-8 transition-all duration-200 bg-green-600 border-green-400 pulse-green shadow-[0_0_50px_rgba(34,197,94,0.6)]";
                        light.innerHTML = `<i data-lucide="play" class="w-40 h-40 text-white"></i>`;
                        text.innerText = "¡CORRE!";
                        text.className = "text-5xl font-black mt-8 tracking-wider text-green-500";
                    } else {
                        light.className = "w-80 h-80 rounded-full flex items-center justify-center border-8 transition-all duration-200 bg-red-600 border-red-400 pulse-red shadow-[0_0_50px_rgba(220,38,38,0.6)]";
                        light.innerHTML = `<i data-lucide="octagon" class="w-40 h-40 text-white"></i>`;
                        text.innerText = "¡QUIETO!";
                        text.className = "text-5xl font-black mt-8 tracking-wider text-red-500";
                    }
                    lucide.createIcons();
                } else if (this.gameState === 'ended') {
                    $('host-game').classList.add('hidden');
                    $('host-winner').classList.remove('hidden');
                    // Obtener ganador de la DB si es necesario, pero ya lo pasamos antes
                    db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}/winner`).once('value', s => {
                        $('winner-name').innerText = s.val() || '...';
                    });
                }
            }
        };

        // --- LÓGICA DEL JUGADOR ---
        const player = {
            isAlive: true,
            init: function() {
                // Si ya tenemos sesión en URL, mostramos join pre-relleno
                $('inp-session-code').value = app.sessionId || '';
                app.showView('view-player-join');
            },

            join: function() {
                const name = $('inp-player-name').value.trim().toUpperCase();
                const code = $('inp-session-code').value.trim().toUpperCase();

                if (!name || !code) return alert("Rellena todos los campos");

                app.sessionId = code;
                
                // Guardar jugador en DB
                const playerRef = db.ref(`artifacts/${APP_ID}/public/data/players/${localUid}`);
                playerRef.set({
                    name: name,
                    sessionId: code,
                    isAlive: true,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    app.showView('view-player-sensor');
                }).catch(e => {
                    alert("Error conexión: " + e.message);
                });
            },

            requestPermissions: function() {
                // Permisos para iOS 13+
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') {
                                this.enterGame();
                            } else {
                                alert("Permiso denegado. No puedes jugar sin sensores.");
                            }
                        })
                        .catch(console.error);
                } else {
                    this.enterGame();
                }
            },

            enterGame: function() {
                app.showView('view-player-game');
                this.setupListeners();
                this.startMotionDetection();
            },

            setupListeners: function() {
                // Escuchar mi estado (vivo/muerto)
                db.ref(`artifacts/${APP_ID}/public/data/players/${localUid}`).on('value', s => {
                    const p = s.val();
                    if (p) {
                        this.isAlive = p.isAlive;
                        this.updateScreen();
                    }
                });

                // Escuchar la sesión (estado del juego, música)
                db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}`).on('value', s => {
                    const sess = s.val();
                    if (sess) {
                        this.sessionData = sess;
                        // Si el juego pasa a waiting, revivimos localmente
                        if (sess.state === 'waiting' && !this.isAlive) {
                            // En realidad la DB lo actualiza el host, pero por si acaso
                        }
                        this.updateScreen();
                    }
                });
            },

            updateScreen: function() {
                const sess = this.sessionData;
                const container = $('view-player-game');
                
                // Reset views
                $('p-screen-waiting').classList.add('hidden');
                $('p-screen-active').classList.add('hidden');
                $('p-screen-dead').classList.add('hidden');
                $('p-screen-win').classList.add('hidden');
                container.className = "h-screen w-full flex flex-col items-center justify-center transition-colors duration-200 bg-neutral-900 relative";

                if (!sess) return; // Cargando

                // 1. Muerto
                if (!this.isAlive) {
                    $('p-screen-dead').classList.remove('hidden');
                    if (navigator.vibrate) navigator.vibrate(200);
                    return;
                }

                // 2. Ganador
                if (sess.state === 'ended') {
                    if (sess.winner !== 'NADIE') {
                        $('p-screen-win').classList.remove('hidden');
                    } else {
                        $('p-screen-dead').classList.remove('hidden'); // Todos murieron
                    }
                    return;
                }

                // 3. Waiting (Lobby)
                if (sess.state === 'waiting') {
                    $('p-screen-waiting').classList.remove('hidden');
                    return;
                }

                // 4. Playing
                if (sess.state === 'playing') {
                    $('p-screen-active').classList.remove('hidden');
                    const icon = $('p-icon-container');
                    const mainText = $('p-status-text');
                    const subText = $('p-sub-text');

                    if (sess.musicPlaying) {
                        // VERDE
                        container.className = "h-screen w-full flex flex-col items-center justify-center transition-colors duration-200 bg-safe relative";
                        icon.innerHTML = `<i data-lucide="play" class="w-32 h-32 text-white"></i>`;
                        icon.className = "mb-6 transform scale-110";
                        mainText.innerText = "CORRE";
                        subText.innerText = "La música suena";
                    } else {
                        // ROJO
                        container.className = "h-screen w-full flex flex-col items-center justify-center transition-colors duration-100 bg-danger relative";
                        icon.innerHTML = `<i data-lucide="octagon" class="w-32 h-32 text-white"></i>`;
                        icon.className = "mb-6 transform scale-100";
                        mainText.innerText = "¡QUIETO!";
                        subText.innerText = "No te muevas";
                        if (navigator.vibrate) navigator.vibrate(50);
                    }
                    lucide.createIcons();
                }
            },

            startMotionDetection: function() {
                window.addEventListener('devicemotion', (event) => {
                    if (!this.isAlive || !this.sessionData || this.sessionData.state !== 'playing') return;
                    
                    // Si hay música, estamos a salvo
                    if (this.sessionData.musicPlaying) return;

                    // Tiempo de gracia (400ms)
                    const lastStop = this.sessionData.lastStop || 0;
                    if (Date.now() - lastStop < 400) return;

                    // Calcular aceleración
                    let acc = 0;
                    if (event.acceleration) {
                        acc = Math.sqrt(
                            Math.pow(event.acceleration.x || 0, 2) + 
                            Math.pow(event.acceleration.y || 0, 2) + 
                            Math.pow(event.acceleration.z || 0, 2)
                        );
                    } else if (event.accelerationIncludingGravity) {
                         const g = event.accelerationIncludingGravity;
                         // Quitar gravedad aprox
                         acc = Math.abs(Math.sqrt(g.x*g.x + g.y*g.y + g.z*g.z) - 9.8);
                    }

                    // Debug
                    //$('debug-acc').innerText = acc.toFixed(2);

                    // Umbral (ajustar sensibilidad) - BAJADO para aumentar sensibilidad
                    if (acc > 0.8) {
                        this.die();
                    }
                });
            },

            die: function() {
                this.isAlive = false;
                gunshotAudio.play().catch(e => console.log(e));
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                
                // Actualizar DB
                db.ref(`artifacts/${APP_ID}/public/data/players/${localUid}`).update({ isAlive: false });
                this.updateScreen();
            }
        };

        // Arrancar app
        app.init();

    </script>
</body>
</html>
