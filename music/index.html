<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juego del Semáforo Musical</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-database-compat.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');
        
        :root {
            --squid-pink: #ed1b76;
            --squid-green: #037a76; /* Darker green for contrast */
            --squid-green-light: #249f9c;
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: #000;
            color: white;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }
        
        .title-font {
            font-family: 'Orbitron', sans-serif;
        }

        .hidden { display: none !important; }

        /* Background Animated */
        .bg-grid {
            background-size: 40px 40px;
            background-image: radial-gradient(circle, #333 1px, transparent 1px);
            opacity: 0.2;
        }

        /* Glassmorphism Panels */
        .glass-panel {
            background: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        /* Status Styles */
        .status-safe { 
            box-shadow: inset 0 0 100px rgba(34, 197, 94, 0.2); 
            border-color: #22c55e;
        }
        .status-danger { 
            box-shadow: inset 0 0 100px rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
        }
        
        /* Animations */
        @keyframes heartbeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .animate-heartbeat { animation: heartbeat 1.5s infinite; }

        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
        .animate-glitch { animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite; }

        #flash-overlay { transition: opacity 0.05s ease-out; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden bg-black text-white relative">

    <!-- GLOBAL AUDIO MANAGER (Hidden) -->
    <div id="audio-status" class="fixed top-2 right-2 text-[10px] text-gray-700 z-50 pointer-events-none">AUDIO OFF</div>

    <!-- FLASH OVERLAY -->
    <div id="flash-overlay" class="fixed inset-0 z-[100] bg-red-600 mix-blend-lighten pointer-events-none opacity-0"></div>

    <!-- BACKGROUND -->
    <div class="fixed inset-0 bg-grid pointer-events-none z-0"></div>

    <!-- VISTA: SELECCIÓN DE ROL -->
    <div id="view-landing" class="h-full w-full flex flex-col items-center justify-center p-6 relative z-10">
        <div class="mb-12 text-center space-y-4">
            <div class="flex justify-center space-x-4 text-6xl text-gray-700 mb-4 opacity-50">
                <span>○</span><span>△</span><span>□</span>
            </div>
            <h1 class="text-6xl md:text-8xl font-black title-font text-transparent bg-clip-text bg-gradient-to-br from-[#ed1b76] to-[#ff5252] drop-shadow-lg tracking-tighter">
                RED LIGHT
            </h1>
            <p class="text-xl tracking-[0.5em] text-gray-400 uppercase">Survival Game</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl">
            <button onclick="app.setRole('screen')" class="group relative p-1 glass-panel rounded-2xl transition-all duration-300 hover:scale-105 hover:shadow-[0_0_40px_rgba(237,27,118,0.4)]">
                <div class="absolute inset-0 bg-[#ed1b76] opacity-0 group-hover:opacity-10 rounded-2xl transition-opacity"></div>
                <div class="p-10 flex flex-col items-center">
                    <i data-lucide="monitor" class="w-20 h-20 text-[#ed1b76] mb-6"></i>
                    <span class="text-3xl font-bold title-font">PANTALLA (TV)</span>
                    <span class="text-sm text-gray-500 mt-2 font-mono">Modo Host</span>
                </div>
            </button>

            <button onclick="app.setRole('player')" class="group relative p-1 glass-panel rounded-2xl transition-all duration-300 hover:scale-105 hover:shadow-[0_0_40px_rgba(36,159,156,0.4)]">
                <div class="absolute inset-0 bg-[#249f9c] opacity-0 group-hover:opacity-10 rounded-2xl transition-opacity"></div>
                <div class="p-10 flex flex-col items-center">
                    <i data-lucide="smartphone" class="w-20 h-20 text-[#249f9c] mb-6"></i>
                    <span class="text-3xl font-bold title-font">JUGADOR</span>
                    <span class="text-sm text-gray-500 mt-2 font-mono">Unirse con Móvil</span>
                </div>
            </button>
        </div>
    </div>

    <!-- VISTA: PANTALLA (HOST) -->
    <div id="view-screen" class="hidden h-full w-full flex flex-col relative bg-neutral-900 z-10">
        <!-- Header -->
        <div class="absolute top-0 w-full p-6 flex justify-between items-center z-20">
            <div class="glass-panel px-6 py-3 rounded-full flex items-center space-x-4">
                <span class="text-gray-400 text-sm">SALA</span>
                <span id="host-session-code" class="text-4xl font-bold title-font text-[#ed1b76] tracking-widest">...</span>
            </div>
            <div class="flex space-x-4">
                <div class="glass-panel px-6 py-3 rounded-full flex items-center text-[#249f9c]">
                    <i data-lucide="users" class="mr-3"></i> <span id="host-alive-count" class="text-2xl font-bold">0</span>
                </div>
                <div class="glass-panel px-6 py-3 rounded-full flex items-center text-[#ed1b76]">
                    <i data-lucide="skull" class="mr-3"></i> <span id="host-dead-count" class="text-2xl font-bold">0</span>
                </div>
            </div>
        </div>

        <!-- Contenido Central Host -->
        <div class="flex-1 flex flex-col items-center justify-center p-4 relative w-full">
            
            <!-- Estado: LOBBY -->
            <div id="host-lobby" class="flex flex-col items-center justify-center w-full animate-fade-in">
                <div class="bg-white p-4 rounded-xl mb-8 transform hover:scale-105 transition-transform duration-500">
                    <img id="host-qr-img" src="" alt="QR Code" class="w-72 h-72 object-contain">
                </div>
                <h2 class="text-5xl font-black mb-4 title-font tracking-tighter">ESCANEA EL CÓDIGO</h2>
                <p class="text-gray-400 mb-12 text-xl">Esperando jugadores...</p>
                
                <button id="btn-start-game" onclick="host.startGame()" disabled class="group relative px-12 py-6 bg-[#ed1b76] rounded-lg text-3xl font-bold title-font transition-all disabled:opacity-50 disabled:grayscale overflow-hidden">
                    <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                    <span class="relative">EMPEZAR JUEGO</span>
                </button>
            </div>

            <!-- Estado: JUEGO -->
            <div id="host-game" class="hidden w-full h-full flex flex-col items-center justify-center">
                <!-- Doll/Traffic Light Representation -->
                <div id="traffic-light-wrapper" class="relative mb-12 transition-transform duration-500">
                    <div id="traffic-light-ring" class="absolute -inset-4 rounded-full border-4 border-dashed border-gray-700 animate-[spin_10s_linear_infinite]"></div>
                    <div id="traffic-light" class="w-80 h-80 rounded-full flex items-center justify-center border-[10px] bg-neutral-900 transition-colors duration-200 shadow-2xl relative z-10">
                        <i id="traffic-icon" data-lucide="eye" class="w-40 h-40 text-gray-500 transition-colors duration-200"></i>
                    </div>
                </div>
                
                <h2 id="host-status-text" class="text-9xl font-black tracking-widest title-font transition-colors duration-200">ESPERA</h2>
            </div>

            <!-- Estado: RESULTADOS -->
            <div id="host-round-results" class="hidden w-full h-full flex flex-col items-center justify-start pt-32 px-10">
                <h2 class="text-6xl font-black mb-12 text-[#ed1b76] title-font border-b-4 border-[#ed1b76] pb-4">ELIMINACIÓN</h2>
                <div id="results-grid" class="w-full max-w-6xl grid grid-cols-1 gap-4 overflow-y-auto max-h-[60vh] pr-4 scrollbar-hide">
                    <!-- Filas dinámicas -->
                </div>

                <!-- Overlay Eliminado -->
                <div id="eliminated-overlay" class="absolute inset-0 z-50 bg-black/90 flex flex-col items-center justify-center hidden backdrop-blur-md">
                    <div class="animate-glitch text-center">
                        <h1 class="text-[10rem] leading-none font-black text-[#ed1b76] title-font mb-4">ELIMINADO</h1>
                        <div class="w-full h-2 bg-[#ed1b76] mb-8"></div>
                        <h2 id="eliminated-name" class="text-7xl font-mono text-white bg-neutral-800 px-8 py-4 inline-block rounded border border-[#ed1b76]">JUGADOR</h2>
                    </div>
                </div>
            </div>

            <!-- Estado: GANADOR -->
            <div id="host-winner" class="hidden flex flex-col items-center justify-center animate-fade-in-up">
                <i data-lucide="crown" class="w-48 h-48 text-yellow-400 mb-8 animate-bounce"></i>
                <h2 class="text-6xl font-bold text-yellow-500 mb-6 title-font tracking-widest">GANADOR</h2>
                <div id="winner-name" class="text-9xl font-black text-white mb-12 title-font">NOMBRE</div>
                <div class="text-gray-500 font-mono animate-pulse">Reiniciando sistema de juego...</div>
            </div>
        </div>

        <!-- Footer -->
        <div class="absolute bottom-0 w-full p-6 bg-gradient-to-t from-black to-transparent z-20">
            <div id="host-players-list" class="flex flex-wrap gap-3 justify-center max-h-32 overflow-hidden mask-fade-bottom"></div>
        </div>
    </div>

    <!-- VISTA: JUGADOR (LOGIN) -->
    <div id="view-player-join" class="hidden h-full w-full flex flex-col items-center justify-center p-6 bg-neutral-900 z-20">
        <div class="w-full max-w-sm space-y-8">
            <div class="text-center space-y-2">
                <div class="flex justify-center space-x-2 text-2xl text-[#ed1b76] mb-4">
                    <span>○</span><span>△</span><span>□</span>
                </div>
                <h1 class="text-4xl font-bold text-white title-font">INGRESO</h1>
            </div>
            <div class="space-y-4">
                <input type="text" id="inp-player-name" placeholder="NOMBRE" maxlength="10" class="w-full bg-black/50 border border-gray-700 p-4 rounded text-center text-2xl text-white uppercase focus:border-[#ed1b76] focus:outline-none transition-colors font-mono">
                <input type="text" id="inp-session-code" placeholder="CÓDIGO" maxlength="4" class="w-full bg-black/50 border border-gray-700 p-4 rounded text-center text-2xl text-white uppercase focus:border-[#ed1b76] focus:outline-none transition-colors font-mono tracking-widest">
            </div>
            <button onclick="player.join()" class="w-full bg-[#ed1b76] hover:bg-pink-700 text-white p-4 rounded font-bold text-xl transition-all active:scale-95 shadow-lg shadow-pink-900/50">
                ENTRAR
            </button>
        </div>
    </div>

    <!-- VISTA: JUGADOR (PERMISO) -->
    <div id="view-player-sensor" class="hidden h-full w-full flex flex-col items-center justify-center p-8 text-center bg-black z-20">
        <i data-lucide="smartphone" class="w-24 h-24 text-yellow-500 mb-6 animate-pulse"></i>
        <h2 class="text-3xl font-bold mb-4 font-mono text-yellow-500">CALIBRACIÓN</h2>
        <p class="text-gray-400 mb-12">Requiere acceso a sensores de movimiento para jugar.</p>
        <button onclick="player.requestPermissions()" class="bg-yellow-500 text-black px-10 py-4 rounded font-bold text-xl w-full max-w-xs">
            AUTORIZAR
        </button>
    </div>

    <!-- VISTA: JUGADOR (JUEGO) -->
    <div id="view-player-game" class="hidden h-full w-full flex flex-col items-center justify-center transition-colors duration-300 bg-neutral-900 relative overflow-hidden z-10">
        
        <!-- Pantalla: ESPERANDO -->
        <div id="p-screen-waiting" class="text-center z-10 flex flex-col items-center">
            <div class="w-20 h-20 border-4 border-t-[#ed1b76] border-r-[#ed1b76] border-b-transparent border-l-transparent rounded-full animate-spin mb-6"></div>
            <h2 class="text-2xl font-bold mb-2 font-mono tracking-widest">EN ESPERA</h2>
            <p class="text-gray-500 font-mono text-sm">El Líder iniciará...</p>
        </div>

        <!-- Pantalla: ACTIVO -->
        <div id="p-screen-active" class="hidden absolute inset-0 flex flex-col items-center justify-center z-10">
            <!-- Alerta Movimiento -->
            <div id="p-move-warning" class="hidden absolute inset-0 z-50 bg-[#ed1b76] flex flex-col items-center justify-center animate-heartbeat">
                <i data-lucide="footprints" class="w-40 h-40 text-white mb-6"></i>
                <h1 class="text-6xl font-black text-white italic -rotate-3">¡MUEVETE!</h1>
            </div>

            <div id="p-icon-container" class="mb-12 transform transition-transform duration-300"></div>
            <h1 id="p-status-text" class="text-6xl font-black text-white drop-shadow-xl tracking-widest">...</h1>
            <p id="p-sub-text" class="text-xl mt-4 font-mono text-gray-300">...</p>

            <!-- Barra Medición -->
            <div id="p-measure-bar-container" class="hidden absolute bottom-20 w-3/4 h-2 bg-gray-800 rounded-full overflow-hidden">
                <div id="p-measure-bar" class="h-full bg-yellow-400 w-full origin-left"></div>
            </div>
        </div>

        <!-- Pantalla: MUERTO -->
        <div id="p-screen-dead" class="hidden absolute inset-0 z-50 bg-[#2a0a0a] flex flex-col items-center justify-center">
            <div class="absolute inset-0 bg-[repeating-linear-gradient(45deg,transparent,transparent_10px,#000_10px,#000_20px)] opacity-10"></div>
            <div class="text-center">
                <i data-lucide="x-circle" class="w-40 h-40 text-[#ed1b76] mx-auto mb-6"></i>
                <h1 class="text-6xl font-black text-[#ed1b76] mb-2 title-font">ELIMINADO</h1>
                <p class="text-gray-400 font-mono">Has sido detectado</p>
            </div>
        </div>

        <!-- Pantalla: VICTORIA -->
        <div id="p-screen-win" class="hidden absolute inset-0 z-50 bg-[#0f392b] flex flex-col items-center justify-center">
            <i data-lucide="award" class="w-40 h-40 text-[#249f9c] mb-6 animate-pulse"></i>
            <h1 class="text-5xl font-black text-white mb-4 title-font">SOBREVIVISTE</h1>
            <p class="text-[#249f9c] font-mono tracking-widest">VICTORIA</p>
        </div>
    </div>

    <script>
        // --- SOUND MANAGER ROBUSTO ---
        const SoundManager = {
            gunshot: new Audio('https://library.penguinmod.com/files/sounds/gunshot3.mp3'),
            win: new Audio('https://library.penguinmod.com/files/sounds/win3.mp3'),
            bgm: null,
            songs: ['song1.mp3', 'song2.mp3', 'song3.mp3', 'song4.mp3'],
            
            // AudioContext de respaldo para asegurar sonido si falla MP3
            ctx: null,

            init() {
                this.gunshot.preload = 'auto';
                this.win.preload = 'auto';
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                } catch(e) { console.log("AudioContext not supported"); }
            },

            // Función crítica: Desbloquea audio en el primer click
            unlock() {
                // 1. Desbloquear elementos HTML Audio
                [this.gunshot, this.win].forEach(s => {
                    s.volume = 0;
                    s.play().then(() => {
                        s.pause();
                        s.currentTime = 0;
                        s.volume = 1; // Restaurar volumen
                    }).catch(e => console.log("Unlock failed for HTML Audio", e));
                });

                // 2. Desbloquear AudioContext (Beep backup)
                if (this.ctx && this.ctx.state === 'suspended') {
                    this.ctx.resume().then(() => {
                        // Tocar un beep silencioso
                        const osc = this.ctx.createOscillator();
                        const gain = this.ctx.createGain();
                        gain.gain.value = 0.001; // Casi silencio
                        osc.connect(gain);
                        gain.connect(this.ctx.destination);
                        osc.start();
                        osc.stop(this.ctx.currentTime + 0.1);
                        document.getElementById('audio-status').innerText = "AUDIO ON";
                        document.getElementById('audio-status').style.color = "green";
                    });
                }
            },

            playGunshot() {
                // Intentar HTML Audio primero
                this.gunshot.currentTime = 0;
                this.gunshot.play().catch(e => {
                    console.warn("Gunshot HTML Audio blocked, using synth fallback");
                    this.playSynthGunshot(); // Fallback
                });
            },

            playWin() {
                this.win.currentTime = 0;
                this.win.play().catch(() => {});
            },

            playSynthGunshot() {
                // Sonido sintético estridente por si falla el archivo
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.5);
                gain.gain.setValueAtTime(1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.5);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.5);
            },

            playBGM(isFinal) {
                if (this.bgm) { this.bgm.pause(); }
                const src = isFinal ? 'song3.mp3' : this.songs[Math.floor(Math.random() * this.songs.length)];
                this.bgm = new Audio(src);
                this.bgm.loop = true;
                this.bgm.play().catch(e => console.log("BGM Blocked", e));
            },

            stopBGM() {
                if (this.bgm) { this.bgm.pause(); this.bgm.currentTime = 0; }
            }
        };
        SoundManager.init();

        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyBMYTnk-CljdWENtDQqqKUBmQzBQuoxYPo",
            authDomain: "hello-74404.firebaseapp.com",
            databaseURL: "https://hello-74404-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "hello-74404",
            storageBucket: "hello-74404.firebasestorage.app",
            messagingSenderId: "781363507648",
            appId: "1:781363507648:web:5c7b871f11b9010bfd1825"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- UTILS ---
        const $ = (id) => document.getElementById(id);
        const APP_ID = "music-game-v1";
        let localUid = localStorage.getItem('mg_uid') || 'u_' + Date.now().toString(36);
        localStorage.setItem('mg_uid', localUid);

        // Flash UI
        const triggerFlash = () => {
            const el = $('flash-overlay');
            el.style.opacity = '1';
            setTimeout(() => el.style.opacity = '0', 100);
        };

        // --- APP CONTROLLER ---
        const app = {
            role: null,
            sessionId: null,
            init() {
                const p = new URLSearchParams(window.location.search);
                this.sessionId = p.get('session')?.toUpperCase();
                const role = p.get('role');
                if (this.sessionId && role) {
                    if (role === 'player') $('inp-session-code').value = this.sessionId;
                    this.setRole(role);
                } else {
                    this.showView('view-landing');
                }
                lucide.createIcons();
                // Global unlock attempt on any interaction
                document.body.addEventListener('click', () => SoundManager.unlock(), { once: true });
                document.body.addEventListener('touchstart', () => SoundManager.unlock(), { once: true });
            },
            setRole(r) {
                this.role = r;
                SoundManager.unlock();
                if (r === 'screen') host.init(); else player.init();
            },
            showView(id) {
                document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
                $(id).classList.remove('hidden');
            }
        };

        // --- HOST ---
        const host = {
            players: {}, gameState: 'waiting', musicPlaying: false, timers: [],
            
            init() {
                if (!app.sessionId) {
                    app.sessionId = Math.random().toString(36).substring(2, 6).toUpperCase();
                    const newUrl = `?session=${app.sessionId}&role=screen`;
                    window.history.replaceState(null, '', newUrl);
                }
                $('host-session-code').innerText = app.sessionId;
                app.showView('view-screen');
                
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(location.origin + location.pathname + '?session=' + app.sessionId + '&role=player')}&bgcolor=ffffff&color=000000&margin=10`;
                $('host-qr-img').src = qrUrl;

                db.ref(`artifacts/${APP_ID}/public/data/players`).on('value', s => {
                    const all = s.val() || {};
                    this.players = {};
                    Object.entries(all).forEach(([k,p]) => { if(p.sessionId === app.sessionId) this.players[k]=p; });
                    this.renderPlayers();
                });

                db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}`).on('value', s => {
                    const d = s.val();
                    if(d) { this.gameState = d.state; this.musicPlaying = d.musicPlaying; this.updateUI(); }
                });
                
                // Init Session
                this.updateDB({ state: 'waiting', musicPlaying: false, host: localUid });
            },

            updateDB(updates) { db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}`).update(updates); },
            wait(fn, ms) { const id = setTimeout(() => { fn(); this.timers=this.timers.filter(t=>t!==id); }, ms); this.timers.push(id); },
            clearTimers() { this.timers.forEach(clearTimeout); this.timers = []; },

            renderPlayers() {
                const list = $('host-players-list'); list.innerHTML = '';
                const pArr = Object.values(this.players);
                $('host-lobby-count').innerText = pArr.length;
                $('host-alive-count').innerText = pArr.filter(p=>p.isAlive).length;
                $('host-dead-count').innerText = pArr.filter(p=>!p.isAlive).length;
                $('btn-start-game').disabled = pArr.length === 0;

                pArr.forEach(p => {
                    const d = document.createElement('div');
                    const color = p.isAlive ? 'border-[#249f9c] text-[#249f9c]' : 'border-red-900 text-red-900 line-through';
                    d.className = `px-3 py-1 border rounded font-mono text-sm ${color}`;
                    d.innerText = p.name;
                    list.appendChild(d);
                });
            },

            startGame() {
                SoundManager.unlock();
                this.clearTimers();
                const updates = {};
                Object.keys(this.players).forEach(pid => {
                    updates[`artifacts/${APP_ID}/public/data/players/${pid}/isAlive`] = true;
                    updates[`artifacts/${APP_ID}/public/data/players/${pid}/lastScore`] = null;
                });
                updates[`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}/state`] = 'playing';
                updates[`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}/musicPlaying`] = true;
                db.ref().update(updates);
                
                this.startMusicLogic();
            },

            startMusicLogic() {
                const alive = Object.values(this.players).filter(p=>p.isAlive).length;
                SoundManager.playBGM(alive <= 2);
                
                let min = 5000, max = 12000;
                if(alive <= 2) { min = 10000; max = 20000; }
                
                this.wait(() => this.stopMusicLogic(), Math.random()*(max-min)+min);
            },

            stopMusicLogic() {
                SoundManager.stopBGM();
                this.updateDB({ musicPlaying: false, state: 'measuring', lastStop: firebase.database.ServerValue.TIMESTAMP });
                this.wait(() => this.processResults(), 3000);
            },

            processResults() {
                this.updateDB({ state: 'round_result' });
                
                const aliveP = Object.entries(this.players).filter(([k,p])=>p.isAlive);
                // Win check immediate
                if(aliveP.length <= 1 && Object.keys(this.players).length > 1) {
                    this.endGame(aliveP.length ? aliveP[0][1].name : 'NADIE');
                    return;
                }

                let worstId = null, maxScore = -1;
                aliveP.forEach(([id, p]) => {
                    const s = (p.lastScore === undefined || p.lastScore === null) ? 0 : p.lastScore;
                    if(s > maxScore) { maxScore = s; worstId = id; }
                });

                // Suspense delay
                this.wait(() => {
                    if(worstId && maxScore > 0.05 && aliveP.length > 1) {
                        // ELIMINATE
                        SoundManager.playGunshot();
                        triggerFlash();
                        
                        $('eliminated-name').innerText = this.players[worstId].name;
                        $('eliminated-overlay').classList.remove('hidden');
                        
                        const updates = {};
                        updates[`artifacts/${APP_ID}/public/data/players/${worstId}/isAlive`] = false;
                        updates[`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}/lastShot`] = firebase.database.ServerValue.TIMESTAMP;
                        db.ref().update(updates);
                    } else {
                        // No one moved significantly
                    }

                    this.wait(() => {
                        $('eliminated-overlay').classList.add('hidden');
                        
                        // Re-check win after kill
                        let currentAlive = 0, lastName = "";
                        Object.entries(this.players).forEach(([id,p]) => {
                            // Don't count the one we just killed locally even if update is pending
                            if(id === worstId && maxScore > 0.05) return;
                            if(p.isAlive) { currentAlive++; lastName = p.name; }
                        });

                        if(currentAlive <= 1) {
                            this.endGame(currentAlive === 1 ? lastName : 'NADIE');
                        } else {
                            // New Round - Clear Scores
                            const ups = {};
                            Object.keys(this.players).forEach(id => ups[`artifacts/${APP_ID}/public/data/players/${id}/lastScore`] = null);
                            ups[`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}/state`] = 'playing';
                            ups[`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}/musicPlaying`] = true;
                            db.ref().update(ups);
                            this.startMusicLogic();
                        }
                    }, 4000);
                }, aliveP.length <= 2 ? 5000 : 3000);
            },

            endGame(winner) {
                this.clearTimers();
                SoundManager.stopBGM();
                SoundManager.playWin();
                this.updateDB({ state: 'ended', musicPlaying: false, winner: winner });
                this.wait(() => this.startGame(), 8000); // Auto restart loop
            },

            updateUI() {
                ['host-lobby','host-game','host-round-results','host-winner'].forEach(id=>$(id).classList.add('hidden'));
                
                if(this.gameState === 'waiting') {
                    $('host-lobby').classList.remove('hidden');
                } else if(this.gameState === 'playing' || this.gameState === 'measuring') {
                    $('host-game').classList.remove('hidden');
                    const l = $('traffic-light'), t = $('host-status-text'), i = $('traffic-icon');
                    if(this.musicPlaying) {
                        l.className = "w-80 h-80 rounded-full flex items-center justify-center border-[10px] bg-green-900 border-green-500 shadow-[0_0_80px_rgba(34,197,94,0.6)]";
                        i.outerHTML = '<i id="traffic-icon" data-lucide="play" class="w-40 h-40 text-green-400 fill-current animate-pulse"></i>';
                        t.innerText = "¡CORRE!";
                        t.className = "text-9xl font-black mt-12 tracking-widest title-font text-green-500";
                    } else {
                        l.className = "w-80 h-80 rounded-full flex items-center justify-center border-[10px] bg-[#ed1b76] border-red-500 shadow-[0_0_80px_rgba(237,27,118,0.6)]";
                        i.outerHTML = '<i id="traffic-icon" data-lucide="eye" class="w-40 h-40 text-white animate-[pulse_0.2s_infinite]"></i>';
                        t.innerText = "MIDIENDO";
                        t.className = "text-8xl font-black mt-12 tracking-widest title-font text-[#ed1b76]";
                    }
                } else if(this.gameState === 'round_result') {
                    $('host-round-results').classList.remove('hidden');
                    this.renderResults();
                } else if(this.gameState === 'ended') {
                    $('host-winner').classList.remove('hidden');
                    db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}/winner`).once('value', s => {
                        $('winner-name').innerText = s.val() || '...';
                    });
                }
                lucide.createIcons();
            },

            renderResults() {
                const g = $('results-grid'); g.innerHTML = '';
                $('eliminated-overlay').classList.add('hidden');
                
                // Show ONLY alive players that submitted a score
                const players = Object.values(this.players).filter(p => p.isAlive && p.lastScore !== null && p.lastScore !== undefined);
                players.sort((a,b) => b.lastScore - a.lastScore);

                players.forEach((p, i) => {
                    const score = parseFloat(p.lastScore).toFixed(2);
                    const isDanger = score > 1.0;
                    const w = Math.min(100, (score/2.5)*100);
                    
                    const el = document.createElement('div');
                    el.className = "glass-panel p-4 rounded-xl flex items-center space-x-6 mb-3 fade-enter opacity-0 transition-all duration-500";
                    el.innerHTML = `
                        <div class="text-2xl font-bold w-12 text-gray-500">#${i+1}</div>
                        <div class="text-3xl font-mono w-48 truncate">${p.name}</div>
                        <div class="flex-1 h-8 bg-gray-800 rounded-full overflow-hidden relative">
                            <div class="h-full score-bar flex items-center justify-end px-2 font-bold text-black" 
                                 style="width:0%; background: ${isDanger ? '#ed1b76' : '#249f9c'}">
                                 ${score}s
                            </div>
                        </div>
                    `;
                    g.appendChild(el);
                    
                    setTimeout(() => {
                        el.classList.remove('opacity-0', 'fade-enter');
                        el.querySelector('.score-bar').style.width = `${Math.max(5, w)}%`;
                    }, i * 200);
                });
            }
        };

        // --- PLAYER ---
        const player = {
            isAlive: true, lastMove: 0, lastShotSeen: 0,
            
            init() {
                $('inp-session-code').value = app.sessionId || '';
                app.showView('view-player-join');
            },

            join() {
                const name = $('inp-player-name').value.trim().toUpperCase();
                const code = $('inp-session-code').value.trim().toUpperCase();
                if(!name || !code) return alert("Datos incompletos");
                
                SoundManager.unlock(); // FORCE UNLOCK
                app.sessionId = code;
                db.ref(`artifacts/${APP_ID}/public/data/players/${localUid}`).set({
                    name, sessionId: code, isAlive: true, lastScore: null,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP
                }).then(() => app.showView('view-player-sensor')).catch(alert);
            },

            requestPermissions() {
                SoundManager.unlock(); // FORCE UNLOCK AGAIN
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission().then(r => r==='granted' ? this.enter() : alert("Permiso denegado")).catch(console.error);
                } else this.enter();
            },

            enter() {
                app.showView('view-player-game');
                this.setup();
                this.monitor();
            },

            setup() {
                db.ref(`artifacts/${APP_ID}/public/data/players/${localUid}`).on('value', s => {
                    const p = s.val();
                    if(p) {
                        if(this.isAlive && !p.isAlive) this.die();
                        this.isAlive = p.isAlive;
                        this.updateScreen();
                    }
                });
                db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}`).on('value', s => {
                    const sess = s.val();
                    if(sess) {
                        this.sessionData = sess;
                        if(sess.lastShot && sess.lastShot !== this.lastShotSeen) {
                            this.lastShotSeen = sess.lastShot;
                            if(Date.now() - sess.lastShot < 3000) triggerFlash();
                        }
                        this.updateScreen();
                        if(sess.state === 'measuring') this.measure();
                    }
                });
            },

            monitor() {
                this.lastMove = Date.now();
                window.addEventListener('devicemotion', e => {
                    let acc = e.acceleration ? Math.sqrt(e.acceleration.x**2 + e.acceleration.y**2 + e.acceleration.z**2) : 0;
                    if(acc > 0.5) this.lastMove = Date.now();
                });
                setInterval(() => {
                    if(!this.sessionData || !this.isAlive) return;
                    if(this.sessionData.state === 'playing' && this.sessionData.musicPlaying) {
                        $('p-move-warning').classList.toggle('hidden', (Date.now() - this.lastMove) < 2000);
                        if((Date.now() - this.lastMove) > 2000 && navigator.vibrate) navigator.vibrate(200);
                    } else $('p-move-warning').classList.add('hidden');
                }, 500);
            },

            measure() {
                const start = Date.now();
                let lastM = 0;
                
                // Animation
                const b = $('p-measure-bar');
                b.style.transition = 'none'; b.style.transform = 'scaleX(1)';
                void b.offsetWidth; b.style.transition = 'transform 2s linear'; b.style.transform = 'scaleX(0)';

                const h = (e) => {
                    let acc = 0;
                    if(e.acceleration) acc = Math.sqrt(e.acceleration.x**2 + e.acceleration.y**2 + e.acceleration.z**2);
                    else if(e.accelerationIncludingGravity) {
                        const g = e.accelerationIncludingGravity;
                        acc = Math.abs(Math.sqrt(g.x**2 + g.y**2 + g.z**2) - 9.8);
                    }
                    if(acc > 2.0) lastM = Date.now() - start;
                };
                window.addEventListener('devicemotion', h);
                setTimeout(() => {
                    window.removeEventListener('devicemotion', h);
                    if(this.isAlive) db.ref(`artifacts/${APP_ID}/public/data/players/${localUid}`).update({ lastScore: lastM/1000 });
                }, 2000);
            },

            die() {
                SoundManager.playGunshot(); // Try play local
                if(navigator.vibrate) navigator.vibrate([200, 100, 500]);
            },

            updateScreen() {
                const s = this.sessionData;
                const c = $('view-player-game');
                ['p-screen-waiting','p-screen-active','p-screen-dead','p-screen-win'].forEach(id=>$(id).classList.add('hidden'));
                c.className = "h-full w-full flex flex-col items-center justify-center relative overflow-hidden transition-colors duration-300";

                if(!s) return;
                
                if(s.state === 'ended') {
                    if(s.winner !== 'NADIE') { $('p-screen-win').classList.remove('hidden'); SoundManager.playWin(); }
                    else $('p-screen-dead').classList.remove('hidden');
                    return;
                }
                if(!this.isAlive) { $('p-screen-dead').classList.remove('hidden'); return; }
                if(s.state === 'waiting') { $('p-screen-waiting').classList.remove('hidden'); c.classList.add('bg-neutral-900'); return; }

                if(s.state === 'playing' || s.state === 'measuring' || s.state === 'round_result') {
                    $('p-screen-active').classList.remove('hidden');
                    const i = $('p-icon-container'), t = $('p-status-text'), st = $('p-sub-text'), bar = $('p-measure-bar-container');
                    
                    if(s.musicPlaying) {
                        c.className = "h-full w-full flex flex-col items-center justify-center bg-[#249f9c]";
                        i.innerHTML = '<i data-lucide="footprints" class="w-48 h-48 text-white animate-bounce"></i>';
                        t.innerText = "¡CORRE!"; st.innerText = "MUÉVETE AHORA";
                        bar.classList.add('hidden');
                    } else if(s.state === 'measuring') {
                        c.className = "h-full w-full flex flex-col items-center justify-center bg-[#ed1b76]";
                        i.innerHTML = '<i data-lucide="eye" class="w-48 h-48 text-white animate-pulse"></i>';
                        t.innerText = "QUIETO"; st.innerText = "NO TE MUEVAS";
                        bar.classList.remove('hidden');
                        if(navigator.vibrate) navigator.vibrate(50);
                    } else {
                        c.className = "h-full w-full flex flex-col items-center justify-center bg-black";
                        i.innerHTML = '<i data-lucide="bar-chart-2" class="w-48 h-48 text-gray-500"></i>';
                        t.innerText = "RESULTADOS"; st.innerText = "MIRA LA PANTALLA";
                        bar.classList.add('hidden');
                    }
                    lucide.createIcons();
                }
            }
        };

        app.init();
    </script>
</body>
</html>
