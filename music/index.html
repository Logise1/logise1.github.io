<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juego del Semáforo Musical</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-database-compat.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');
        
        :root { --pink: #ed1b76; --green: #249f9c; }
        body { font-family: 'Share Tech Mono', monospace; background-color: #000; color: white; overflow: hidden; user-select: none; }
        .title-font { font-family: 'Orbitron', sans-serif; }
        .hidden { display: none !important; }
        
        /* UI Overlays */
        .glass-panel { background: rgba(10, 10, 10, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
        
        /* Flash Effect */
        #flash-overlay { transition: opacity 0.05s ease-out; pointer-events: none; }
        
        /* Background Pattern */
        .bg-grid { background-image: radial-gradient(#333 1px, transparent 1px); background-size: 40px 40px; opacity: 0.15; }

        /* Animations */
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .animate-heartbeat { animation: heartbeat 1s infinite; }
        .score-bar { transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .bg-detected { background-color: #ef4444 !important; transition: background-color 0.1s; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden bg-black text-white relative">

    <!-- GLOBAL AUDIO STATUS -->
    <div id="audio-status" class="fixed top-2 right-2 text-[10px] text-gray-700 z-50 pointer-events-none font-mono">SYSTEM READY</div>

    <!-- FLASH OVERLAY -->
    <div id="flash-overlay" class="fixed inset-0 z-[100] bg-red-600 mix-blend-lighten opacity-0"></div>
    
    <!-- BACKGROUND -->
    <div class="fixed inset-0 bg-grid pointer-events-none z-0"></div>

    <!-- VISTA: SELECCIÓN DE ROL -->
    <div id="view-landing" class="h-full w-full flex flex-col items-center justify-center p-6 relative z-20 bg-black/95">
        <div class="mb-12 text-center space-y-4">
            <h1 class="text-6xl md:text-8xl font-black title-font text-transparent bg-clip-text bg-gradient-to-br from-[#ed1b76] to-[#ff5252] drop-shadow-[0_0_15px_rgba(237,27,118,0.5)]">
                RED LIGHT
            </h1>
            <p class="text-xl tracking-[0.8em] text-gray-400 uppercase">Challenge</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl">
            <button onclick="app.setRole('screen')" class="group p-10 glass-panel rounded-2xl hover:bg-[#ed1b76]/20 transition-all hover:scale-105 border border-[#ed1b76]/30">
                <i data-lucide="monitor" class="w-20 h-20 text-[#ed1b76] mb-6 mx-auto"></i>
                <span class="text-3xl font-bold title-font block text-center">PANTALLA (TV)</span>
                <span class="text-sm text-gray-400 mt-2 block text-center">Modo Host</span>
            </button>

            <button onclick="app.setRole('player')" class="group p-10 glass-panel rounded-2xl hover:bg-[#249f9c]/20 transition-all hover:scale-105 border border-[#249f9c]/30">
                <i data-lucide="smartphone" class="w-20 h-20 text-[#249f9c] mb-6 mx-auto"></i>
                <span class="text-3xl font-bold title-font block text-center">JUGADOR</span>
                <span class="text-sm text-gray-400 mt-2 block text-center">Control Remoto</span>
            </button>
        </div>
    </div>

    <!-- VISTA: PANTALLA (HOST) -->
    <div id="view-screen" class="hidden h-full w-full relative bg-neutral-900 z-10 flex flex-col">
        <!-- Header -->
        <div class="p-6 flex justify-between items-center z-20 bg-black/50 backdrop-blur-md border-b border-white/10">
            <div class="flex items-center space-x-4">
                <span class="text-gray-400 text-sm">SALA</span>
                <span id="host-session-code" class="text-4xl font-bold title-font text-[#ed1b76] tracking-widest">...</span>
            </div>
            <div class="flex space-x-4">
                <div class="bg-[#249f9c]/20 border border-[#249f9c]/50 px-4 py-2 rounded-lg text-[#249f9c] flex items-center">
                    <i data-lucide="users" class="mr-2 w-5 h-5"></i> <span id="host-alive-count" class="font-bold text-xl">0</span>
                </div>
                <div class="bg-red-900/20 border border-red-500/50 px-4 py-2 rounded-lg text-red-500 flex items-center">
                    <i data-lucide="skull" class="mr-2 w-5 h-5"></i> <span id="host-dead-count" class="font-bold text-xl">0</span>
                </div>
            </div>
        </div>

        <!-- Contenido Central Host -->
        <div class="flex-1 relative flex items-center justify-center p-8 overflow-hidden">
            
            <!-- Estado: LOBBY -->
            <div id="host-lobby" class="text-center glass-panel p-12 rounded-3xl animate-fade-in max-w-2xl w-full">
                <img id="host-qr-img" src="" alt="QR" class="w-64 h-64 object-contain rounded-lg mb-8 mx-auto border-4 border-white shadow-2xl">
                <h2 class="text-5xl font-bold mb-4 title-font tracking-tighter">UNIRSE</h2>
                <div class="text-gray-400 mb-8 font-mono">Escanea el código para entrar</div>
                <button id="btn-start-game" onclick="host.startGame()" disabled class="w-full py-5 bg-[#ed1b76] rounded-xl text-3xl font-bold hover:bg-pink-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-[0_0_30px_rgba(237,27,118,0.4)]">
                    EMPEZAR JUEGO
                </button>
            </div>

            <!-- Estado: JUEGO (2D Visuals) -->
            <div id="host-game" class="hidden w-full h-full flex flex-col items-center justify-center">
                <!-- Luz principal -->
                <div id="traffic-light-container" class="relative mb-12 transform transition-transform duration-500">
                    <div class="absolute inset-0 rounded-full blur-[100px] opacity-50 transition-colors duration-200" id="light-glow"></div>
                    <div id="traffic-light" class="relative w-96 h-96 rounded-full flex items-center justify-center border-[15px] transition-all duration-300 bg-neutral-900 border-neutral-700 shadow-2xl">
                        <i id="traffic-icon" data-lucide="eye" class="w-48 h-48 text-gray-500 transition-colors duration-200"></i>
                    </div>
                </div>
                
                <h2 id="host-status-text" class="text-[120px] font-black tracking-tighter title-font drop-shadow-2xl transition-all duration-200">ESPERA</h2>
            </div>

            <!-- Estado: RESULTADOS -->
            <div id="host-round-results" class="hidden w-full h-full flex flex-col items-center justify-start pt-10">
                <h2 class="text-6xl font-black mb-8 text-[#ed1b76] title-font border-b-4 border-[#ed1b76] pb-2">RESULTADOS</h2>
                
                <div id="results-grid" class="w-full max-w-5xl grid grid-cols-1 gap-4 overflow-y-auto pr-4 pb-20" style="max-height: 70vh;">
                    <!-- Filas dinámicas -->
                </div>

                <!-- Overlay Eliminado -->
                <div id="eliminated-overlay" class="absolute inset-0 z-50 bg-black/90 flex flex-col items-center justify-center hidden backdrop-blur-md">
                    <div class="text-center animate-bounce">
                        <i data-lucide="skull" class="w-48 h-48 text-red-600 mx-auto mb-6"></i>
                        <h1 class="text-[8rem] leading-none font-black text-[#ed1b76] title-font mb-4">ELIMINADO</h1>
                        <h2 id="eliminated-name" class="text-6xl font-mono text-white bg-neutral-800 px-8 py-4 inline-block rounded border border-[#ed1b76]">JUGADOR</h2>
                    </div>
                </div>
            </div>

            <!-- Estado: GANADOR -->
            <div id="host-winner" class="hidden flex flex-col items-center justify-center animate-fade-in-up">
                <i data-lucide="crown" class="w-48 h-48 text-yellow-400 mb-8 animate-bounce"></i>
                <h2 class="text-6xl font-bold text-yellow-500 mb-6 title-font tracking-widest">GANADOR</h2>
                <div id="winner-name" class="text-9xl font-black text-white mb-12 title-font">NOMBRE</div>
                <div class="text-gray-500 font-mono animate-pulse">Reiniciando sistema de juego...</div>
            </div>
        </div>

        <!-- Footer: Player List -->
        <div class="w-full p-4 bg-black/80 border-t border-white/10">
            <div id="host-players-list" class="flex flex-wrap gap-2 justify-center max-h-24 overflow-y-auto"></div>
        </div>
    </div>

    <!-- VISTA: JUGADOR (MÓVIL) -->
    <div id="view-player-ui" class="hidden h-full w-full relative z-20 bg-neutral-900 flex flex-col">
        <!-- Login Screen -->
        <div id="player-login" class="flex-1 flex flex-col items-center justify-center p-6 space-y-6">
            <h1 class="text-4xl font-black text-[#ed1b76] title-font mb-4">LOGIN</h1>
            <input type="text" id="inp-player-name" placeholder="NOMBRE" maxlength="10" class="w-full max-w-xs bg-black border border-gray-700 p-4 rounded text-center text-xl text-white focus:border-[#ed1b76] outline-none font-mono">
            <input type="text" id="inp-session-code" placeholder="CÓDIGO" maxlength="4" class="w-full max-w-xs bg-black border border-gray-700 p-4 rounded text-center text-xl text-white uppercase focus:border-[#ed1b76] outline-none tracking-widest font-mono">
            <button onclick="player.join()" class="w-full max-w-xs bg-[#ed1b76] p-4 rounded font-bold text-xl shadow-lg shadow-pink-900/50 active:scale-95 transition-transform">ENTRAR</button>
        </div>

        <!-- Sensor Permission -->
        <div id="player-sensor" class="hidden flex-1 flex flex-col items-center justify-center p-8 text-center bg-black">
            <i data-lucide="smartphone" class="w-24 h-24 text-yellow-500 mb-6 animate-pulse"></i>
            <h2 class="text-2xl font-bold mb-4 text-yellow-500">HABILITAR SENSORES</h2>
            <button onclick="player.requestPermissions()" class="bg-yellow-500 text-black px-8 py-4 rounded-xl font-bold text-lg w-full max-w-xs">PERMITIR</button>
        </div>

        <!-- Game Interface -->
        <div id="player-game" class="hidden flex-1 flex flex-col relative overflow-hidden transition-colors duration-300">
            <!-- Waiting State -->
            <div id="p-state-waiting" class="absolute inset-0 flex flex-col items-center justify-center bg-black/90 z-10">
                <div class="animate-spin w-12 h-12 border-4 border-[#249f9c] border-t-transparent rounded-full mb-4"></div>
                <p class="text-[#249f9c] tracking-widest font-mono">ESPERANDO AL LÍDER</p>
            </div>

            <!-- Active Game State -->
            <div id="p-state-active" class="hidden absolute inset-0 flex flex-col items-center justify-center z-0">
                <div id="p-bg-color" class="absolute inset-0 transition-colors duration-300 bg-[#249f9c]"></div>
                
                <div class="relative z-10 text-center">
                    <div id="p-icon" class="mb-8 transform transition-transform duration-200 flex justify-center"></div>
                    <h1 id="p-main-text" class="text-6xl font-black drop-shadow-lg title-font">...</h1>
                    <p id="p-sub-text" class="text-xl mt-2 font-mono opacity-90">...</p>
                </div>

                <!-- Warning Overlay -->
                <div id="p-move-warning" class="hidden absolute inset-0 z-20 bg-[#ed1b76] flex flex-col items-center justify-center animate-heartbeat">
                    <h1 class="text-6xl font-black italic -rotate-6">¡MUÉVETE!</h1>
                </div>
            </div>

            <!-- Dead State -->
            <div id="p-state-dead" class="hidden absolute inset-0 z-30 bg-red-950 flex flex-col items-center justify-center">
                <i data-lucide="skull" class="w-32 h-32 text-red-500 mb-4 animate-bounce"></i>
                <h1 class="text-5xl font-black text-red-500 title-font">ELIMINADO</h1>
            </div>

            <!-- Win State -->
            <div id="p-state-win" class="hidden absolute inset-0 z-30 bg-yellow-900 flex flex-col items-center justify-center">
                <i data-lucide="crown" class="w-32 h-32 text-yellow-400 mb-4 animate-bounce"></i>
                <h1 class="text-5xl font-black text-yellow-400 title-font">VICTORIA</h1>
            </div>
        </div>
    </div>

    <script>
        // --- SYSTEM UTILS (WakeLock, Fullscreen, AntiBack) ---
        const SystemOps = {
            wakeLock: null,
            
            async enableAwake() {
                try {
                    if ('wakeLock' in navigator) {
                        this.wakeLock = await navigator.wakeLock.request('screen');
                    }
                } catch (err) { console.log('WakeLock Error:', err); }
            },

            enableFullscreen() {
                const el = document.documentElement;
                const rfs = el.requestFullscreen || el.webkitRequestFullscreen || el.mozRequestFullScreen || el.msRequestFullscreen;
                if(rfs) {
                    rfs.call(el).catch(err => console.log('Fullscreen blocked:', err));
                }
            },

            enableAntiBack() {
                history.pushState(null, document.title, location.href);
                window.addEventListener('popstate', function (event) {
                    history.pushState(null, document.title, location.href);
                });
            },

            activateAll() {
                this.enableAwake();
                this.enableFullscreen();
                this.enableAntiBack();
            }
        };

        // --- AUDIO MANAGER ---
        const AudioSys = {
            gun: new Audio('https://library.penguinmod.com/files/sounds/gunshot3.mp3'),
            win: new Audio('https://library.penguinmod.com/files/sounds/win3.mp3'),
            bgm: null,
            ctx: null,
            init() {
                try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){}
            },
            unlock() {
                if(this.ctx && this.ctx.state==='suspended') this.ctx.resume();
                [this.gun, this.win].forEach(a => { a.volume=0; a.play().then(()=>{ a.pause(); a.currentTime=0; a.volume=1; }).catch(()=>{}); });
            },
            playGun() { 
                this.gun.currentTime=0; this.gun.play().catch(() => this.playSynth(150, 'sawtooth')); 
            },
            playWin() { this.win.currentTime=0; this.win.play().catch(()=>{}); },
            playBGM(isFinale) {
                if(this.bgm) this.bgm.pause();
                
                // LÓGICA DE CANCIONES ACTUALIZADA
                // isFinale (<= 2 players): Song 3 (rápida)
                // Normal (> 2 players): Pool de song1, song2, song4, song5
                let src;
                if (isFinale) {
                    src = 'song3.mp3';
                } else {
                    const pool = ['song1.mp3', 'song2.mp3', 'song4.mp3', 'song5.mp3', 'song6.mp3'];
                    src = pool[Math.floor(Math.random() * pool.length)];
                }

                this.bgm = new Audio(src); 
                this.bgm.loop=true; 
                this.bgm.play().catch(()=>{});
            },
            stopBGM() { if(this.bgm) this.bgm.pause(); },
            playSynth(freq, type) {
                if(!this.ctx) return;
                const o=this.ctx.createOscillator(), g=this.ctx.createGain();
                o.type=type; o.frequency.value=freq; g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime+0.5);
                o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+0.5);
            }
        };
        AudioSys.init();

        // --- APP LOGIC ---
        const firebaseConfig = { apiKey: "AIzaSyBMYTnk-CljdWENtDQqqKUBmQzBQuoxYPo", authDomain: "hello-74404.firebaseapp.com", databaseURL: "https://hello-74404-default-rtdb.europe-west1.firebasedatabase.app", projectId: "hello-74404", storageBucket: "hello-74404.firebasestorage.app", messagingSenderId: "781363507648", appId: "1:781363507648:web:5c7b871f11b9010bfd1825" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const $ = (id) => document.getElementById(id);
        const APP_ID = "music-game-v1";
        let localUid = localStorage.getItem('mg_uid') || 'u_' + Date.now().toString(36);
        localStorage.setItem('mg_uid', localUid);

        const triggerFlash = () => { $('flash-overlay').style.opacity = '1'; setTimeout(() => $('flash-overlay').style.opacity = '0', 100); };

        const app = {
            init() {
                const p = new URLSearchParams(location.search);
                const s = p.get('session')?.toUpperCase();
                const r = p.get('role');
                document.body.addEventListener('click', () => {
                    AudioSys.unlock();
                }, {once:true});
                
                if(s && r) { 
                    if(r==='player') $('inp-session-code').value = s; 
                    this.setRole(r, s); 
                } else {
                    $('view-landing').classList.remove('hidden');
                }
                lucide.createIcons();
            },
            setRole(r, s) {
                AudioSys.unlock();
                $('view-landing').classList.add('hidden');
                if(r === 'screen') host.init(s); else player.init(s);
            }
        };

        const host = {
            players: {}, sessionId: null, gameState: 'waiting', musicPlaying: false, timers: [],
            
            init(sid) {
                this.sessionId = sid || Math.random().toString(36).substring(2,6).toUpperCase();
                if(!sid) { try { history.replaceState(null, '', `?session=${this.sessionId}&role=screen`); } catch(e) {} }
                
                $('host-session-code').innerText = this.sessionId;
                $('view-screen').classList.remove('hidden');
                
                const safeUrl = window.location.href.split('?')[0];
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(safeUrl + '?session=' + this.sessionId + '&role=player')}&bgcolor=ffffff&color=000000&margin=10`;
                $('host-qr-img').src = qrUrl;

                db.ref(`artifacts/${APP_ID}/${this.sessionId}/players`).on('value', s => {
                    this.players = s.val() || {};
                    this.renderUI();
                });

                db.ref(`artifacts/${APP_ID}/${this.sessionId}/state`).on('value', s => {
                    const d = s.val();
                    if(d) {
                        this.gameState = d.state;
                        this.musicPlaying = d.musicPlaying;
                        this.updateUI();
                    }
                });

                this.updateDB({ state: 'waiting', musicPlaying: false, host: localUid });
            },

            updateDB(d) { db.ref(`artifacts/${APP_ID}/${this.sessionId}/state`).update(d); },
            wait(fn, ms) { const t=setTimeout(fn, ms); this.timers.push(t); },
            clearTimers() { this.timers.forEach(clearTimeout); this.timers=[]; },

            renderUI() {
                const arr = Object.values(this.players);
                if($('host-lobby-count')) $('host-lobby-count').innerText = arr.length;
                if($('host-alive-count')) $('host-alive-count').innerText = arr.filter(p=>p.isAlive).length;
                if($('host-dead-count')) $('host-dead-count').innerText = arr.filter(p=>!p.isAlive).length;
                if($('btn-start-game')) $('btn-start-game').disabled = arr.length === 0;
                
                const list = $('host-players-list'); 
                if(list) {
                    list.innerHTML = '';
                    arr.forEach(p => {
                        const d = document.createElement('div');
                        d.className = `px-2 py-1 text-xs border rounded ${p.isAlive ? 'border-[#249f9c] text-[#249f9c]' : 'border-red-900 text-red-900 line-through'}`;
                        d.innerText = p.name;
                        list.appendChild(d);
                    });
                }
            },

            startGame() {
                SystemOps.activateAll(); // Activar Fullscreen y WakeLock al empezar
                this.clearTimers();
                const u = {};
                Object.keys(this.players).forEach(id => {
                    u[`players/${id}/isAlive`] = true;
                    u[`players/${id}/lastScore`] = null;
                });
                db.ref(`artifacts/${APP_ID}/${this.sessionId}`).update(u);
                this.updateDB({ state: 'playing', musicPlaying: true });
                this.loopMusic();
            },

            loopMusic() {
                const alive = Object.values(this.players).filter(p=>p.isAlive).length;
                const isFinale = alive <= 2;
                
                AudioSys.playBGM(isFinale);
                
                // LÓGICA DE DURACIÓN (Extendida para 3+ jugadores)
                // Si hay más de 2 vivos, rondas largas (20s - 35s) para que la partida dure.
                // Si hay 2 o menos, rondas rápidas (8s - 15s) para tensión final.
                let duration;
                if (!isFinale) {
                    // Rondas largas (3+ jugadores)
                    duration = Math.random() * 15000 + 20000; // 20s a 35s
                } else {
                    // Final intensa
                    duration = Math.random() * 7000 + 8000; // 8s a 15s
                }
                
                this.wait(() => {
                    AudioSys.stopBGM();
                    this.updateDB({ state: 'measuring', musicPlaying: false, lastStop: Date.now() });
                    // Wait 4s to allow network lag compensation before calculating
                    this.wait(() => this.checkResults(), 4000);
                }, duration);
            },

            checkResults() {
                this.updateDB({ state: 'round_result' });
                const alive = Object.entries(this.players).filter(([,p])=>p.isAlive);
                
                if(alive.length <= 1 && Object.keys(this.players).length > 1) {
                    this.endGame(alive.length ? alive[0][1].name : 'NADIE');
                    return;
                }

                let worstId = null, max = -1;
                alive.forEach(([id, p]) => {
                    // Treat null score as 0 (safe fallback)
                    const s = p.lastScore || 0;
                    if(s > max) { max = s; worstId = id; }
                });

                this.wait(() => {
                    // Solo eliminamos si la acumulación de movimiento es significativa (> 0.2s acumulados)
                    if(worstId && max > 0.2 && alive.length > 1) {
                        AudioSys.playGun();
                        triggerFlash();
                        const elName = $('eliminated-name');
                        if(elName) elName.innerText = this.players[worstId].name;
                        
                        const elOverlay = $('eliminated-overlay');
                        if(elOverlay) elOverlay.classList.remove('hidden');
                        
                        db.ref(`artifacts/${APP_ID}/${this.sessionId}/players/${worstId}`).update({ isAlive: false });
                        db.ref(`artifacts/${APP_ID}/${this.sessionId}/state`).update({ lastShot: Date.now() });
                    }

                    this.wait(() => {
                        const elOverlay = $('eliminated-overlay');
                        if(elOverlay) elOverlay.classList.add('hidden');
                        const currentAlive = Object.values(this.players).filter(p=>p.isAlive).length;
                        
                        if(currentAlive <= 1) {
                            const winner = Object.values(this.players).find(p=>p.isAlive);
                            this.endGame(winner ? winner.name : 'NADIE');
                        } else {
                            const u = {};
                            Object.keys(this.players).forEach(id => u[`players/${id}/lastScore`] = null);
                            db.ref(`artifacts/${APP_ID}/${this.sessionId}`).update(u);
                            this.updateDB({ state: 'playing', musicPlaying: true });
                            this.loopMusic();
                        }
                    }, 4000);
                }, 3000);
            },

            endGame(w) {
                this.clearTimers(); AudioSys.stopBGM(); AudioSys.playWin();
                this.updateDB({ state: 'ended', winner: w });
                this.wait(() => {
                    this.updateDB({ state: 'waiting' });
                    const u = {};
                    Object.keys(this.players).forEach(id => {
                        u[`players/${id}/isAlive`] = true;
                        u[`players/${id}/lastScore`] = null;
                    });
                    db.ref(`artifacts/${APP_ID}/${this.sessionId}`).update(u);
                }, 8000);
            },

            updateUI() {
                ['host-lobby','host-game','host-round-results','host-winner'].forEach(id=>$(id)?.classList.add('hidden'));
                
                if(this.gameState === 'waiting') $('host-lobby')?.classList.remove('hidden');
                else if(this.gameState === 'playing') {
                    $('host-game')?.classList.remove('hidden');
                    const l = $('traffic-light');
                    const glow = $('light-glow');
                    const text = $('host-status-text');
                    const icon = $('traffic-icon');

                    // GREEN LIGHT VISUALS
                    l.className = "relative w-96 h-96 rounded-full flex items-center justify-center border-[15px] transition-all duration-300 bg-green-600 border-green-400 shadow-[0_0_100px_rgba(34,197,94,0.5)] scale-110";
                    glow.className = "absolute inset-0 rounded-full bg-green-500 blur-[80px] opacity-40 animate-pulse";
                    icon.outerHTML = `<i id="traffic-icon" data-lucide="play" class="w-48 h-48 text-white fill-current"></i>`;
                    text.innerText = "¡CORRE!";
                    text.className = "text-[120px] font-black mt-12 tracking-widest title-font text-green-500 drop-shadow-[0_0_20px_rgba(34,197,94,0.8)]";
                } else if(this.gameState === 'measuring') {
                    $('host-game')?.classList.remove('hidden');
                    const l = $('traffic-light');
                    const glow = $('light-glow');
                    const text = $('host-status-text');
                    const icon = $('traffic-icon');

                    // RED LIGHT VISUALS
                    l.className = "relative w-96 h-96 rounded-full flex items-center justify-center border-[15px] transition-all duration-200 bg-yellow-500 border-yellow-300 shadow-[0_0_100px_rgba(234,179,8,0.5)] scale-100";
                    glow.className = "absolute inset-0 rounded-full bg-yellow-500 blur-[80px] opacity-40";
                    icon.outerHTML = `<i id="traffic-icon" data-lucide="eye" class="w-48 h-48 text-white animate-pulse"></i>`;
                    text.innerText = "MIDIENDO";
                    text.className = "text-[100px] font-black mt-12 tracking-widest title-font text-yellow-500 drop-shadow-[0_0_20px_rgba(234,179,8,0.8)]";
                } else if(this.gameState === 'round_result') {
                    $('host-round-results')?.classList.remove('hidden');
                    this.renderResults();
                } else if(this.gameState === 'ended') {
                    $('host-winner')?.classList.remove('hidden');
                    db.ref(`artifacts/${APP_ID}/${this.sessionId}/state/winner`).once('value', s => {
                        const winName = $('winner-name');
                        if(winName) winName.innerText = s.val() || '...';
                    });
                }
                lucide.createIcons();
            },

            renderResults() {
                const g = $('results-grid'); 
                if(!g) return;
                g.innerHTML = '';
                
                // Show ALL ALIVE PLAYERS regardless of score status (default to 0.00s if null)
                const p = Object.values(this.players).filter(x => x.isAlive);
                p.sort((a,b) => (b.lastScore||0) - (a.lastScore||0));
                
                p.forEach((pl, i) => {
                    const rawScore = (pl.lastScore === null || pl.lastScore === undefined) ? 0 : parseFloat(pl.lastScore);
                    const score = rawScore.toFixed(3);
                    // Color Logic
                    let barColor = 'bg-[#249f9c]';
                    if (rawScore > 0.8) barColor = 'bg-[#ed1b76]';
                    else if (rawScore > 0.4) barColor = 'bg-yellow-500';

                    // Max expected bad score approx 1.5s for bar width
                    const w = Math.min(100, (rawScore/1.5)*100);
                    
                    g.innerHTML += `
                        <div class="glass-panel p-4 rounded-xl flex items-center space-x-6 mb-2">
                            <div class="text-xl font-bold w-8 text-gray-500">#${i+1}</div>
                            <div class="text-2xl font-mono w-48 truncate">${pl.name}</div>
                            <div class="flex-1 h-6 bg-gray-800 rounded-full overflow-hidden relative">
                                <div class="h-full ${barColor}" style="width:${Math.max(5, w)}%"></div>
                            </div>
                            <div class="font-bold text-xl">${score}s</div>
                        </div>
                    `;
                });
            }
        };

        // --- PLAYER ---
        const player = {
            sessionId: null, isAlive: true, lastMove: 0, lastShot: 0,
            
            init(sid) {
                if(sid) this.sessionId = sid;
                $('view-player-ui').classList.remove('hidden');
                if(!sid) $('player-login').classList.remove('hidden');
            },

            join() {
                const name = $('inp-player-name').value.trim().toUpperCase();
                const code = $('inp-session-code').value.trim().toUpperCase();
                if(!name || !code) return alert("Faltan datos");
                
                AudioSys.unlock(); 
                SystemOps.activateAll(); // Activar sistemas en el jugador
                
                this.sessionId = code;
                db.ref(`artifacts/${APP_ID}/${this.sessionId}/players/${localUid}`).set({
                    name, sessionId: code, isAlive: true, joinedAt: Date.now()
                }).then(() => {
                    $('player-login').classList.add('hidden');
                    $('player-sensor').classList.remove('hidden');
                });
            },

            requestPermissions() {
                AudioSys.unlock();
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission().then(r => {
                        if (r==='granted') this.enter(); else alert("Permiso denegado");
                    });
                } else this.enter();
            },

            enter() {
                $('player-sensor').classList.add('hidden');
                $('player-game').classList.remove('hidden');
                
                db.ref(`artifacts/${APP_ID}/${this.sessionId}`).on('value', s => {
                    try {
                        const d = s.val();
                        if(!d || !d.state) return; 
                        
                        const me = d.players?.[localUid];
                        const state = d.state;
                        
                        if(state.lastShot && state.lastShot !== this.lastShot && Date.now() - state.lastShot < 3000) {
                            this.lastShot = state.lastShot;
                            triggerFlash();
                            AudioSys.playGun();
                            if(navigator.vibrate) navigator.vibrate(500);
                        }

                        if(me) {
                            if(this.isAlive && !me.isAlive) {
                                this.isAlive = false;
                                if(navigator.vibrate) navigator.vibrate([200,100,500]);
                            } else if(!this.isAlive && me.isAlive) {
                                this.isAlive = true; 
                            }
                        }

                        this.render(state, me);
                        if(state.state === 'measuring') this.measure();
                    } catch(e) { console.error("Player Error:", e); }
                });

                this.monitor();
            },

            monitor() {
                this.lastMove = Date.now();
                window.addEventListener('devicemotion', e => {
                    let acc = e.acceleration ? Math.sqrt(e.acceleration.x**2 + e.acceleration.y**2 + e.acceleration.z**2) : 0;
                    if(acc > 1.5) this.lastMove = Date.now();
                });
                setInterval(() => {
                    const w = $('p-move-warning');
                    if(!w || !this.sessionData) return;
                    if(this.sessionData.state === 'playing' && this.sessionData.musicPlaying && this.isAlive) {
                        if(Date.now() - this.lastMove > 2000) {
                            w.classList.remove('hidden');
                            if(navigator.vibrate) navigator.vibrate(200);
                        } else w.classList.add('hidden');
                    } else w.classList.add('hidden');
                }, 500);
            },

            measure() {
                // CORRECCION: Usamos acumulación en vez de timestamp
                let accumulatedTime = 0;
                let lastEventTime = Date.now();

                // Reset UI
                const b = $('p-measure-bar');
                if(b) {
                    b.style.transition = 'none'; b.style.transform = 'scaleX(1)';
                    void b.offsetWidth; b.style.transition = 'transform 2s linear'; b.style.transform = 'scaleX(0)';
                }

                const bg = $('p-bg-color');
                const h = (e) => {
                    const now = Date.now();
                    const dt = now - lastEventTime; // Tiempo desde la última lectura (ms)
                    lastEventTime = now;

                    let acc = 0;
                    if(e.acceleration && e.acceleration.x !== null) {
                        acc = Math.sqrt(e.acceleration.x**2 + e.acceleration.y**2 + e.acceleration.z**2);
                    } else if(e.accelerationIncludingGravity) {
                        const g = e.accelerationIncludingGravity;
                        acc = Math.abs(Math.sqrt(g.x**2 + g.y**2 + g.z**2) - 9.8);
                    }
                    
                    // CORRECCION: Umbral subido a 1.5 para evitar ruido de sensores (era 0.5)
                    // Si se supera el umbral, sumamos el tiempo delta al acumulado
                    if(acc > 1.5) { 
                        // Capamos dt a 100ms para evitar saltos locos si el navegador se congela
                        accumulatedTime += Math.min(dt, 100);

                        if(bg) { 
                            bg.classList.add('bg-detected');
                            setTimeout(() => bg.classList.remove('bg-detected'), 150);
                        }
                    }
                };
                
                window.addEventListener('devicemotion', h);
                
                // Paramos de medir a los 2s (aunque el servidor espera 4s por lag, la fase activa de medición es corta)
                setTimeout(() => {
                    window.removeEventListener('devicemotion', h);
                    if(this.isAlive) {
                        // Enviamos el tiempo total acumulado de movimiento en segundos
                        db.ref(`artifacts/${APP_ID}/${this.sessionId}/players/${localUid}`).update({ lastScore: accumulatedTime/1000 });
                    }
                }, 2500);
            },

            die() {
                AudioSys.playGun();
                if(navigator.vibrate) navigator.vibrate([200, 100, 500]);
            },

            render(state, me) {
                if(!state) return; 
                this.sessionData = state; 
                const c = $('player-game'); 
                ['p-state-waiting','p-state-active','p-state-dead','p-state-win'].forEach(id=>$(id)?.classList.add('hidden')); 
                
                if(state.state === 'ended') {
                    if(state.winner !== 'NADIE') { 
                        $('p-state-win')?.classList.remove('hidden'); 
                        AudioSys.playWin(); 
                    }
                    else $('p-state-dead')?.classList.remove('hidden');
                    return;
                }

                if(!this.isAlive) { $('p-state-dead')?.classList.remove('hidden'); return; }
                if(state.state === 'waiting') { $('p-state-waiting')?.classList.remove('hidden'); return; }

                $('p-state-active')?.classList.remove('hidden');
                const t = $('p-main-text'), sub = $('p-sub-text'), ic = $('p-icon'), bar = $('p-measure-bar-container'), bg = $('p-bg-color');
                
                if(state.musicPlaying) {
                    if(bg) bg.className = "absolute inset-0 transition-colors duration-300 bg-[#249f9c]";
                    if(ic) ic.innerHTML = '<i data-lucide="footprints" class="w-32 h-32 text-white animate-bounce"></i>';
                    if(t) t.innerText = "CORRE"; 
                    if(sub) sub.innerText = "MANTENTE EN MOVIMIENTO";
                    if(bar) bar.classList.add('hidden');
                } else if(state.state === 'measuring') {
                    if(bg) bg.className = "absolute inset-0 transition-colors duration-300 bg-[#ed1b76]";
                    if(ic) ic.innerHTML = '<i data-lucide="eye" class="w-32 h-32 text-white animate-pulse"></i>';
                    if(t) t.innerText = "QUIETO"; 
                    if(sub) sub.innerText = "NO TE MUEVAS";
                    if(bar) bar.classList.remove('hidden');
                    if(navigator.vibrate) navigator.vibrate(50);
                } else {
                    if(bg) bg.className = "absolute inset-0 transition-colors duration-300 bg-black";
                    if(ic) ic.innerHTML = '<i data-lucide="bar-chart-2" class="w-32 h-32 text-gray-500"></i>';
                    if(t) t.innerText = "RESULTADOS"; 
                    if(sub) sub.innerText = "MIRA LA PANTALLA";
                    if(bar) bar.classList.add('hidden');
                }
                lucide.createIcons();
            }
        };

        app.init();
    </script>
</body>
</html>
