<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juego del Semáforo Musical</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-database-compat.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1a1a1a;
            color: white;
            overflow: hidden;
            touch-action: none;
        }
        
        .pixel-font {
            font-family: 'Press Start 2P', cursive;
        }

        .hidden { display: none !important; }

        /* Estados del semáforo */
        .bg-safe { background-color: #16a34a; }
        .bg-danger { background-color: #dc2626; }
        .bg-measuring { background-color: #eab308; } /* Amarillo para medir */
        
        .pulse-green { animation: pulse-g 1s infinite; }
        .pulse-red { animation: pulse-r 0.5s infinite; }

        @keyframes pulse-g { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes pulse-r { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }

        /* Animación barra de tiempo */
        .score-bar { transition: width 1s ease-out; }
    </style>
</head>
<body>

    <!-- VISTA: SELECCIÓN DE ROL -->
    <div id="view-landing" class="h-screen w-full flex flex-col items-center justify-center p-4 space-y-8">
        <h1 class="text-4xl md:text-6xl font-bold text-center pixel-font text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-red-500 mb-8 leading-tight">
            LUZ ROJA<br>MUSICAL
        </h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
            <button onclick="app.setRole('screen')" class="flex flex-col items-center justify-center p-8 bg-neutral-800 border-2 border-pink-500 rounded-xl hover:bg-neutral-700 transition-all hover:scale-105">
                <i data-lucide="monitor" class="w-16 h-16 text-pink-500 mb-4"></i>
                <span class="text-2xl font-bold">PANTALLA</span>
                <span class="text-sm text-gray-400 mt-2">Para TV / PC</span>
            </button>
            <button onclick="app.setRole('player')" class="flex flex-col items-center justify-center p-8 bg-neutral-800 border-2 border-green-500 rounded-xl hover:bg-neutral-700 transition-all hover:scale-105">
                <i data-lucide="smartphone" class="w-16 h-16 text-green-500 mb-4"></i>
                <span class="text-2xl font-bold">JUGADOR</span>
                <span class="text-sm text-gray-400 mt-2">Para Móvil</span>
            </button>
        </div>
    </div>

    <!-- VISTA: PANTALLA (HOST) -->
    <div id="view-screen" class="hidden h-screen w-full flex flex-col relative bg-neutral-900">
        <!-- Header -->
        <div class="absolute top-0 w-full p-4 flex justify-between items-center z-10 bg-neutral-900/90 backdrop-blur border-b border-white/10">
            <div class="text-2xl font-bold text-pink-500 pixel-font">SALA: <span id="host-session-code" class="text-white">...</span></div>
            <div class="flex space-x-6 text-xl font-bold">
                <div class="flex items-center text-green-400"><i data-lucide="activity" class="mr-2"></i> <span id="host-alive-count">0</span></div>
                <div class="flex items-center text-red-500"><i data-lucide="skull" class="mr-2"></i> <span id="host-dead-count">0</span></div>
            </div>
        </div>

        <!-- Contenido Central Host -->
        <div class="flex-1 flex flex-col items-center justify-center p-4 relative w-full">
            
            <!-- Estado: LOBBY -->
            <div id="host-lobby" class="text-center flex flex-col items-center w-full">
                <div class="bg-white p-4 rounded-xl shadow-2xl mb-6">
                    <img id="host-qr-img" src="" alt="QR Code" class="w-64 h-64 object-contain">
                </div>
                <h2 class="text-3xl font-bold mb-2">Escanea para unirte</h2>
                <p class="text-gray-400 mb-8 text-xl">Jugadores listos: <span id="host-lobby-count">0</span></p>
                <button id="btn-start-game" onclick="host.startGame()" disabled class="px-10 py-5 bg-gradient-to-r from-pink-600 to-red-600 rounded-full text-2xl font-bold hover:scale-105 disabled:opacity-50 disabled:grayscale transition-all shadow-lg shadow-pink-900/50">
                    EMPEZAR JUEGO
                </button>
            </div>

            <!-- Estado: JUEGO (Semáforo) -->
            <div id="host-game" class="hidden w-full h-full flex items-center justify-center flex-col">
                <div id="traffic-light" class="w-80 h-80 rounded-full flex items-center justify-center border-8 transition-all duration-200 bg-neutral-800 border-neutral-600">
                    <!-- Icono dinámico se inyecta aquí -->
                </div>
                <h2 id="host-status-text" class="text-5xl font-black mt-8 tracking-wider">PREPARADOS</h2>
            </div>

            <!-- Estado: RESULTADOS RONDA (Leaderboard) -->
            <div id="host-round-results" class="hidden w-full h-full flex flex-col items-center justify-start pt-20">
                <h2 class="text-4xl font-bold mb-8 text-yellow-400 pixel-font">TIEMPOS DE REACCIÓN</h2>
                <div id="results-grid" class="w-full max-w-4xl grid grid-cols-1 gap-4 overflow-y-auto max-h-[60vh] px-4">
                    <!-- Barras de resultados -->
                </div>
                <div id="eliminated-msg" class="mt-8 text-3xl font-black text-red-500 animate-pulse hidden">
                    ELIMINADO: <span id="eliminated-name">...</span>
                </div>
            </div>

            <!-- Estado: GANADOR -->
            <div id="host-winner" class="hidden text-center animate-bounce">
                <i data-lucide="trophy" class="w-40 h-40 text-yellow-400 mx-auto mb-4"></i>
                <h2 class="text-4xl text-yellow-400 font-bold mb-2">GANADOR</h2>
                <div id="winner-name" class="text-6xl font-black text-white mb-8">NOMBRE</div>
                <p class="text-gray-400 mt-4">Reiniciando juego en breve...</p>
            </div>
        </div>

        <!-- Footer Jugadores -->
        <div class="h-auto max-h-48 min-h-[5rem] bg-neutral-800 border-t border-neutral-700 p-4 overflow-y-auto">
            <div id="host-players-list" class="flex flex-wrap gap-3 justify-center">
                <!-- Chips de jugadores -->
            </div>
        </div>
    </div>

    <!-- VISTA: JUGADOR (LOGIN) -->
    <div id="view-player-join" class="hidden h-screen w-full flex flex-col items-center justify-center p-6 space-y-6 bg-black">
        <div class="text-center mb-4">
            <h1 class="text-3xl font-bold text-pink-500 pixel-font mb-2">UNIRSE</h1>
            <p class="text-gray-400">Introduce tus datos</p>
        </div>
        <input type="text" id="inp-player-name" placeholder="TU NOMBRE" maxlength="10" class="w-full max-w-xs bg-neutral-800 border-2 border-neutral-600 p-4 rounded text-center text-xl text-white uppercase focus:border-pink-500 outline-none">
        <input type="text" id="inp-session-code" placeholder="CÓDIGO SALA" maxlength="4" class="w-full max-w-xs bg-neutral-800 border-2 border-neutral-600 p-4 rounded text-center text-xl text-white uppercase focus:border-pink-500 outline-none">
        <button onclick="player.join()" class="w-full max-w-xs bg-green-600 hover:bg-green-500 p-4 rounded font-bold text-xl shadow-lg shadow-green-900/50 transition-transform active:scale-95">
            ENTRAR
        </button>
    </div>

    <!-- VISTA: JUGADOR (PERMISO SENSORES) -->
    <div id="view-player-sensor" class="hidden h-screen w-full flex flex-col items-center justify-center p-6 text-center bg-black">
        <i data-lucide="smartphone" class="w-20 h-20 text-yellow-500 mb-6 animate-pulse"></i>
        <h2 class="text-2xl font-bold mb-4">Activa los Sensores</h2>
        <p class="text-gray-400 mb-8 max-w-xs mx-auto">El juego necesita acceso al acelerómetro para saber si te mueves.</p>
        <button onclick="player.requestPermissions()" class="bg-yellow-500 text-black px-8 py-4 rounded-full font-bold text-xl shadow-lg shadow-yellow-500/20">
            ACTIVAR Y JUGAR
        </button>
    </div>

    <!-- VISTA: JUGADOR (JUEGO) -->
    <div id="view-player-game" class="hidden h-screen w-full flex flex-col items-center justify-center transition-colors duration-200 bg-neutral-900 relative">
        
        <!-- Pantalla: ESPERANDO (Lobby) -->
        <div id="p-screen-waiting" class="text-center">
            <div class="animate-spin mb-6 mx-auto"><i data-lucide="loader" class="w-16 h-16 text-blue-500"></i></div>
            <h2 class="text-3xl font-bold mb-2">Esperando al Host...</h2>
            <p class="text-blue-300">Mantente preparado</p>
        </div>

        <!-- Pantalla: ACTIVO (Corre/Quieto/Midiendo) -->
        <div id="p-screen-active" class="hidden text-center w-full h-full flex flex-col items-center justify-center">
            <div id="p-icon-container" class="mb-6 transform transition-transform duration-200">
                <!-- Icono -->
            </div>
            <h1 id="p-status-text" class="text-6xl font-black text-white drop-shadow-lg">...</h1>
            <p id="p-sub-text" class="text-xl mt-4 font-bold opacity-80">...</p>
        </div>

        <!-- Pantalla: MUERTO -->
        <div id="p-screen-dead" class="hidden text-center animate-pulse bg-red-950 absolute inset-0 flex flex-col items-center justify-center z-50">
            <i data-lucide="skull" class="w-32 h-32 text-red-500 mb-4"></i>
            <h1 class="text-5xl font-black text-red-500 mb-2">ELIMINADO</h1>
            <p class="text-red-300">Fuiste el más lento</p>
        </div>

        <!-- Pantalla: VICTORIA -->
        <div id="p-screen-win" class="hidden text-center bg-yellow-900 absolute inset-0 flex flex-col items-center justify-center z-50">
            <i data-lucide="trophy" class="w-32 h-32 text-yellow-400 mb-4 animate-bounce"></i>
            <h1 class="text-5xl font-black text-yellow-400 mb-2">¡VICTORIA!</h1>
            <p class="text-yellow-100">Has sobrevivido</p>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBMYTnk-CljdWENtDQqqKUBmQzBQuoxYPo",
            authDomain: "hello-74404.firebaseapp.com",
            databaseURL: "https://hello-74404-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "hello-74404",
            storageBucket: "hello-74404.firebasestorage.app",
            messagingSenderId: "781363507648",
            appId: "1:781363507648:web:5c7b871f11b9010bfd1825"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- UTILIDADES ---
        const $ = (id) => document.getElementById(id);
        const APP_ID = "music-game-v1";
        
        // Sonidos
        const SONGS = ['song1.mp3', 'song2.mp3', 'song3.mp3', 'song4.mp3']; 
        const GUNSHOT_URL = "https://library.penguinmod.com/files/sounds/gunshot3.mp3";
        
        let localUid = localStorage.getItem('mg_uid') || 'u_' + Date.now().toString(36);
        localStorage.setItem('mg_uid', localUid);

        // Audio
        let currentMusic = null;
        const gunshotAudio = new Audio(GUNSHOT_URL);

        // --- LÓGICA DE APLICACIÓN CENTRAL ---
        const app = {
            role: null,
            sessionId: null,

            init: function() {
                const params = new URLSearchParams(window.location.search);
                const urlSession = params.get('session');
                const urlRole = params.get('role');

                if (urlSession && urlRole) {
                    this.sessionId = urlSession.toUpperCase();
                    this.setRole(urlRole);
                    if (urlRole === 'player') {
                        $('inp-session-code').value = this.sessionId;
                    }
                } else {
                    this.showView('view-landing');
                }
                lucide.createIcons();
            },

            setRole: function(role) {
                this.role = role;
                if (role === 'screen') {
                    host.init();
                } else {
                    player.init();
                }
            },

            showView: function(viewId) {
                document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
                $(viewId).classList.remove('hidden');
            }
        };

        // --- LÓGICA DEL HOST (PANTALLA) ---
        const host = {
            players: {},
            gameState: 'waiting', // waiting, playing, measuring, round_result, ended
            musicPlaying: false,

            init: function() {
                if (!app.sessionId) {
                    app.sessionId = Math.random().toString(36).substring(2, 6).toUpperCase();
                    const newUrl = `?session=${app.sessionId}&role=screen`;
                    window.history.replaceState(null, '', newUrl);
                }
                
                $('host-session-code').innerText = app.sessionId;
                app.showView('view-screen');

                const joinUrl = `${window.location.origin}${window.location.pathname}?session=${app.sessionId}&role=player`;
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(joinUrl)}&bgcolor=ffffff&color=000000&margin=10`;
                $('host-qr-img').src = qrUrl;

                this.setupListeners();
                this.resetDB();
            },

            resetDB: function() {
                db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}`).update({
                    state: 'waiting',
                    musicPlaying: false,
                    host: localUid,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            },

            setupListeners: function() {
                db.ref(`artifacts/${APP_ID}/public/data/players`).on('value', snap => {
                    const allPlayers = snap.val() || {};
                    this.players = {};
                    Object.entries(allPlayers).forEach(([key, p]) => {
                        if (p.sessionId === app.sessionId) {
                            this.players[key] = p;
                        }
                    });
                    this.renderPlayers();
                });

                db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}`).on('value', snap => {
                    const data = snap.val();
                    if(data) {
                        this.gameState = data.state;
                        this.musicPlaying = data.musicPlaying;
                        this.updateUI();
                    }
                });
            },

            renderPlayers: function() {
                const list = $('host-players-list');
                list.innerHTML = '';
                
                const playersArr = Object.values(this.players);
                $('host-lobby-count').innerText = playersArr.length;
                
                const alive = playersArr.filter(p => p.isAlive).length;
                const dead = playersArr.filter(p => !p.isAlive).length;
                
                $('host-alive-count').innerText = alive;
                $('host-dead-count').innerText = dead;

                $('btn-start-game').disabled = playersArr.length === 0;

                playersArr.forEach(p => {
                    const div = document.createElement('div');
                    div.className = `px-3 py-1 rounded-full text-sm font-bold flex items-center border ${p.isAlive ? 'bg-green-900 text-green-300 border-green-600' : 'bg-red-900/50 text-red-500 border-red-800 line-through opacity-60'}`;
                    div.innerText = p.name;
                    list.appendChild(div);
                });
                
                // NOTA: No chequeamos win condition aquí para evitar terminaciones prematuras por latencia
            },

            startGame: function() {
                const updates = {};
                Object.keys(this.players).forEach(pid => {
                    updates[`artifacts/${APP_ID}/public/data/players/${pid}/isAlive`] = true;
                    updates[`artifacts/${APP_ID}/public/data/players/${pid}/lastScore`] = 0; // Reset score
                });
                updates[`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}/state`] = 'playing';
                updates[`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}/musicPlaying`] = true;
                
                db.ref().update(updates);
                
                this.startMusic();
                this.scheduleStop();
            },

            scheduleStop: function() {
                if (this.gameState !== 'playing') return;

                const aliveCount = Object.values(this.players).filter(p => p.isAlive).length;
                let min = 5000, max = 12000;
                
                if (aliveCount <= 2) { min = 10000; max = 20000; }

                const duration = Math.random() * (max - min) + min;

                setTimeout(() => {
                    if (this.gameState !== 'playing' || !this.musicPlaying) return;
                    this.stopRound();
                }, duration);
            },

            stopRound: function() {
                this.stopMusic();
                const updates = {
                    musicPlaying: false,
                    state: 'measuring', 
                    lastStop: firebase.database.ServerValue.TIMESTAMP
                };
                db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}`).update(updates);

                setTimeout(() => this.calculateRoundResults(), 3000);
            },

            calculateRoundResults: function() {
                if (this.gameState !== 'measuring') return;

                db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}`).update({
                    state: 'round_result'
                });
                
                const alivePlayers = Object.entries(this.players).filter(([k, p]) => p.isAlive);
                
                // Si ya no queda nadie o solo 1 antes de calcular, acabamos
                if (alivePlayers.length <= 1 && Object.keys(this.players).length > 1) {
                     const winner = alivePlayers.length === 1 ? alivePlayers[0][1].name : 'NADIE';
                     this.endGame(winner);
                     return;
                }

                let worstPlayerId = null;
                let maxScore = -1;

                alivePlayers.forEach(([pid, p]) => {
                    const score = p.lastScore || 10;
                    if (score > maxScore) {
                        maxScore = score;
                        worstPlayerId = pid;
                    }
                });

                // Mostrar resultados, eliminar al peor y decidir
                setTimeout(() => {
                    // Eliminar al peor si hay más de 1 jugador
                    if (worstPlayerId && maxScore > 10 && alivePlayers.length > 1) { 
                        db.ref(`artifacts/${APP_ID}/public/data/players/${worstPlayerId}`).update({ isAlive: false });
                        gunshotAudio.play().catch(()=>{});
                    }

                    setTimeout(() => {
                        // Calcular supervivientes REALES (excluyendo al que acabamos de matar)
                        let currentAliveCount = 0;
                        let lastSurvivorName = "";
                        
                        Object.entries(this.players).forEach(([pid, p]) => {
                            // Si es el que acabamos de matar, lo ignoramos aunque el objeto local aun diga true
                            if (pid === worstPlayerId) return;
                            if (p.isAlive) {
                                currentAliveCount++;
                                lastSurvivorName = p.name;
                            }
                        });

                        if (currentAliveCount <= 1) {
                            // FIN DEL JUEGO
                            const wName = currentAliveCount === 1 ? lastSurvivorName : 'NADIE';
                            this.endGame(wName);
                        } else {
                            // SIGUIENTE RONDA
                            const updates = {
                                state: 'playing',
                                musicPlaying: true
                            };
                            db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}`).update(updates);
                            this.startMusic();
                            this.scheduleStop();
                        }
                    }, 3000); 
                }, 3000); 
            },

            startMusic: function() {
                const aliveCount = Object.values(this.players).filter(p => p.isAlive).length;
                let songToPlay;
                
                if (aliveCount <= 2) {
                    songToPlay = 'song3.mp3';
                } else {
                    songToPlay = SONGS[Math.floor(Math.random() * SONGS.length)];
                }
                
                if (currentMusic) {
                    currentMusic.pause();
                    currentMusic = null;
                }
                currentMusic = new Audio(songToPlay);
                currentMusic.loop = true;
                currentMusic.play().catch(e => console.log("Audio error", e));
            },

            stopMusic: function() {
                if (currentMusic) {
                    currentMusic.pause();
                    currentMusic.currentTime = 0;
                }
            },

            endGame: function(winnerName) {
                db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}`).update({
                    state: 'ended',
                    musicPlaying: false,
                    winner: winnerName
                });
                this.stopMusic();

                // REINICIO AUTOMÁTICO EN 8 SEGUNDOS
                setTimeout(() => {
                    this.resetGame();
                }, 8000);
            },

            resetGame: function() {
                const updates = {};
                updates[`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}/state`] = 'waiting';
                updates[`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}/musicPlaying`] = false;
                
                // Revivir a TODOS
                Object.keys(this.players).forEach(pid => {
                     updates[`artifacts/${APP_ID}/public/data/players/${pid}/isAlive`] = true;
                     updates[`artifacts/${APP_ID}/public/data/players/${pid}/lastScore`] = 0;
                });
                db.ref().update(updates);
            },

            updateUI: function() {
                $('host-lobby').classList.add('hidden');
                $('host-game').classList.add('hidden');
                $('host-round-results').classList.add('hidden');
                $('host-winner').classList.add('hidden');

                if (this.gameState === 'waiting') {
                    $('host-lobby').classList.remove('hidden');
                } else if (this.gameState === 'playing' || this.gameState === 'measuring') {
                    $('host-game').classList.remove('hidden');
                    const light = $('traffic-light');
                    const text = $('host-status-text');

                    if (this.musicPlaying) {
                        light.className = "w-80 h-80 rounded-full flex items-center justify-center border-8 transition-all duration-200 bg-green-600 border-green-400 pulse-green shadow-[0_0_50px_rgba(34,197,94,0.6)]";
                        light.innerHTML = `<i data-lucide="play" class="w-40 h-40 text-white"></i>`;
                        text.innerText = "¡CORRE!";
                        text.className = "text-5xl font-black mt-8 tracking-wider text-green-500";
                    } else {
                        light.className = "w-80 h-80 rounded-full flex items-center justify-center border-8 transition-all duration-200 bg-yellow-500 border-yellow-300 shadow-[0_0_50px_rgba(234,179,8,0.6)]";
                        light.innerHTML = `<i data-lucide="activity" class="w-40 h-40 text-white animate-pulse"></i>`;
                        text.innerText = "MIDIENDO...";
                        text.className = "text-5xl font-black mt-8 tracking-wider text-yellow-500";
                    }
                } else if (this.gameState === 'round_result') {
                    $('host-round-results').classList.remove('hidden');
                    this.renderResultsBoard();
                } else if (this.gameState === 'ended') {
                    $('host-winner').classList.remove('hidden');
                    db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}/winner`).once('value', s => {
                        $('winner-name').innerText = s.val() || '...';
                    });
                }
                lucide.createIcons();
            },

            renderResultsBoard: function() {
                const grid = $('results-grid');
                grid.innerHTML = '';
                $('eliminated-msg').classList.add('hidden');

                const players = Object.values(this.players).filter(p => p.isAlive || (p.lastScore > 0)); 
                players.sort((a, b) => b.lastScore - a.lastScore);

                players.forEach((p, index) => {
                    const score = p.lastScore ? p.lastScore.toFixed(2) : "10.00";
                    const isWorst = index === 0; 
                    
                    const barColor = score > 15 ? 'bg-red-600' : 'bg-green-600';
                    const widthPercent = Math.min(100, (score / 20) * 100);

                    const item = document.createElement('div');
                    item.className = "flex items-center space-x-4 bg-neutral-800 p-2 rounded-lg";
                    // AÑADIDA "s" AL SCORE PARA INDICAR SEGUNDOS
                    item.innerHTML = `
                        <div class="w-32 font-bold truncate text-right">${p.name}</div>
                        <div class="flex-1 bg-neutral-700 h-8 rounded-full overflow-hidden relative">
                            <div class="h-full ${barColor} score-bar flex items-center justify-end px-2 font-mono font-bold" style="width: ${widthPercent}%">
                                ${score}s
                            </div>
                        </div>
                    `;
                    grid.appendChild(item);

                    if (isWorst) {
                        setTimeout(() => {
                            $('eliminated-msg').classList.remove('hidden');
                            $('eliminated-name').innerText = p.name;
                        }, 3000);
                    }
                });
            }
        };

        // --- LÓGICA DEL JUGADOR ---
        const player = {
            isAlive: true,
            init: function() {
                $('inp-session-code').value = app.sessionId || '';
                app.showView('view-player-join');
            },

            join: function() {
                const name = $('inp-player-name').value.trim().toUpperCase();
                const code = $('inp-session-code').value.trim().toUpperCase();

                if (!name || !code) return alert("Rellena todos los campos");

                app.sessionId = code;
                
                db.ref(`artifacts/${APP_ID}/public/data/players/${localUid}`).set({
                    name: name,
                    sessionId: code,
                    isAlive: true,
                    lastScore: 0,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    app.showView('view-player-sensor');
                }).catch(e => {
                    alert("Error conexión: " + e.message);
                });
            },

            requestPermissions: function() {
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') this.enterGame();
                            else alert("Permiso denegado.");
                        }).catch(console.error);
                } else {
                    this.enterGame();
                }
            },

            enterGame: function() {
                app.showView('view-player-game');
                this.setupListeners();
            },

            setupListeners: function() {
                db.ref(`artifacts/${APP_ID}/public/data/players/${localUid}`).on('value', s => {
                    const p = s.val();
                    if (p) {
                        if (this.isAlive && !p.isAlive) {
                            this.dieLocal();
                        }
                        this.isAlive = p.isAlive;
                        this.updateScreen();
                    }
                });

                db.ref(`artifacts/${APP_ID}/public/data/sessions/${app.sessionId}`).on('value', s => {
                    const sess = s.val();
                    if (sess) {
                        this.sessionData = sess;
                        if (sess.state === 'waiting' && !this.isAlive) {
                             // Si el juego está en waiting, asegurarnos de que localmente estamos listos
                             // La DB ya nos revive en host.resetGame(), pero aquí actualizamos UI
                        }
                        this.updateScreen();
                        
                        if (sess.state === 'measuring') {
                            this.measureReaction();
                        }
                    }
                });
            },

            measureReaction: function() {
                let maxAccel = 0;
                let samples = 0;

                const handler = (event) => {
                    let acc = 0;
                    if (event.acceleration) {
                        acc = Math.sqrt(event.acceleration.x**2 + event.acceleration.y**2 + event.acceleration.z**2);
                    } else if (event.accelerationIncludingGravity) {
                        const g = event.accelerationIncludingGravity;
                        acc = Math.abs(Math.sqrt(g.x**2 + g.y**2 + g.z**2) - 9.8);
                    }
                    if (acc > maxAccel) maxAccel = acc;
                    samples++;
                };

                window.addEventListener('devicemotion', handler);

                setTimeout(() => {
                    window.removeEventListener('devicemotion', handler);
                    
                    let baseScore = 10 + Math.random() * 2; 
                    let movementPenalty = maxAccel * 2; 
                    
                    let finalScore = baseScore + movementPenalty;
                    if (finalScore > 20) finalScore = 20;
                    if (finalScore < 10) finalScore = 10;
                    
                    if (this.isAlive) {
                        db.ref(`artifacts/${APP_ID}/public/data/players/${localUid}`).update({
                            lastScore: finalScore
                        });
                    }
                }, 1500);
            },

            dieLocal: function() {
                gunshotAudio.play().catch(e => console.log(e));
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            },

            updateScreen: function() {
                const sess = this.sessionData;
                const container = $('view-player-game');
                
                $('p-screen-waiting').classList.add('hidden');
                $('p-screen-active').classList.add('hidden');
                $('p-screen-dead').classList.add('hidden');
                $('p-screen-win').classList.add('hidden');
                container.className = "h-screen w-full flex flex-col items-center justify-center transition-colors duration-200 bg-neutral-900 relative";

                if (!sess) return;

                // Orden de prioridad de pantallas

                // 1. Ganador (Muestra victoria o derrota global)
                if (sess.state === 'ended') {
                    if (sess.winner !== 'NADIE') {
                         // Si yo soy el ganador (o estoy vivo y hay ganador)
                         // Aunque en teoría 'ended' solo se activa con 1 vivo.
                         // El host revive a todos despues, asi que esto es temporal.
                         $('p-screen-win').classList.remove('hidden');
                    }
                    else $('p-screen-dead').classList.remove('hidden');
                    return;
                }

                // 2. Waiting (Reseteo)
                if (sess.state === 'waiting') {
                    $('p-screen-waiting').classList.remove('hidden');
                    return;
                }

                // 3. Muerto durante la partida
                if (!this.isAlive) {
                    $('p-screen-dead').classList.remove('hidden');
                    return;
                }

                // 4. Juego Activo
                if (sess.state === 'playing' || sess.state === 'measuring' || sess.state === 'round_result') {
                    $('p-screen-active').classList.remove('hidden');
                    const icon = $('p-icon-container');
                    const mainText = $('p-status-text');
                    const subText = $('p-sub-text');

                    if (sess.musicPlaying) {
                        container.className = "h-screen w-full flex flex-col items-center justify-center transition-colors duration-200 bg-safe relative";
                        icon.innerHTML = `<i data-lucide="play" class="w-32 h-32 text-white"></i>`;
                        mainText.innerText = "CORRE";
                        subText.innerText = "La música suena";
                    } else if (sess.state === 'measuring') {
                         container.className = "h-screen w-full flex flex-col items-center justify-center transition-colors duration-100 bg-measuring relative";
                        icon.innerHTML = `<i data-lucide="activity" class="w-32 h-32 text-white animate-pulse"></i>`;
                        mainText.innerText = "MIDIENDO";
                        subText.innerText = "¡No te muevas!";
                        if (navigator.vibrate) navigator.vibrate(50);
                    } else {
                        // Round result
                        container.className = "h-screen w-full flex flex-col items-center justify-center transition-colors duration-100 bg-neutral-800 relative";
                        icon.innerHTML = `<i data-lucide="monitor" class="w-32 h-32 text-white"></i>`;
                        mainText.innerText = "RESULTADOS";
                        subText.innerText = "Mira la pantalla";
                    }
                    lucide.createIcons();
                }
            }
        };

        app.init();

    </script>
</body>
</html>
